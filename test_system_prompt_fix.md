# System Prompt 修正驗證

## 修正內容總結

### 問題
當用戶問「列出案件並顯示金額」時，GPT 可能：
1. 從對話歷史中提取之前的查詢結果（可能沒有金額欄位）
2. 或者調用工具時使用 `intended_analysis="list"` 而不是 `"amount_analysis"`
3. 導致返回的資料缺少金額欄位

### 修正 1: 更新重要規則

**修正前**：
```
**重要規則**:
- 如果不確定使用哪個 intended_analysis,預設使用 "summary"
- 如果問題涉及多個分析類型,優先選擇最輕量的類型  ❌ 會導致選擇 "list" 而不是 "amount_analysis"
```

**修正後**：
```
**重要規則**:
- 如果不確定使用哪個 intended_analysis,預設使用 "summary"
- 如果問題涉及多個分析類型,優先選擇**包含所需資料**的類型
  - 例如: "列出案件並顯示金額" → 使用 "amount_analysis" (不是 "list")
  - 例如: "列出案件並顯示法條" → 使用 "citation_analysis" (不是 "list")
  - 例如: "列出案件並顯示摘要" → 使用 "summary" (不是 "list")
- **[關鍵]** 如果用戶問題需要特定欄位（如金額、法條、當事人），但對話歷史中的資料缺少這些欄位，**必須重新調用工具**並指定正確的 intended_analysis
  - 例如: 對話歷史中有案件列表但沒有金額 → 用戶問金額 → 必須重新調用 semantic_search_judgments 並指定 intended_analysis="amount_analysis"
```

### 修正 2: 更新金額分析描述

**修正前**：
```
- **金額分析** (需要金額數據): intended_analysis="amount_analysis"
  - 範例: "金額最大的案件是哪一個?"、"平均判賠金額是多少?"
```

**修正後**：
```
- **金額分析** (需要金額數據): intended_analysis="amount_analysis"
  - 範例: "金額最大的案件是哪一個?"、"平均判賠金額是多少?"、"列出案件並顯示金額"
  - [重要] 只要問題中提到「請求金額」、「獲准金額」、「判賠金額」等關鍵字，就必須使用 amount_analysis
```

### 修正 3: 添加工作流程檢查步驟

**修正前**：
```
**工作流程**:
1. 理解用戶問題
2. [重要] **檢查上下文** - 如果用戶問題中包含「當前查詢的法官」資訊,務必使用該法官名稱
3. [重要] **智能欄位選擇** - 根據問題類型選擇 intended_analysis 參數,節省 Token
4. 決定需要調用哪些工具 (可以組合多個工具)
5. 先調用 MCP 工具獲取數據
6. 再調用本地函數處理數據
7. 生成自然語言回答
```

**修正後**：
```
**工作流程**:
1. 理解用戶問題
2. [重要] **檢查上下文** - 如果用戶問題中包含「當前查詢的法官」資訊,務必使用該法官名稱
3. [重要] **檢查對話歷史** - 如果用戶問題需要特定欄位（如金額、法條），檢查對話歷史中的資料是否包含這些欄位
   - 如果對話歷史中的資料**缺少**所需欄位 → **必須重新調用工具**並指定正確的 intended_analysis
   - 如果對話歷史中的資料**已包含**所需欄位 → 可以直接使用
4. [重要] **智能欄位選擇** - 根據問題類型選擇 intended_analysis 參數,節省 Token
5. 決定需要調用哪些工具 (可以組合多個工具)
6. 先調用 MCP 工具獲取數據
7. 再調用本地函數處理數據
8. 生成自然語言回答
```

### 修正 4: 添加新範例

**範例 8: "黃雅君法官經手的三件損害賠償的案子，的請求金額和獲准金額個別是?" - 🆕 列表 + 金額範例**

```
步驟:
1. [重要] 調用 semantic_search_judgments (query="損害賠償", judge_name="黃雅君", limit=3, intended_analysis="amount_analysis")
   - 雖然是列表查詢，但因為需要顯示金額資料，所以**必須**使用 intended_analysis="amount_analysis"
   - 這樣才能確保返回的判決書包含 key_metrics.civil_metrics 欄位
2. 生成回答: "以下是黃雅君法官經手的三件損害賠償案件的金額資訊: 1) 損害賠償 (2025-07-31) - 請求金額: 420,000 元, 獲准金額: 420,000 元..."
```

**範例 9: "這些案件的案號是什麼?" (延續性問題 - 需要從對話歷史中提取)**

```
上下文: 用戶剛才問過某些案件的資訊
步驟:
1. [重要] 檢查對話歷史中是否有相關案件資料
2. 如果有，直接從對話歷史中提取案號（JID）
3. 如果沒有或資料不完整，重新調用 semantic_search_judgments 獲取
4. 生成回答: "以下是這些案件的案號: 1) SLEV,114,士簡,720,20250731,1..."
```

---

## 預期效果

### 修正前的行為 ❌

```
用戶: "黃雅君法官經手的三件損害賠償的案子，的請求金額和獲准金額個別是?"

GPT 思考:
- 看到 "三件案子" → 認為是列表查詢
- 優先選擇最輕量的類型 → intended_analysis="list"
- 或者直接從對話歷史中提取（沒有金額欄位）

結果:
1. 損害賠償 (2025-07-31) - 請求金額: 未提供 ❌
2. 損害賠償(簡判) (2025-07-17) - 請求金額: 未提供 ❌
3. 損害賠償 (2025-07-04) - 請求金額: 230,000 元 ✅
```

### 修正後的行為 ✅

```
用戶: "黃雅君法官經手的三件損害賠償的案子，的請求金額和獲准金額個別是?"

GPT 思考:
- 看到 "請求金額和獲准金額" → 需要金額資料
- 檢查對話歷史 → 發現缺少金額欄位
- 必須重新調用工具 → intended_analysis="amount_analysis"

調用:
semantic_search_judgments(
  query="損害賠償",
  judge_name="黃雅君",
  limit=3,
  intended_analysis="amount_analysis"  ✅
)

結果:
1. 損害賠償 (2025-07-31) - 請求金額: 420,000 元, 獲准金額: 420,000 元 ✅
2. 損害賠償(簡判) (2025-07-17) - 請求金額: 753,848 元, 獲准金額: 200,000 元 ✅
3. 損害賠償 (2025-07-04) - 請求金額: 230,000 元, 獲准金額: 80,000 元 ✅
```

---

## 測試案例

### 測試 1: 列表 + 金額查詢

**問題**: "黃雅君法官經手的三件損害賠償的案子，的請求金額和獲准金額個別是?"

**預期行為**:
1. GPT 識別出需要金額資料
2. 調用 `semantic_search_judgments` 並指定 `intended_analysis="amount_analysis"`
3. 返回包含金額欄位的判決書
4. 生成包含所有案件金額的回答

**預期結果**: ✅ 所有案件都有金額資料

---

### 測試 2: 延續性問題（從對話歷史提取）

**對話流程**:
```
用戶: "黃雅君法官經手的三件損害賠償的案子，的請求金額和獲准金額個別是?"
GPT: [返回三件案件的金額資訊]

用戶: "請給我這兩個案子的案號"  ← 延續性問題
```

**預期行為**:
1. GPT 檢查對話歷史
2. 發現之前已經查詢過這些案件
3. 直接從對話歷史中提取案號（JID）
4. 不需要重新調用工具

**預期結果**: ✅ 直接返回案號，不浪費 API 調用

---

### 測試 3: 對話歷史缺少欄位

**對話流程**:
```
用戶: "列出黃雅君法官的判決書"
GPT: [調用 search_judgments，intended_analysis="list"，只返回基本資訊]

用戶: "這些案件的請求金額是多少?"  ← 需要金額，但對話歷史中沒有
```

**預期行為**:
1. GPT 檢查對話歷史
2. 發現對話歷史中的資料**缺少金額欄位**
3. **必須重新調用** `semantic_search_judgments` 並指定 `intended_analysis="amount_analysis"`
4. 返回包含金額欄位的判決書

**預期結果**: ✅ 重新查詢並返回金額資料

---

## 部署檢查清單

- [x] 修正 System Prompt 重要規則
- [x] 更新金額分析描述
- [x] 添加工作流程檢查步驟
- [x] 添加範例 8（列表 + 金額）
- [x] 添加範例 9（延續性問題）
- [ ] 部署到 Vercel
- [ ] 端到端測試
- [ ] 驗證所有測試案例

---

## 相關修正

此修正與以下修正配合使用：
1. ✅ 金額欄位路徑修正（`lawsowl_mcp.py`）- 使用 `key_metrics.civil_metrics`
2. ✅ Intent Classifier 修正（`intentClassifier.js`）- 過濾 tool/tool_calls 訊息
3. ✅ System Prompt 修正（`ai-agent-tools.js`）- 明確指導金額查詢行為

---

**修正完成時間**: 2025-10-04
**修正檔案**: `d:\court_data\courtDataAPI\utils\ai-agent-tools.js`

