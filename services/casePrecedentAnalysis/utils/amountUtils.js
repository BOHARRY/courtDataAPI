// services/casePrecedentAnalysis/utils/amountUtils.js

/**
 * ÈáëÈ°çÂàÜÊûêÂ∑•ÂÖ∑ÂáΩÊï∏
 * Áî®ÊñºÊèêÂèñ„ÄÅË®àÁÆóÂíåÂàÜÊûêÊ∞ë‰∫ãÊ°à‰ª∂ÁöÑÈáëÈ°çÊï∏Êìö
 */

/**
 * ÂæûÂà§Ê±∫ÂàóË°®‰∏≠ÊèêÂèñÈáëÈ°çÊï∏Êìö
 * @param {Array} cases - Âà§Ê±∫Ê°à‰æãÂàóË°®
 * @returns {Object} ÂåÖÂê´ÂÖ®ÈÉ®Ê°à‰ª∂ÂíåÂãùË®¥Ê°à‰ª∂ÁöÑÈáëÈ°çÊï∏Êìö
 */
export function extractAmountData(cases) {
    console.log('[extractAmountData] ÈñãÂßãÊèêÂèñÈáëÈ°çÊï∏ÊìöÔºåÊ°à‰æãÊï∏Èáè:', cases?.length || 0);

    if (!cases || !Array.isArray(cases)) {
        console.warn('[extractAmountData] ÁÑ°ÊïàÁöÑÊ°à‰æãÊï∏Êìö');
        return { all: [], won: [], lost: [] };
    }

    const allAmounts = [];      // ÊâÄÊúâÊúâÊïàÊ°à‰ª∂ÔºàÂåÖÂê´ÊïóË®¥Ôºâ
    const wonAmounts = [];      // ÂãùË®¥Ê°à‰ª∂ÔºàÁç≤ÂáÜÈáëÈ°ç > 0Ôºâ
    const lostAmounts = [];     // ÊïóË®¥Ê°à‰ª∂ÔºàÁç≤ÂáÜÈáëÈ°ç = 0Ôºâ
    const abnormalCases = [];   // Áï∞Â∏∏Ê°à‰ª∂ÔºàÁç≤ÂáÜÁéá > 100%Ôºâ

    cases.forEach((case_, index) => {
        try {
            // üîß ÊîØÊåÅÂ§öÁ®ÆÊï∏ÊìöÁµêÊßã
            const source = case_._source || case_.source || case_;
            const keyMetrics = source?.key_metrics;
            const civilMetrics = keyMetrics?.civil_metrics;

            if (civilMetrics) {
                const claimAmount = civilMetrics.claim_amount;
                const grantedAmount = civilMetrics.granted_amount;

                // Âè™‰øùÁïôÊúâÊïàÊï∏ÊìöÔºàË´ãÊ±ÇÈáëÈ°ç > 0ÔºåÁç≤ÂáÜÈáëÈ°ç >= 0Ôºâ
                if (claimAmount > 0 && grantedAmount >= 0) {
                    // üîß Ë®àÁÆóÁç≤ÂáÜÁéáÔºå‰∏¶ÈôêÂà∂Âú® 0-100% ÁØÑÂúçÂÖß
                    let approvalRate = grantedAmount / claimAmount;
                    let isAbnormal = false;

                    // üö® Ê™¢Ê∏¨Áï∞Â∏∏ÂÄºÔºöÁç≤ÂáÜÈáëÈ°ç > Ë´ãÊ±ÇÈáëÈ°ç
                    if (approvalRate > 1.0) {
                        isAbnormal = true;
                        console.warn(`[extractAmountData] ‚ö†Ô∏è Áï∞Â∏∏Ê°à‰æã ${source.JID}: Áç≤ÂáÜÈáëÈ°ç(${grantedAmount}) > Ë´ãÊ±ÇÈáëÈ°ç(${claimAmount}), Áç≤ÂáÜÁéá: ${(approvalRate * 100).toFixed(1)}%`);
                    }

                    const amountData = {
                        caseId: source.JID || `case_${index}`,
                        caseTitle: source.JTITLE || 'ÁÑ°Ê®ôÈ°å',
                        claimAmount: claimAmount,
                        grantedAmount: grantedAmount,
                        approvalRate: approvalRate,
                        court: source.court || 'Êú™Áü•Ê≥ïÈô¢',
                        year: source.JYEAR || 'Êú™Áü•Âπ¥‰ªΩ',
                        verdictType: source.verdict_type || 'Êú™Áü•',
                        isAbnormal: isAbnormal
                    };

                    // üéØ ÂàÜÈ°ûÂ≠òÂÑ≤
                    allAmounts.push(amountData);

                    if (isAbnormal) {
                        abnormalCases.push(amountData);
                    } else if (grantedAmount > 0) {
                        wonAmounts.push(amountData);
                    } else {
                        lostAmounts.push(amountData);
                    }

                    console.log(`[extractAmountData] ‚úÖ Ê°à‰æã ${index + 1}: ${source.JID} - Ë´ãÊ±Ç: ${claimAmount}, Áç≤ÂáÜ: ${grantedAmount}, Áç≤ÂáÜÁéá: ${(approvalRate * 100).toFixed(1)}%${isAbnormal ? ' [Áï∞Â∏∏]' : ''}${grantedAmount === 0 ? ' [ÊïóË®¥]' : ''}`);
                } else {
                    console.log(`[extractAmountData] ‚ö†Ô∏è Ê°à‰æã ${index + 1}: ${source.JID} - ÈáëÈ°çÊï∏ÊìöÁÑ°Êïà (Ë´ãÊ±Ç: ${claimAmount}, Áç≤ÂáÜ: ${grantedAmount})`);
                }
            } else {
                console.log(`[extractAmountData] ‚ö†Ô∏è Ê°à‰æã ${index + 1}: ${source?.JID || 'unknown'} - ÁÑ° civil_metrics Êï∏Êìö`);
            }
        } catch (error) {
            console.error(`[extractAmountData] ‚ùå ËôïÁêÜÊ°à‰æã ${index + 1} ÊôÇÁôºÁîüÈåØË™§:`, error);
        }
    });

    console.log(`[extractAmountData] ÂÆåÊàêÊèêÂèñ - Á∏ΩË®à: ${allAmounts.length}, ÂãùË®¥: ${wonAmounts.length}, ÊïóË®¥: ${lostAmounts.length}, Áï∞Â∏∏: ${abnormalCases.length}`);

    return {
        all: allAmounts,
        won: wonAmounts,
        lost: lostAmounts,
        abnormal: abnormalCases
    };
}

/**
 * Ë®àÁÆóÁµ±Ë®àÊï∏ÊìöÔºàÊîØÊåÅÂàÜÂ±§Áµ±Ë®àÔºâ
 * @param {Object} amountsData - ÂåÖÂê´ all, won, lost, abnormal ÁöÑÈáëÈ°çÊï∏ÊìöÂ∞çË±°
 * @returns {Object|null} Áµ±Ë®àÁµêÊûú
 */
export function calculateStatistics(amountsData) {
    console.log('[calculateStatistics] ÈñãÂßãË®àÁÆóÁµ±Ë®àÊï∏Êìö');

    // üîß ÂÖºÂÆπËàäÁâà APIÔºàÂ¶ÇÊûúÂÇ≥ÂÖ•ÁöÑÊòØÊï∏ÁµÑÔºåËΩâÊèõÁÇ∫Êñ∞Ê†ºÂºèÔºâ
    let amounts, wonAmounts, lostAmounts, abnormalAmounts;

    if (Array.isArray(amountsData)) {
        console.warn('[calculateStatistics] ‚ö†Ô∏è ‰ΩøÁî®ËàäÁâà APIÔºåÂª∫Ë≠∞Êõ¥Êñ∞ÁÇ∫Êñ∞ÁâàÂàÜÂ±§Êï∏ÊìöÊ†ºÂºè');
        amounts = amountsData;
        wonAmounts = amountsData.filter(a => a.grantedAmount > 0 && a.approvalRate <= 1.0);
        lostAmounts = amountsData.filter(a => a.grantedAmount === 0);
        abnormalAmounts = amountsData.filter(a => a.approvalRate > 1.0);
    } else {
        amounts = amountsData.all || [];
        wonAmounts = amountsData.won || [];
        lostAmounts = amountsData.lost || [];
        abnormalAmounts = amountsData.abnormal || [];
    }

    console.log('[calculateStatistics] Êï∏ÊìöÂàÜÂ±§:', {
        total: amounts.length,
        won: wonAmounts.length,
        lost: lostAmounts.length,
        abnormal: abnormalAmounts.length
    });

    if (amounts.length === 0) {
        console.warn('[calculateStatistics] ÁÑ°ÊúâÊïàÈáëÈ°çÊï∏Êìö');
        return null;
    }

    // üéØ Ê†∏ÂøÉÁµ±Ë®àÂáΩÊï∏
    const median = (arr) => {
        if (arr.length === 0) return 0;
        const mid = Math.floor(arr.length / 2);
        return arr.length % 2 === 0
            ? (arr[mid - 1] + arr[mid]) / 2
            : arr[mid];
    };

    const quartile = (arr, q) => {
        if (arr.length === 0) return 0;
        const pos = (arr.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        return arr[base + 1] !== undefined
            ? arr[base] + rest * (arr[base + 1] - arr[base])
            : arr[base];
    };

    const mean = (arr) => {
        if (arr.length === 0) return 0;
        return arr.reduce((sum, val) => sum + val, 0) / arr.length;
    };

    // üéØ Ë®àÁÆóÂÖ®È´îÊ°à‰ª∂Áµ±Ë®àÔºàÂåÖÂê´ÊïóË®¥Ôºâ
    const sortedClaim = amounts.map(a => a.claimAmount).sort((a, b) => a - b);
    const sortedGranted = amounts.map(a => a.grantedAmount).sort((a, b) => a - b);
    const sortedRate = amounts.map(a => Math.min(a.approvalRate, 1.0)).sort((a, b) => a - b); // üîß ÈôêÂà∂Áç≤ÂáÜÁéá‰∏äÈôêÁÇ∫ 100%

    const allStatistics = {
        totalCases: amounts.length,
        claimAmount: {
            median: median(sortedClaim),
            mean: mean(sortedClaim),
            q1: quartile(sortedClaim, 0.25),
            q3: quartile(sortedClaim, 0.75),
            min: sortedClaim[0],
            max: sortedClaim[sortedClaim.length - 1]
        },
        grantedAmount: {
            median: median(sortedGranted),
            mean: mean(sortedGranted),
            q1: quartile(sortedGranted, 0.25),
            q3: quartile(sortedGranted, 0.75),
            min: sortedGranted[0],
            max: sortedGranted[sortedGranted.length - 1]
        },
        approvalRate: {
            median: median(sortedRate),
            mean: mean(sortedRate),
            q1: quartile(sortedRate, 0.25),
            q3: quartile(sortedRate, 0.75),
            min: sortedRate[0],
            max: sortedRate[sortedRate.length - 1]
        }
    };

    // üéØ Ë®àÁÆóÂãùË®¥Ê°à‰ª∂Áµ±Ë®àÔºàÊéíÈô§ÊïóË®¥ÂíåÁï∞Â∏∏ÂÄºÔºâ
    let wonStatistics = null;
    if (wonAmounts.length > 0) {
        const wonSortedClaim = wonAmounts.map(a => a.claimAmount).sort((a, b) => a - b);
        const wonSortedGranted = wonAmounts.map(a => a.grantedAmount).sort((a, b) => a - b);
        const wonSortedRate = wonAmounts.map(a => a.approvalRate).sort((a, b) => a - b);

        wonStatistics = {
            totalCases: wonAmounts.length,
            claimAmount: {
                median: median(wonSortedClaim),
                mean: mean(wonSortedClaim),
                q1: quartile(wonSortedClaim, 0.25),
                q3: quartile(wonSortedClaim, 0.75),
                min: wonSortedClaim[0],
                max: wonSortedClaim[wonSortedClaim.length - 1]
            },
            grantedAmount: {
                median: median(wonSortedGranted),
                mean: mean(wonSortedGranted),
                q1: quartile(wonSortedGranted, 0.25),
                q3: quartile(wonSortedGranted, 0.75),
                min: wonSortedGranted[0],
                max: wonSortedGranted[wonSortedGranted.length - 1]
            },
            approvalRate: {
                median: median(wonSortedRate),
                mean: mean(wonSortedRate),
                q1: quartile(wonSortedRate, 0.25),
                q3: quartile(wonSortedRate, 0.75),
                min: wonSortedRate[0],
                max: wonSortedRate[wonSortedRate.length - 1]
            }
        };
    }

    console.log('[calculateStatistics] ÂÖ®È´îÊ°à‰ª∂Áµ±Ë®à:', {
        totalCases: allStatistics.totalCases,
        claimMedian: allStatistics.claimAmount.median,
        grantedMedian: allStatistics.grantedAmount.median,
        approvalRateMedian: (allStatistics.approvalRate.median * 100).toFixed(1) + '%'
    });

    if (wonStatistics) {
        console.log('[calculateStatistics] ÂãùË®¥Ê°à‰ª∂Áµ±Ë®à:', {
            totalCases: wonStatistics.totalCases,
            claimMedian: wonStatistics.claimAmount.median,
            grantedMedian: wonStatistics.grantedAmount.median,
            approvalRateMedian: (wonStatistics.approvalRate.median * 100).toFixed(1) + '%'
        });
    }

    return {
        all: allStatistics,
        won: wonStatistics,
        lostCount: lostAmounts.length,
        abnormalCount: abnormalAmounts.length,
        winRate: wonAmounts.length / amounts.length
    };
}

/**
 * Ë≠òÂà•Áï∞Â∏∏ÂÄº
 * @param {Array} amounts - ÈáëÈ°çÊï∏ÊìöÊï∏ÁµÑ
 * @param {Object} statistics - Áµ±Ë®àÊï∏Êìö
 * @returns {Object} Áï∞Â∏∏ÂÄºÊï∏Êìö
 */
export function identifyOutliers(amounts, statistics) {
    console.log('[identifyOutliers] ÈñãÂßãË≠òÂà•Áï∞Â∏∏ÂÄº');
    
    if (!amounts || !statistics) {
        return { high: [], low: [] };
    }
    
    // ‰ΩøÁî® IQR Ê≥ïÂâáË≠òÂà•Áï∞Â∏∏ÂÄº
    const claimIQR = statistics.claimAmount.q3 - statistics.claimAmount.q1;
    const grantedIQR = statistics.grantedAmount.q3 - statistics.grantedAmount.q1;
    
    const claimLowerBound = statistics.claimAmount.q1 - 1.5 * claimIQR;
    const claimUpperBound = statistics.claimAmount.q3 + 1.5 * claimIQR;
    const grantedLowerBound = statistics.grantedAmount.q1 - 1.5 * grantedIQR;
    const grantedUpperBound = statistics.grantedAmount.q3 + 1.5 * grantedIQR;
    
    const outliers = {
        high: [],
        low: []
    };
    
    amounts.forEach(amount => {
        const isHighClaim = amount.claimAmount > claimUpperBound;
        const isHighGranted = amount.grantedAmount > grantedUpperBound;
        const isLowClaim = amount.claimAmount < claimLowerBound;
        const isLowGranted = amount.grantedAmount < grantedLowerBound;
        
        if (isHighClaim || isHighGranted) {
            outliers.high.push({
                ...amount,
                reason: isHighClaim ? 'Ë´ãÊ±ÇÈáëÈ°çÈÅéÈ´ò' : 'Áç≤ÂáÜÈáëÈ°çÈÅéÈ´ò'
            });
        }
        
        if (isLowClaim || isLowGranted) {
            outliers.low.push({
                ...amount,
                reason: isLowClaim ? 'Ë´ãÊ±ÇÈáëÈ°çÈÅé‰Ωé' : 'Áç≤ÂáÜÈáëÈ°çÈÅé‰Ωé'
            });
        }
    });
    
    console.log(`[identifyOutliers] Ë≠òÂà•ÂÆåÊàê - È´òÁï∞Â∏∏ÂÄº: ${outliers.high.length}, ‰ΩéÁï∞Â∏∏ÂÄº: ${outliers.low.length}`);
    return outliers;
}

/**
 * ÈÅ∏Êìá‰ª£Ë°®ÊÄßÊ°à‰æã
 * @param {Array} amounts - ÈáëÈ°çÊï∏ÊìöÊï∏ÁµÑ
 * @param {Object} statistics - Áµ±Ë®àÊï∏Êìö
 * @returns {Object} ‰ª£Ë°®ÊÄßÊ°à‰æã
 */
export function selectRepresentativeCases(amounts, statistics) {
    console.log('[selectRepresentativeCases] ÈñãÂßãÈÅ∏Êìá‰ª£Ë°®ÊÄßÊ°à‰æã');
    
    if (!amounts || amounts.length === 0 || !statistics) {
        return { high: null, medium: null, low: null };
    }
    
    // ÊåâÁç≤ÂáÜÁéáÊéíÂ∫è
    const sortedByRate = [...amounts].sort((a, b) => a.approvalRate - b.approvalRate);
    
    // ÈÅ∏ÊìáÈ´ò„ÄÅ‰∏≠„ÄÅ‰ΩéÁç≤ÂáÜÁéáÁöÑ‰ª£Ë°®ÊÄßÊ°à‰æã
    const lowIndex = Math.floor(sortedByRate.length * 0.1); // 10th percentile
    const mediumIndex = Math.floor(sortedByRate.length * 0.5); // 50th percentile (median)
    const highIndex = Math.floor(sortedByRate.length * 0.9); // 90th percentile
    
    const representatives = {
        low: sortedByRate[lowIndex] || null,
        medium: sortedByRate[mediumIndex] || null,
        high: sortedByRate[highIndex] || null
    };
    
    console.log('[selectRepresentativeCases] ÈÅ∏ÊìáÂÆåÊàê:', {
        low: representatives.low ? `${(representatives.low.approvalRate * 100).toFixed(1)}%` : 'N/A',
        medium: representatives.medium ? `${(representatives.medium.approvalRate * 100).toFixed(1)}%` : 'N/A',
        high: representatives.high ? `${(representatives.high.approvalRate * 100).toFixed(1)}%` : 'N/A'
    });
    
    return representatives;
}

/**
 * Ê†ºÂºèÂåñÈáëÈ°çÈ°ØÁ§∫
 * @param {number} amount - ÈáëÈ°ç
 * @returns {string} Ê†ºÂºèÂåñÂæåÁöÑÈáëÈ°çÂ≠óÁ¨¶‰∏≤
 */
export function formatAmount(amount) {
    if (amount >= 10000) {
        return `${(amount / 10000).toFixed(1)} Ëê¨ÂÖÉ`;
    }
    return `${amount.toLocaleString('zh-TW')} ÂÖÉ`;
}

/**
 * Ê†ºÂºèÂåñÁç≤ÂáÜÁéáÈ°ØÁ§∫
 * @param {number} rate - Áç≤ÂáÜÁéáÔºà0-1Ôºâ
 * @returns {string} Ê†ºÂºèÂåñÂæåÁöÑÁç≤ÂáÜÁéáÂ≠óÁ¨¶‰∏≤
 */
export function formatApprovalRate(rate) {
    return `${(rate * 100).toFixed(0)}%`;
}

