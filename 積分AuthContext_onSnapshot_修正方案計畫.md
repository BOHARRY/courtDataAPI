# ğŸ” ç©åˆ† AuthContext onSnapshot ä¿®æ­£æ–¹æ¡ˆè¨ˆç•«

## ğŸ“‹ å•é¡Œæè¿°

**ç¾è±¡**ï¼šé ˜å–ç©åˆ†å¾Œï¼Œå´é‚Šæ¬„çš„ç©åˆ†æ•¸å­—ä¸æœƒç«‹å³æ›´æ–°ï¼Œéœ€è¦é‡æ–°æ•´ç†ç€è¦½å™¨æ‰èƒ½çœ‹åˆ°è®ŠåŒ–ã€‚

**æ ¹æœ¬åŸå› **ï¼š**AuthContext ä½¿ç”¨çš„æ˜¯ä¸€æ¬¡æ€§è®€å–ï¼ˆ`getDoc`ï¼‰ï¼Œè€Œä¸æ˜¯å¯¦æ™‚ç›£è½ï¼ˆ`onSnapshot`ï¼‰**

---

## ğŸ“Š ç•¶å‰ç©åˆ†ç³»çµ±å…¨æ™¯åœ–

### ğŸ¯ ç©åˆ†æ¶ˆè€—å ´æ™¯ï¼ˆå…± 16 å€‹ï¼‰

| åŠŸèƒ½ | ç©åˆ†æ¶ˆè€— | è·¯ç”± | ä¸­é–“ä»¶ |
|------|---------|------|--------|
| **æœå°‹åˆ¤æ±ºæ›¸** | 1 é» | `GET /api/search` | `checkAndDeductCredits` |
| **æŸ¥çœ‹åˆ¤æ±ºè©³æƒ…** | 1 é» | `GET /api/judgments/:id` | `checkAndDeductCredits` |
| **èªæ„æœå°‹** | 3 é» | `POST /api/semantic-search/legal-issues` | `checkAndDeductCredits` |
| **æ³•å®˜ AI åˆ†æ** | 3 é» | `GET /api/judges/:judgeName` | `checkAndDeductCredits` |
| **å¾‹å¸«åŸºæœ¬è³‡æ–™** | 1 é» | `GET /api/lawyers/:lawyerName` | `checkAndDeductCredits` |
| **å¾‹å¸«æ¡ˆä»¶åˆ†å¸ƒ** | 1 é» | `GET /api/lawyers/:lawyerName/cases-distribution` | `checkAndDeductCredits` |
| **å¾‹å¸« AI åˆ†æ** | 2 é» | `GET /api/lawyers/:lawyerName/ai-analysis` | `checkAndDeductCredits` |
| **AI å‹è¨´åˆ†æ** | 5 é» | `POST /api/ai/analyze-success-factors` | `checkAndDeductCredits` |
| **AI æ­¸ç´å…±åŒé»** | 4 é» | `POST /api/ai/summarize-common-points` | `checkAndDeductCredits` |
| **æ¡ˆä¾‹åˆ¤æ±ºå‚¾å‘** | 4 é» | `POST /api/ai/case-precedent-analysis` | `checkAndDeductCredits` |
| **AI è¨´ç‹€ç”Ÿæˆ** | 6 é» | `POST /api/ai/pleading-generation` | `checkAndDeductCredits` |
| **AI æ½¤é£¾æè¿°** | 1 é» | `POST /api/ai/beautify-description` | `checkAndDeductCredits` |
| **æ³•æ¢åŸºç¤æœç´¢** | 1 é» | `GET /api/law-search/articles` | `checkAndDeductCredits` |
| **æ³•æ¢èªæ„æœç´¢** | 3 é» | `POST /api/law-search/semantic` | `checkAndDeductCredits` |
| **è¨´ç‹€é©—è­‰** | 1 é» | `POST /api/complaint/validate-text` | `checkAndDeductCredits` |
| **æ³•å®˜åŒ¹é…åˆ†æ** | 2 é» | `POST /api/complaint/analyze-judge-match` | `checkAndDeductCredits` |

**ç¸½è¨ˆ**ï¼š16 å€‹ç©åˆ†æ¶ˆè€—åŠŸèƒ½

---

### ğŸ’° ç©åˆ†å¢åŠ å ´æ™¯ï¼ˆå…± 7+ å€‹ï¼‰

| å ´æ™¯ | ç©åˆ†å¢åŠ  | è§¸ç™¼æ™‚æ©Ÿ | å¯¦ä½œä½ç½® |
|------|---------|---------|---------|
| **è¨»å†Šçå‹µ** | 300 é» | æ–°ç”¨æˆ¶è¨»å†Šæ™‚ | `AuthContext.js` â†’ `grantSignupBonus` |
| **æ–°æ‰‹ä»»å‹™çå‹µ** | 100 é» | å®Œæˆ 5 å€‹æ–°æ‰‹ä»»å‹™ | `GiftBox.js` â†’ `grantOnboardingTasksCompletionReward` |
| **è¨‚é–±æœˆä»˜è´ˆé€ï¼ˆåŸºæœ¬ï¼‰** | 250 é» | è¨‚é–±åŸºæœ¬æ–¹æ¡ˆï¼ˆæœˆä»˜ï¼‰ | `updateUserSubscriptionInTransaction` |
| **è¨‚é–±å¹´ä»˜è´ˆé€ï¼ˆåŸºæœ¬ï¼‰** | 3000 é» | è¨‚é–±åŸºæœ¬æ–¹æ¡ˆï¼ˆå¹´ä»˜ï¼‰ | `updateUserSubscriptionInTransaction` |
| **è¨‚é–±æœˆä»˜è´ˆé€ï¼ˆé€²éšï¼‰** | 2500 é» | è¨‚é–±é€²éšæ–¹æ¡ˆï¼ˆæœˆä»˜ï¼‰ | `updateUserSubscriptionInTransaction` |
| **è¨‚é–±å‡ç´šçå‹µ** | è®Šå‹• | å¾ä½æ–¹æ¡ˆå‡ç´šåˆ°é«˜æ–¹æ¡ˆ | `updateUserSubscriptionInTransaction` |
| **è³¼è²·ç©åˆ†åŒ…** | 20-3000 é» | è³¼è²·ç©åˆ†åŒ… | `handleMpgNotifyController` |
| **ç®¡ç†å“¡èª¿æ•´** | è®Šå‹• | ç®¡ç†å“¡æ‰‹å‹•èª¿æ•´ | `addUserCreditsAndLog` |

**ç¸½è¨ˆ**ï¼š8+ å€‹ç©åˆ†å¢åŠ å ´æ™¯

---

### ğŸ“± å‰ç«¯é¡¯ç¤ºç©åˆ†çš„çµ„ä»¶ï¼ˆå…± 3 å€‹ï¼‰

| çµ„ä»¶ | é¡¯ç¤ºä½ç½® | æ•¸æ“šä¾†æº | æ›´æ–°æ–¹å¼ |
|------|---------|---------|---------|
| **Sidebar.js** | å´é‚Šæ¬„åº•éƒ¨ | `currentUser.credits` | âŒ éœæ…‹ï¼ˆä¸è‡ªå‹•æ›´æ–°ï¼‰ |
| **AccountSettings.js** | å¸³è™Ÿè¨­å®šé  | `currentUser.credits` + API æŸ¥è©¢æ­·å² | âŒ éœæ…‹ï¼ˆä¸è‡ªå‹•æ›´æ–°ï¼‰ |
| **GiftBox.js** | ç¦®ç‰©ç›’çµ„ä»¶ | Firebase `onSnapshot` | âœ… å¯¦æ™‚ç›£è½ |

---

## ğŸ”„ ç•¶å‰æ•¸æ“šæµåˆ†æ

### âŒ å•é¡Œæµç¨‹ï¼ˆç©åˆ†æ¶ˆè€—ï¼‰

```
1. ç”¨æˆ¶é»æ“Šã€Œæœå°‹åˆ¤æ±ºæ›¸ã€
   â†“
2. å‰ç«¯èª¿ç”¨ API: GET /api/search
   â†“
3. å¾Œç«¯ä¸­é–“ä»¶ checkAndDeductCredits
   â”œâ”€ æª¢æŸ¥ç©åˆ†æ˜¯å¦è¶³å¤ 
   â”œâ”€ æ‰£é™¤ 1 é»ç©åˆ†
   â”œâ”€ æ›´æ–° Firestore: users/{uid}/credits (-1)
   â””â”€ å‰µå»º creditTransactions è¨˜éŒ„
   â†“
4. API è¿”å›æœå°‹çµæœ
   â†“
âŒ Sidebar ç©åˆ†æ•¸å­— **ä¸è®Š**ï¼ˆå› ç‚º AuthContext æ²’æœ‰ç›£è½ï¼‰
   â†“
5. ç”¨æˆ¶é‡æ–°æ•´ç†é é¢
   â†“
6. onAuthStateChanged è§¸ç™¼ â†’ getDoc() è®€å–æ–°æ•¸æ“š
   â†“
âœ… Sidebar ç©åˆ†æ•¸å­—æ›´æ–°
```

### âŒ å•é¡Œæµç¨‹ï¼ˆç©åˆ†å¢åŠ ï¼‰

```
1. ç”¨æˆ¶é»æ“Šã€Œé ˜å–ç©åˆ†ã€
   â†“
2. å‰ç«¯èª¿ç”¨ API: POST /api/users/claim-onboarding-reward
   â†“
3. å¾Œç«¯ grantOnboardingTasksCompletionReward
   â”œâ”€ å¢åŠ  100 é»ç©åˆ†
   â”œâ”€ æ›´æ–° Firestore: users/{uid}/credits (+100)
   â””â”€ å‰µå»º creditTransactions è¨˜éŒ„
   â†“
4. API è¿”å›æˆåŠŸ
   â†“
âŒ Sidebar ç©åˆ†æ•¸å­— **ä¸è®Š**ï¼ˆå› ç‚º AuthContext æ²’æœ‰ç›£è½ï¼‰
   â†“
5. ç”¨æˆ¶é‡æ–°æ•´ç†é é¢
   â†“
âœ… Sidebar ç©åˆ†æ•¸å­—æ›´æ–°
```

### âœ… æ­£å¸¸æµç¨‹ï¼ˆGiftBox ä»»å‹™ç‹€æ…‹ï¼‰

```
1. ç”¨æˆ¶å®Œæˆä»»å‹™
   â†“
2. taskService æ›´æ–° Firestore: users/{uid}/onboardingTasks
   â†“
âœ… GiftBox çš„ onSnapshot ç›£è½å™¨ **ç«‹å³è§¸ç™¼**ï¼ˆ< 1 ç§’ï¼‰
   â†“
âœ… åœ“ç’°ç«‹å³è®Šç¶ 
```

---

## ğŸ¯ è§£æ±ºæ–¹æ¡ˆï¼šAuthContext ä½¿ç”¨ onSnapshot

### ğŸ“ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**åªéœ€ä¿®æ”¹ 1 å€‹æ–‡ä»¶**ï¼š
- `src/AuthContext.js`ï¼ˆç¬¬ 137-187 è¡Œï¼‰

---

### ğŸ” ä¿®æ”¹é»è©³ç´°åˆ†æ

#### **ç•¶å‰ä»£ç¢¼**ï¼ˆç¬¬ 137-187 è¡Œï¼‰

```javascript
useEffect(() => {
  const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef); // âŒ ä¸€æ¬¡æ€§è®€å–
      
      if (docSnap.exists()) {
        const firestoreData = docSnap.data();
        setCurrentUser({ ...user, ...firestoreData }); // âŒ åªè¨­ç½®ä¸€æ¬¡
      }
    } else {
      setCurrentUser(null);
    }
    setLoading(false);
  });

  return () => unsubscribeAuth();
}, []);
```

**å•é¡Œ**ï¼š
1. âŒ `getDoc()` æ˜¯ä¸€æ¬¡æ€§è®€å–ï¼Œä¸æœƒç›£è½è®ŠåŒ–
2. âŒ `setCurrentUser()` åªåœ¨ç™»å…¥æ™‚åŸ·è¡Œä¸€æ¬¡
3. âŒ ç©åˆ†è®ŠåŒ–å¾Œï¼Œ`currentUser.credits` ä¸æœƒæ›´æ–°

---

#### **ä¿®æ”¹å¾Œä»£ç¢¼**

```javascript
useEffect(() => {
  let unsubscribeFirestore = null; // ğŸ”§ æ–°å¢ï¼šFirestore ç›£è½å™¨æ¸…ç†å‡½æ•¸

  const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userRef = doc(db, "users", user.uid);
      
      // ğŸ”¥ æ”¹ç‚ºå¯¦æ™‚ç›£è½
      unsubscribeFirestore = onSnapshot(
        userRef,
        (docSnap) => {
          if (docSnap.exists()) {
            const firestoreData = docSnap.data();
            setCurrentUser(prevUser => ({
              ...user, // Firebase Auth æ•¸æ“š
              ...firestoreData, // Firestore æ•¸æ“šï¼ˆåŒ…å« creditsï¼‰
            }));
            console.log('[AuthContext] ğŸ”¥ å¯¦æ™‚æ›´æ–°ç”¨æˆ¶æ•¸æ“š:', {
              uid: user.uid,
              credits: firestoreData.credits
            });
          }
          setLoading(false);
        },
        (error) => {
          console.error('[AuthContext] Firestore ç›£è½éŒ¯èª¤:', error);
          setLoading(false);
        }
      );
    } else {
      // ç”¨æˆ¶ç™»å‡º
      if (unsubscribeFirestore) {
        unsubscribeFirestore(); // æ¸…ç† Firestore ç›£è½å™¨
        unsubscribeFirestore = null;
      }
      setCurrentUser(null);
      setLoading(false);
    }
  });

  return () => {
    unsubscribeAuth();
    if (unsubscribeFirestore) {
      unsubscribeFirestore(); // æ¸…ç† Firestore ç›£è½å™¨
    }
  };
}, []);
```

**æ”¹é€²**ï¼š
1. âœ… ä½¿ç”¨ `onSnapshot()` å¯¦æ™‚ç›£è½
2. âœ… ä»»ä½• Firestore è®ŠåŒ–éƒ½æœƒè§¸ç™¼ `setCurrentUser`
3. âœ… ç©åˆ†è®ŠåŒ–å¾Œï¼Œ`currentUser.credits` **ç«‹å³æ›´æ–°**
4. âœ… ç™»å‡ºæ™‚æ­£ç¢ºæ¸…ç†ç›£è½å™¨

---

### ğŸŒŠ ä¿®æ”¹å¾Œçš„æ•¸æ“šæµ

#### **ç©åˆ†æ¶ˆè€—æµç¨‹**

```
1. ç”¨æˆ¶é»æ“Šã€Œæœå°‹åˆ¤æ±ºæ›¸ã€
   â†“
2. å‰ç«¯èª¿ç”¨ API: GET /api/search
   â†“
3. å¾Œç«¯æ‰£é™¤ 1 é»ç©åˆ†
   â”œâ”€ æ›´æ–° Firestore: users/{uid}/credits (-1)
   â””â”€ å‰µå»º creditTransactions è¨˜éŒ„
   â†“
âœ… AuthContext çš„ onSnapshot ç›£è½å™¨ **ç«‹å³è§¸ç™¼**ï¼ˆ< 1 ç§’ï¼‰
   â†“
âœ… setCurrentUser æ›´æ–° credits
   â†“
âœ… Sidebar è‡ªå‹•é‡æ–°æ¸²æŸ“
   â†“
âœ… ç©åˆ†æ•¸å­—ç«‹å³æ›´æ–°ï¼ğŸ‰
```

#### **ç©åˆ†å¢åŠ æµç¨‹**

```
1. ç”¨æˆ¶é»æ“Šã€Œé ˜å–ç©åˆ†ã€
   â†“
2. å¾Œç«¯å¢åŠ  100 é»ç©åˆ†
   â”œâ”€ æ›´æ–° Firestore: users/{uid}/credits (+100)
   â””â”€ å‰µå»º creditTransactions è¨˜éŒ„
   â†“
âœ… AuthContext çš„ onSnapshot ç›£è½å™¨ **ç«‹å³è§¸ç™¼**ï¼ˆ< 1 ç§’ï¼‰
   â†“
âœ… setCurrentUser æ›´æ–° credits
   â†“
âœ… Sidebar è‡ªå‹•é‡æ–°æ¸²æŸ“
   â†“
âœ… ç©åˆ†æ•¸å­—ç«‹å³æ›´æ–°ï¼ğŸ‰
```

---

## ğŸ”’ å®‰å…¨æ€§å’Œä¸€è‡´æ€§æª¢æŸ¥

### âœ… ä¸æœƒå½±éŸ¿çš„åŠŸèƒ½

1. **è¨»å†Šçå‹µ**ï¼ˆ`loginWithGoogle`ï¼‰
   - âœ… ä»ç„¶æ­£å¸¸å·¥ä½œ
   - âœ… æ–°ç”¨æˆ¶è¨»å†Šå¾Œï¼Œ`onSnapshot` æœƒç›£è½åˆ°ç©åˆ†è®ŠåŒ–

2. **æ‰‹å‹•åˆ·æ–°**ï¼ˆ`refreshUser`ï¼‰
   - âœ… ä»ç„¶å¯ç”¨ï¼ˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆï¼‰
   - âœ… ä½†ä¸å†éœ€è¦æ‰‹å‹•èª¿ç”¨

3. **æ‰€æœ‰ç©åˆ†æ¶ˆè€—åŠŸèƒ½**ï¼ˆ16 å€‹ï¼‰
   - âœ… å¾Œç«¯é‚è¼¯ä¸è®Š
   - âœ… å‰ç«¯è‡ªå‹•æ›´æ–°

4. **æ‰€æœ‰ç©åˆ†å¢åŠ åŠŸèƒ½**ï¼ˆ8+ å€‹ï¼‰
   - âœ… å¾Œç«¯é‚è¼¯ä¸è®Š
   - âœ… å‰ç«¯è‡ªå‹•æ›´æ–°

---

### âš ï¸ éœ€è¦æ³¨æ„çš„é‚Šç·£æƒ…æ³

#### **1. é¦–æ¬¡ç™»å…¥æ™‚çš„ `setLoading(false)` æ™‚æ©Ÿ**

**ç•¶å‰ä»£ç¢¼**ï¼š
```javascript
const docSnap = await getDoc(userRef);
// ... è™•ç†æ•¸æ“š ...
setLoading(false); // âŒ åœ¨ async å‡½æ•¸ä¸­è¨­ç½®
```

**ä¿®æ”¹å¾Œ**ï¼š
```javascript
unsubscribeFirestore = onSnapshot(userRef, (docSnap) => {
  // ... è™•ç†æ•¸æ“š ...
  setLoading(false); // âœ… åœ¨ onSnapshot å›èª¿ä¸­è¨­ç½®
});
```

**å½±éŸ¿**ï¼š
- âœ… é¦–æ¬¡ç™»å…¥æ™‚ï¼Œ`setLoading(false)` æœƒåœ¨ `onSnapshot` ç¬¬ä¸€æ¬¡è§¸ç™¼æ™‚åŸ·è¡Œ
- âœ… æ™‚æ©Ÿèˆ‡ç•¶å‰ä»£ç¢¼å¹¾ä¹ç›¸åŒï¼ˆéƒ½æ˜¯åœ¨ç²å–åˆ° Firestore æ•¸æ“šå¾Œï¼‰

---

#### **2. ç”¨æˆ¶ç™»å‡ºæ™‚çš„æ¸…ç†**

**ç•¶å‰ä»£ç¢¼**ï¼š
```javascript
} else {
  setCurrentUser(null);
}
setLoading(false);
```

**ä¿®æ”¹å¾Œ**ï¼š
```javascript
} else {
  if (unsubscribeFirestore) {
    unsubscribeFirestore(); // âœ… æ¸…ç† Firestore ç›£è½å™¨
    unsubscribeFirestore = null;
  }
  setCurrentUser(null);
  setLoading(false);
}
```

**å½±éŸ¿**ï¼š
- âœ… ç™»å‡ºæ™‚æ­£ç¢ºæ¸…ç†ç›£è½å™¨ï¼Œé¿å…å…§å­˜æ´©æ¼
- âœ… ä¸æœƒå½±éŸ¿ç™»å‡ºæµç¨‹

---

#### **3. å¤šå€‹ç€è¦½å™¨è¦–çª—åŒæ­¥**

**ç•¶å‰ä»£ç¢¼**ï¼š
- âŒ å¤šå€‹è¦–çª—ä¸æœƒåŒæ­¥ï¼ˆå› ç‚ºæ˜¯ä¸€æ¬¡æ€§è®€å–ï¼‰

**ä¿®æ”¹å¾Œ**ï¼š
- âœ… å¤šå€‹è¦–çª—æœƒè‡ªå‹•åŒæ­¥ï¼ˆå› ç‚ºéƒ½ç›£è½åŒä¸€å€‹ Firestore æ–‡æª”ï¼‰

**å ´æ™¯**ï¼š
```
è¦–çª— A: ç”¨æˆ¶é»æ“Šã€Œæœå°‹åˆ¤æ±ºæ›¸ã€
   â†“
Firestore: users/{uid}/credits æ›´æ–°
   â†“
è¦–çª— A: onSnapshot è§¸ç™¼ â†’ ç©åˆ†æ›´æ–° âœ…
è¦–çª— B: onSnapshot è§¸ç™¼ â†’ ç©åˆ†æ›´æ–° âœ…
```

---

#### **4. æ€§èƒ½å½±éŸ¿**

**ç•¶å‰ä»£ç¢¼**ï¼š
- 0 å€‹ Firestore ç›£è½å™¨ï¼ˆåªæœ‰ä¸€æ¬¡æ€§è®€å–ï¼‰

**ä¿®æ”¹å¾Œ**ï¼š
- 1 å€‹ Firestore ç›£è½å™¨ï¼ˆç›£è½ `users/{uid}`ï¼‰

**å½±éŸ¿åˆ†æ**ï¼š
- âœ… **æ¥µå°**ï¼šåªå¢åŠ  1 å€‹ç›£è½å™¨
- âœ… **å¯æ¥å—**ï¼šGiftBox å·²ç¶“åœ¨ä½¿ç”¨ `onSnapshot`ï¼Œè­‰æ˜é€™ç¨®æ–¹å¼å¯è¡Œ
- âœ… **å„ªåŒ–**ï¼šé¿å…äº†å¤šæ¬¡æ‰‹å‹•èª¿ç”¨ `refreshUser`

**Firestore è¨ˆè²»**ï¼š
- æ¯æ¬¡æ–‡æª”è®ŠåŒ– = 1 æ¬¡è®€å–
- ç”¨æˆ¶ç™»å…¥æ™‚ = 1 æ¬¡è®€å–
- ç©åˆ†è®ŠåŒ–æ™‚ = 1 æ¬¡è®€å–
- **ç¸½è¨ˆ**ï¼šèˆ‡ç•¶å‰æ–¹æ¡ˆç›¸æ¯”ï¼Œåªæ˜¯å°‡ã€Œæ‰‹å‹•è®€å–ã€æ”¹ç‚ºã€Œè‡ªå‹•ç›£è½ã€

---

### ğŸ¯ èˆ‡ GiftBox çš„æ¶æ§‹ä¸€è‡´æ€§

| ç‰¹æ€§ | GiftBox | AuthContextï¼ˆç•¶å‰ï¼‰ | AuthContextï¼ˆä¿®æ”¹å¾Œï¼‰ |
|------|---------|-------------------|---------------------|
| **æ•¸æ“šæº** | Firestore | Firestore | Firestore |
| **è®€å–æ–¹å¼** | `onSnapshot` | `getDoc` | `onSnapshot` âœ… |
| **æ›´æ–°æ–¹å¼** | è‡ªå‹• | æ‰‹å‹• | è‡ªå‹• âœ… |
| **å¯¦æ™‚æ€§** | < 1 ç§’ | éœ€é‡æ–°æ•´ç† | < 1 ç§’ âœ… |
| **å¤šè¦–çª—åŒæ­¥** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |

**çµè«–**ï¼šä¿®æ”¹å¾Œçš„ AuthContext èˆ‡ GiftBox å®Œå…¨ä¸€è‡´ï¼âœ…

---

## ğŸš€ å¯¦ä½œè¨ˆåŠƒ

### ğŸ“‹ å¯¦ä½œæ­¥é©Ÿ

#### **éšæ®µ 1ï¼šä¿®æ”¹ AuthContext.js**

1. **å‚™ä»½ç•¶å‰ä»£ç¢¼**
   - è¤‡è£½ `src/AuthContext.js` ç‚º `src/AuthContext.js.backup`

2. **ä¿®æ”¹ useEffectï¼ˆç¬¬ 137-187 è¡Œï¼‰**
   - æ·»åŠ  `unsubscribeFirestore` è®Šé‡
   - å°‡ `getDoc` æ”¹ç‚º `onSnapshot`
   - æ·»åŠ  Firestore ç›£è½å™¨æ¸…ç†é‚è¼¯

3. **æ·»åŠ å¿…è¦çš„ import**
   - ç¢ºä¿å·²å°å…¥ `onSnapshot` from `firebase/firestore`

---

#### **éšæ®µ 2ï¼šæ¸¬è©¦ç™»å…¥/ç™»å‡ºæµç¨‹**

1. **æ¸¬è©¦æ–°ç”¨æˆ¶è¨»å†Š**
   - è¨»å†Šæ–°å¸³è™Ÿ
   - æª¢æŸ¥æ˜¯å¦æ­£å¸¸ç²å¾— 300 é»è¨»å†Šçå‹µ
   - æª¢æŸ¥å´é‚Šæ¬„ç©åˆ†é¡¯ç¤º

2. **æ¸¬è©¦ç”¨æˆ¶ç™»å…¥**
   - ç™»å‡ºå¾Œé‡æ–°ç™»å…¥
   - æª¢æŸ¥ç©åˆ†æ˜¯å¦æ­£ç¢ºé¡¯ç¤º
   - æª¢æŸ¥ loading ç‹€æ…‹æ˜¯å¦æ­£å¸¸

3. **æ¸¬è©¦ç”¨æˆ¶ç™»å‡º**
   - ç™»å‡º
   - æª¢æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰æ¸…ç†ç›£è½å™¨çš„æ—¥èªŒ
   - æª¢æŸ¥æ˜¯å¦æœ‰å…§å­˜æ´©æ¼è­¦å‘Š

---

#### **éšæ®µ 3ï¼šæ¸¬è©¦æ‰€æœ‰ç©åˆ†æ¶ˆè€—å ´æ™¯**

1. **æœå°‹åˆ¤æ±ºæ›¸**ï¼ˆ1 é»ï¼‰
   - åŸ·è¡Œæœå°‹
   - è§€å¯Ÿå´é‚Šæ¬„ç©åˆ†æ˜¯å¦ç«‹å³æ¸›å°‘
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

2. **æ³•å®˜ AI åˆ†æ**ï¼ˆ3 é»ï¼‰
   - æŸ¥è©¢æ³•å®˜
   - è§€å¯Ÿç©åˆ†è®ŠåŒ–
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

3. **AI å‹è¨´åˆ†æ**ï¼ˆ5 é»ï¼‰
   - åŸ·è¡Œ AI åˆ†æ
   - è§€å¯Ÿç©åˆ†è®ŠåŒ–
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

4. **å…¶ä»–åŠŸèƒ½**
   - éš¨æ©Ÿæ¸¬è©¦ 3-5 å€‹å…¶ä»–ç©åˆ†æ¶ˆè€—åŠŸèƒ½
   - ç¢ºä¿éƒ½èƒ½ç«‹å³æ›´æ–°

---

#### **éšæ®µ 4ï¼šæ¸¬è©¦æ‰€æœ‰ç©åˆ†å¢åŠ å ´æ™¯**

1. **æ–°æ‰‹ä»»å‹™çå‹µ**ï¼ˆ100 é»ï¼‰
   - å®Œæˆæ‰€æœ‰ 5 å€‹æ–°æ‰‹ä»»å‹™
   - é»æ“Šã€Œé ˜å–ç©åˆ†ã€
   - è§€å¯Ÿå´é‚Šæ¬„ç©åˆ†æ˜¯å¦ç«‹å³å¢åŠ 
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

2. **è¨‚é–±å‡ç´š**ï¼ˆè®Šå‹•ï¼‰
   - æ¸¬è©¦è¨‚é–±å‡ç´šæµç¨‹
   - è§€å¯Ÿç©åˆ†è®ŠåŒ–
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

3. **è³¼è²·ç©åˆ†åŒ…**ï¼ˆ20-3000 é»ï¼‰
   - æ¸¬è©¦è³¼è²·ç©åˆ†åŒ…æµç¨‹
   - è§€å¯Ÿç©åˆ†è®ŠåŒ–
   - é æœŸï¼š< 1 ç§’å…§æ›´æ–°

---

#### **éšæ®µ 5ï¼šæ¸¬è©¦å¤šè¦–çª—åŒæ­¥**

1. **æ‰“é–‹å…©å€‹ç€è¦½å™¨è¦–çª—**
   - è¦–çª— A å’Œè¦–çª— B éƒ½ç™»å…¥åŒä¸€å¸³è™Ÿ

2. **åœ¨è¦–çª— A åŸ·è¡Œæ“ä½œ**
   - æœå°‹åˆ¤æ±ºæ›¸ï¼ˆæ‰£é™¤ 1 é»ï¼‰
   - è§€å¯Ÿè¦–çª— B çš„ç©åˆ†æ˜¯å¦åŒæ­¥æ›´æ–°
   - é æœŸï¼š< 1 ç§’å…§åŒæ­¥

3. **åœ¨è¦–çª— B åŸ·è¡Œæ“ä½œ**
   - é ˜å–æ–°æ‰‹ä»»å‹™çå‹µï¼ˆå¢åŠ  100 é»ï¼‰
   - è§€å¯Ÿè¦–çª— A çš„ç©åˆ†æ˜¯å¦åŒæ­¥æ›´æ–°
   - é æœŸï¼š< 1 ç§’å…§åŒæ­¥

---

### âš ï¸ æ½›åœ¨é¢¨éšªå’Œç·©è§£æªæ–½

| é¢¨éšª | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|---------|
| **é¦–æ¬¡ç™»å…¥ loading ç‹€æ…‹ç•°å¸¸** | ç”¨æˆ¶çœ‹åˆ°é•·æ™‚é–“ loading | åœ¨ `onSnapshot` å›èª¿ä¸­æ­£ç¢ºè¨­ç½® `setLoading(false)` |
| **Firestore ç›£è½å™¨æœªæ¸…ç†** | å…§å­˜æ´©æ¼ | åœ¨ `useEffect` æ¸…ç†å‡½æ•¸ä¸­æ­£ç¢ºæ¸…ç† |
| **å¤šæ¬¡è§¸ç™¼ setCurrentUser** | ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“ | React æœƒè‡ªå‹•æ‰¹è™•ç†æ›´æ–°ï¼Œå½±éŸ¿æ¥µå° |
| **onSnapshot éŒ¯èª¤æœªè™•ç†** | ç”¨æˆ¶ç„¡æ³•ç™»å…¥ | æ·»åŠ éŒ¯èª¤è™•ç†å›èª¿ï¼Œè¨˜éŒ„éŒ¯èª¤ä¸¦è¨­ç½® loading ç‚º false |

---

## ğŸ‰ é æœŸæ•ˆæœ

### âœ… ç”¨æˆ¶é«”é©—æå‡

| å ´æ™¯ | ç•¶å‰é«”é©— | ä¿®æ”¹å¾Œé«”é©— | æ”¹å–„ |
|------|---------|-----------|------|
| **æœå°‹åˆ¤æ±ºæ›¸** | ç©åˆ†ä¸è®Šï¼Œéœ€é‡æ–°æ•´ç† | ç©åˆ†ç«‹å³æ¸›å°‘ | âš¡ å¿« 5+ ç§’ |
| **é ˜å–çå‹µ** | ç©åˆ†ä¸è®Šï¼Œéœ€é‡æ–°æ•´ç† | ç©åˆ†ç«‹å³å¢åŠ  | âš¡ å¿« 5+ ç§’ |
| **è¨‚é–±å‡ç´š** | ç©åˆ†ä¸è®Šï¼Œéœ€é‡æ–°æ•´ç† | ç©åˆ†ç«‹å³å¢åŠ  | âš¡ å¿« 5+ ç§’ |
| **è³¼è²·ç©åˆ†åŒ…** | ç©åˆ†ä¸è®Šï¼Œéœ€é‡æ–°æ•´ç† | ç©åˆ†ç«‹å³å¢åŠ  | âš¡ å¿« 5+ ç§’ |
| **å¤šè¦–çª—ä½¿ç”¨** | ä¸åŒæ­¥ | è‡ªå‹•åŒæ­¥ | âœ… æ–°åŠŸèƒ½ |

---

## ğŸ“Š ç¸½çµ

### âœ… å„ªå‹¢

1. **å®Œå…¨è‡ªå‹•åŒ–** - ä»»ä½•ç©åˆ†è®ŠåŒ–éƒ½æœƒç«‹å³åæ˜ 
2. **æ¶æ§‹ä¸€è‡´** - èˆ‡ GiftBox ä½¿ç”¨ç›¸åŒçš„ `onSnapshot` æ¨¡å¼
3. **ä¸€æ¬¡ä¿®æ”¹ï¼Œå…¨å±€å—ç›Š** - æ‰€æœ‰ä½¿ç”¨ `currentUser.credits` çš„åœ°æ–¹éƒ½æœƒè‡ªå‹•æ›´æ–°
4. **æ”¯æŒå¤šè¦–çª—åŒæ­¥** - ç”¨æˆ¶åœ¨å¤šå€‹æ¨™ç±¤é éƒ½èƒ½çœ‹åˆ°å¯¦æ™‚è®ŠåŒ–
5. **æœªä¾†æ“´å±•æ€§å¥½** - ä»»ä½•æ–°çš„ç©åˆ†åŠŸèƒ½éƒ½æœƒè‡ªå‹•æ”¯æŒå¯¦æ™‚æ›´æ–°
6. **æ€§èƒ½å½±éŸ¿æ¥µå°** - åªå¢åŠ  1 å€‹ Firestore ç›£è½å™¨

### âš ï¸ æ³¨æ„äº‹é …

1. **éœ€è¦ä»”ç´°æ¸¬è©¦ç™»å…¥/ç™»å‡ºæµç¨‹**
2. **éœ€è¦ç¢ºä¿ Firestore ç›£è½å™¨æ­£ç¢ºæ¸…ç†**
3. **éœ€è¦æ¸¬è©¦æ‰€æœ‰ç©åˆ†æ¶ˆè€—å’Œå¢åŠ å ´æ™¯**ï¼ˆå…± 24+ å€‹å ´æ™¯ï¼‰
4. **éœ€è¦æ¸¬è©¦å¤šè¦–çª—åŒæ­¥åŠŸèƒ½**

### ğŸ¯ æ¨è–¦

**å¼·çƒˆæ¨è–¦å¯¦ä½œæ­¤æ–¹æ¡ˆï¼**

é€™æ˜¯æœ€ç¬¦åˆç¾ä»£åŒ–æ‡‰ç”¨æ¨™æº–çš„è§£æ±ºæ–¹æ¡ˆï¼Œèˆ‡ GiftBox æ¶æ§‹å®Œå…¨ä¸€è‡´ï¼Œä¸€å‹æ°¸é€¸åœ°è§£æ±ºç©åˆ†å¯¦æ™‚æ›´æ–°å•é¡Œã€‚

---

## ğŸ“… å¯¦ä½œæ™‚é–“è¡¨

| éšæ®µ | é ä¼°æ™‚é–“ | è² è²¬äºº |
|------|---------|--------|
| **éšæ®µ 1ï¼šä¿®æ”¹ä»£ç¢¼** | 30 åˆ†é˜ | é–‹ç™¼è€… |
| **éšæ®µ 2ï¼šæ¸¬è©¦ç™»å…¥/ç™»å‡º** | 15 åˆ†é˜ | é–‹ç™¼è€… |
| **éšæ®µ 3ï¼šæ¸¬è©¦ç©åˆ†æ¶ˆè€—** | 30 åˆ†é˜ | é–‹ç™¼è€… + QA |
| **éšæ®µ 4ï¼šæ¸¬è©¦ç©åˆ†å¢åŠ ** | 30 åˆ†é˜ | é–‹ç™¼è€… + QA |
| **éšæ®µ 5ï¼šæ¸¬è©¦å¤šè¦–çª—åŒæ­¥** | 15 åˆ†é˜ | QA |
| **ç¸½è¨ˆ** | **2 å°æ™‚** | - |

---

## ğŸš€ æº–å‚™é–‹å§‹å¯¦ä½œï¼

**ä¸‹ä¸€æ­¥**ï¼šé–‹å§‹ä¿®æ”¹ `src/AuthContext.js`

---

**æ–‡æª”ç‰ˆæœ¬**ï¼šv1.0  
**å‰µå»ºæ—¥æœŸ**ï¼š2025-01-23  
**æœ€å¾Œæ›´æ–°**ï¼š2025-01-23  
**ç‹€æ…‹**ï¼šå¾…å¯¦ä½œ

