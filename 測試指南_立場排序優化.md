# 測試指南：立場排序優化

## 🧪 測試目標

驗證立場排序優化是否正確實施，確保：
1. ✅ 勝訴案例排在前面
2. ✅ 敗訴案例排在後面
3. ✅ 勝負加權分數正確計算
4. ✅ 日誌輸出正確

---

## 📋 測試前準備

### **1. 重啟後端服務**
```bash
cd D:\court_data\courtDataAPI
npm start
```

### **2. 打開瀏覽器開發者工具**
- 按 F12 打開開發者工具
- 切換到 Console 標籤
- 切換到 Network 標籤

---

## 🧪 測試案例

### **測試 1: 原告立場排序**

#### **測試步驟**
1. 打開案由搜索頁面
2. 輸入案情描述（例如：「我與房東簽訂租賃契約，但房東未依約修繕房屋，導致我無法正常使用，我想要求解除契約並請求損害賠償」）
3. 選擇案件類型：**民事**
4. 選擇立場：**原告立場**
5. 點擊搜索

#### **預期結果**

**後端日誌**:
```bash
[CaseDescriptionSearch] 根據立場排序: plaintiff
[CaseDescriptionSearch] 勝負分布: 勝訴 X 筆, 部分勝訴 Y 筆, 敗訴 Z 筆
```

**前端顯示**:
- ✅ 第 1-3 筆結果：原告勝訴案例（勝負標籤顯示「完全勝訴」、「實質勝訴」等）
- ✅ 中間結果：部分勝訴案例
- ✅ 後面結果：原告敗訴案例（勝負標籤顯示「實質敗訴」、「完全敗訴」等）

**Network 檢查**:
1. 打開 Network 標籤
2. 找到 `/api/case-description-search` 請求
3. 查看 Response
4. 確認每筆結果包含 `victory_bonus` 欄位
5. 確認 `victory_bonus` 值在 0.0 - 1.0 之間

**範例 Response**:
```json
{
  "success": true,
  "results": [
    {
      "id": "TPDV,111,訴,123",
      "title": "...",
      "victory_bonus": 0.8,  // ✅ 實質勝訴
      "final_score": 0.75,
      "caseDescriptionScores": {
        "semantic_score": "0.85",
        "law_alignment_score": 0.7,
        "perspective_similarity": "0.72",
        "victory_bonus": "0.80",  // ✅ 勝負加權分數
        "final_score": "0.75"
      }
    }
  ]
}
```

---

### **測試 2: 被告立場排序**

#### **測試步驟**
1. 使用相同的案情描述
2. 選擇案件類型：**民事**
3. 選擇立場：**被告立場**
4. 點擊搜索

#### **預期結果**

**後端日誌**:
```bash
[CaseDescriptionSearch] 根據立場排序: defendant
[CaseDescriptionSearch] 勝負分布: 勝訴 X 筆, 部分勝訴 Y 筆, 敗訴 Z 筆
```

**前端顯示**:
- ✅ 第 1-3 筆結果：被告勝訴案例（勝負標籤顯示被告「完全勝訴」、「實質勝訴」等）
- ✅ 中間結果：部分勝訴案例
- ✅ 後面結果：被告敗訴案例（勝負標籤顯示被告「實質敗訴」、「完全敗訴」等）

**對比測試 1**:
- ✅ 排序結果應該不同（原告勝訴 vs 被告勝訴）
- ✅ `victory_bonus` 值應該不同（基於不同的 perspective）

---

### **測試 3: 換頁功能**

#### **測試步驟**
1. 執行測試 1 或測試 2
2. 點擊「下一頁」
3. 檢查第 2 頁的結果

#### **預期結果**

**前端顯示**:
- ✅ 第 2 頁結果仍然包含勝負標籤
- ✅ 排序仍然正確（勝訴案例在前）

**Network 檢查**:
1. 找到 `/case-description-search/batch-get-judgments` 請求
2. 查看 Response
3. 確認每筆結果包含 `victory_bonus` 欄位

---

### **測試 4: 勝負加權分數驗證**

#### **測試步驟**
1. 執行測試 1
2. 檢查前 5 筆結果的 `victory_bonus` 值
3. 對照勝負標籤

#### **預期結果**

| 勝負標籤 | victory_bonus | 說明 |
|---------|---------------|------|
| 完全勝訴 | 1.0 | major_victory |
| 實質勝訴 | 0.8 | substantial_victory |
| 形式勝訴 | 0.6 | minor_victory |
| 部分勝訴 | 0.4 | partial_success |
| 形式敗訴 | 0.2 | minor_defeat |
| 實質敗訴 | 0.1 | substantial_defeat |
| 完全敗訴 | 0.0 | major_defeat |

**驗證方法**:
```javascript
// 在瀏覽器 Console 執行
const results = /* 從 Network 複製 Response */;
results.results.forEach(r => {
    console.log(`${r.title}: victory_bonus=${r.victory_bonus}`);
});
```

---

### **測試 5: 排序效果驗證**

#### **測試步驟**
1. 執行測試 1（原告立場）
2. 記錄前 10 筆結果的 `victory_bonus` 值
3. 驗證排序是否正確

#### **預期結果**

**排序規則**:
- ✅ `final_score` 由高到低排序
- ✅ `victory_bonus` 高的案例，`final_score` 也應該較高
- ✅ 前 5 筆結果的 `victory_bonus` 應該 >= 0.6（勝訴案例）

**驗證方法**:
```javascript
// 在瀏覽器 Console 執行
const results = /* 從 Network 複製 Response */;
const top5 = results.results.slice(0, 5);
const victoryCount = top5.filter(r => r.victory_bonus >= 0.6).length;
console.log(`前 5 筆中有 ${victoryCount} 筆勝訴案例`);
// 預期: victoryCount >= 3
```

---

## 📊 測試檢查清單

### **後端檢查**
- [ ] 後端服務正常啟動
- [ ] 日誌顯示「根據立場排序」
- [ ] 日誌顯示「勝負分布」
- [ ] 無錯誤日誌

### **前端檢查**
- [ ] 搜索結果正常顯示
- [ ] 勝負標籤正常顯示
- [ ] 排序符合預期（勝訴在前）
- [ ] 換頁功能正常

### **數據檢查**
- [ ] Response 包含 `victory_bonus` 欄位
- [ ] `victory_bonus` 值在 0.0 - 1.0 之間
- [ ] `caseDescriptionScores.victory_bonus` 正確格式化
- [ ] `final_score` 計算正確

### **排序檢查**
- [ ] 原告立場：原告勝訴案例排在前面
- [ ] 被告立場：被告勝訴案例排在前面
- [ ] 敗訴案例排在後面
- [ ] 部分勝訴案例居中

---

## 🐛 常見問題排查

### **問題 1: 勝負標籤不顯示**

**可能原因**:
- `position_based_analysis` 欄位缺失

**排查方法**:
1. 檢查 Network Response
2. 確認 `position_based_analysis` 欄位存在
3. 檢查後端日誌是否有錯誤

**解決方案**:
- 確認後端已包含 `position_based_analysis` 欄位（已在優化 2 中修復）

---

### **問題 2: victory_bonus 為 undefined**

**可能原因**:
- 後端未正確計算 `victory_bonus`
- 前端未正確接收 `victory_bonus`

**排查方法**:
1. 檢查後端日誌
2. 檢查 Network Response
3. 檢查前端 Console 是否有錯誤

**解決方案**:
- 確認後端 `rankByPerspective()` 函數正確實施
- 確認前端 `batchGetJudgments()` 函數正確接收

---

### **問題 3: 排序不符合預期**

**可能原因**:
- 權重計算錯誤
- `victory_bonus` 計算錯誤

**排查方法**:
1. 檢查後端日誌中的「勝負分布」
2. 檢查 `victory_bonus` 值是否正確
3. 檢查 `final_score` 計算公式

**解決方案**:
- 驗證 `calculateVictoryBonus()` 函數
- 驗證 `rankByPerspective()` 函數的權重計算

---

### **問題 4: 日誌未顯示勝負分布**

**可能原因**:
- 後端代碼未正確實施
- 日誌級別設置問題

**排查方法**:
1. 檢查後端代碼
2. 確認 `console.log` 語句存在
3. 檢查日誌輸出

**解決方案**:
- 確認 `rankByPerspective()` 函數末尾的日誌語句

---

## ✅ 測試通過標準

### **必須通過**
1. ✅ 原告立場：原告勝訴案例排在前 5 筆
2. ✅ 被告立場：被告勝訴案例排在前 5 筆
3. ✅ `victory_bonus` 欄位存在且值正確
4. ✅ 日誌顯示勝負分布
5. ✅ 換頁功能正常

### **建議通過**
1. ✅ 前 5 筆中至少 3 筆為勝訴案例
2. ✅ 勝負標籤與 `victory_bonus` 值對應
3. ✅ 排序穩定（多次搜索結果一致）

---

## 📝 測試報告模板

```markdown
# 立場排序優化測試報告

## 測試時間
YYYY-MM-DD HH:MM

## 測試環境
- 後端版本: 
- 前端版本: 
- 瀏覽器: 

## 測試結果

### 測試 1: 原告立場排序
- [ ] 通過 / [ ] 失敗
- 備註: 

### 測試 2: 被告立場排序
- [ ] 通過 / [ ] 失敗
- 備註: 

### 測試 3: 換頁功能
- [ ] 通過 / [ ] 失敗
- 備註: 

### 測試 4: 勝負加權分數驗證
- [ ] 通過 / [ ] 失敗
- 備註: 

### 測試 5: 排序效果驗證
- [ ] 通過 / [ ] 失敗
- 備註: 

## 問題記錄
1. 
2. 

## 總結
- 測試通過率: X/5
- 是否可以部署: [ ] 是 / [ ] 否
```

---

**測試狀態**: ⏳ **待執行**  
**預期耗時**: 15-20 分鐘

