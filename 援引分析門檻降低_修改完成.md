# 援引分析門檻降低 - 修改完成

**修改時間**: 2025-10-12
**修改文件**: `services/citationAnalysisService.js`
**目的**: 降低援引分析的篩選門檻，讓更多援引判例能夠被推薦

---

## ✅ **修改總結**

我已經降低了援引分析的篩選門檻，預期可以從 40 筆判決書中找出 **3-8 個援引判例**（原本只有 1 個）。

---

## 📝 **詳細修改**

### **修改 1: 降低價值評估門檻** (Line 1534-1554)

**位置**: `analyzeCitationsFromCasePool()` 函數

**修改前**:
```javascript
// 3. 篩選高價值援引（總分 >= 40 或在法院見解內被引用）
const valuableCitations = enrichedCitations.filter(citation =>
    citation.valueAssessment.totalScore >= 40 ||
    citation.inCourtInsightCount > 0
);
```

**修改後**:
```javascript
// 3. 篩選高價值援引（降低門檻以獲得更多推薦）
// ✅ 修改：降低總分門檻從 40 → 30，並增加更多篩選條件
const valuableCitations = enrichedCitations.filter(citation => {
    const score = citation.valueAssessment.totalScore;
    const inCourtInsight = citation.inCourtInsightCount > 0;
    const usageCount = citation.usageCount;
    
    // 條件 1: 總分 >= 30（降低門檻）
    if (score >= 30) return true;
    
    // 條件 2: 在法院見解內被引用（高價值）
    if (inCourtInsight) return true;
    
    // 條件 3: 使用次數 >= 2（多次使用表示重要）
    if (usageCount >= 2) return true;
    
    // 條件 4: 稀有度高（rareness >= 25）且至少被使用 1 次
    if (citation.valueAssessment.breakdown.rareness >= 25 && usageCount >= 1) return true;
    
    return false;
});
```

**效果**:
- ✅ 總分門檻從 40 降低到 30
- ✅ 增加多次使用條件（使用次數 >= 2）
- ✅ 增加稀有度條件（稀有度 >= 25 且使用次數 >= 1）
- ✅ 保留法院見解內引用條件

---

### **修改 2: 增加 Mini 初篩處理數量** (Line 257-259)

**位置**: `miniQuickScreening()` 函數

**修改前**:
```javascript
// 準備援引數據（包含上下文摘要）
const citationsWithContext = valuableCitations.slice(0, 20).map(citation => {
```

**修改後**:
```javascript
// 準備援引數據（包含上下文摘要）
// ✅ 修改：增加處理數量從 20 → 30
const citationsWithContext = valuableCitations.slice(0, 30).map(citation => {
```

**效果**:
- ✅ Mini 初篩處理的援引數量從 20 增加到 30

---

### **修改 3: 增加 Mini 初篩選擇數量** (Line 295-298)

**位置**: `miniQuickScreening()` 函數的 Prompt

**修改前**:
```javascript
請快速評估每個援引是否可能與案件相關，標準要寬鬆：
1. 可能相關就選擇（不確定也選）
2. 明顯無關才排除
3. 最多選擇15個，最少選擇5個
```

**修改後**:
```javascript
請快速評估每個援引是否可能與案件相關，標準要寬鬆：
1. 可能相關就選擇（不確定也選）
2. 明顯無關才排除
3. 最多選擇20個，最少選擇8個（✅ 修改：增加選擇數量）
```

**效果**:
- ✅ Mini 初篩最多選擇數量從 15 增加到 20
- ✅ Mini 初篩最少選擇數量從 5 增加到 8

---

## 📊 **修改前後對比**

### **修改前**

**篩選流程**:
1. 價值評估門檻：總分 >= 40 或在法院見解內被引用
2. Mini 初篩處理：前 20 個援引
3. Mini 初篩選擇：5-15 個援引
4. GPT-4o 驗證：finalScore >= 4
5. 深度分析：所有通過驗證的援引

**結果**: 從 40 筆判決書中只找出 1 個援引判例

---

### **修改後**

**篩選流程**:
1. **價值評估門檻**（✅ 已降低）:
   - 總分 >= 30（降低 10 分）
   - 或在法院見解內被引用
   - 或使用次數 >= 2
   - 或稀有度 >= 25 且使用次數 >= 1

2. **Mini 初篩處理**（✅ 已增加）:
   - 前 30 個援引（增加 10 個）

3. **Mini 初篩選擇**（✅ 已增加）:
   - 8-20 個援引（原本 5-15 個）

4. **GPT-4o 驗證**（未修改）:
   - finalScore >= 4

5. **深度分析**（未修改）:
   - 所有通過驗證的援引

**預期結果**: 從 40 筆判決書中找出 **3-8 個援引判例**

---

## 🎯 **修改邏輯說明**

### **為什麼降低門檻？**

1. **原始門檻過高**:
   - 總分 >= 40 相當於 B 級實用以上
   - 在小樣本（40 筆判決書）中，很難找到高分援引

2. **增加篩選條件**:
   - 多次使用（usageCount >= 2）表示援引重要性
   - 稀有度高（rareness >= 25）表示援引獨特性
   - 這些條件可以補充總分不足的問題

3. **保持品質控制**:
   - GPT-4o 驗證階段仍然保持 finalScore >= 4 的高標準
   - 深度分析階段會提供詳細的使用建議和風險提示

---

### **為什麼增加 Mini 初篩數量？**

1. **處理更多候選援引**:
   - 從 20 增加到 30，讓 Mini 有更多選擇

2. **選擇更多援引進入驗證**:
   - 從 5-15 增加到 8-20，讓更多援引有機會通過驗證

3. **不影響最終品質**:
   - GPT-4o 驗證階段會嚴格把關
   - 只有真正相關的援引才會被推薦

---

## 🧪 **測試建議**

### **測試步驟**

1. **重啟後端服務**:
   ```bash
   cd d:\court_data\courtDataAPI
   npm start
   ```

2. **清除瀏覽器緩存**（Ctrl+F5）

3. **執行案件有利判決分析**

4. **點擊「相關援引判例」按鈕**

5. **等待援引分析完成**

6. **檢查推薦的援引數量**

---

### **預期結果**

**修改前**:
- ❌ 從 40 筆判決書中只找出 1 個援引判例

**修改後**:
- ✅ 從 40 筆判決書中找出 3-8 個援引判例
- ✅ 援引判例品質仍然保持高標準（經過 GPT-4o 驗證）
- ✅ 提供更多選擇給律師

---

### **檢查後端 LOG**

**預期 LOG**:
```
[analyzeCitationsFromCasePool] 篩選出 X 個高價值援引，開始上下文分析...
[miniQuickScreening] ✅ Mini 篩選完成：Y/X 個援引通過初篩
[strictVerificationWith4o] 🛡️ GPT-4o 開始嚴格驗證 Y 個援引
[strictVerificationWith4o] ✅ 驗證完成：Z 個援引通過驗證
[deepAnalysisVerifiedCitations] 🔍 開始深度分析 Z 個通過驗證的援引
```

**數量預期**:
- X（高價值援引）: 10-20 個（原本 5-10 個）
- Y（Mini 初篩通過）: 8-20 個（原本 5-15 個）
- Z（GPT-4o 驗證通過）: 3-8 個（原本 1-3 個）

---

## ⚠️ **注意事項**

### **1. 不要過度降低門檻**

- ✅ 當前修改已經平衡了數量和品質
- ⚠️ 如果再降低門檻，可能會推薦不相關的援引
- ⚠️ GPT-4o 驗證階段會過濾掉不相關的援引，但會增加 API 成本

---

### **2. 監控 API 成本**

- ✅ Mini 初篩使用 GPT-4o-mini（成本低）
- ⚠️ GPT-4o 驗證和深度分析使用 GPT-4o（成本高）
- ⚠️ 處理更多援引會增加 API 調用次數

---

### **3. 觀察實際效果**

- ✅ 測試多個案件，觀察推薦數量
- ✅ 檢查推薦品質是否符合預期
- ✅ 根據實際效果調整門檻

---

## 📈 **未來優化方向**

### **1. 動態門檻調整**

根據案例池大小動態調整門檻：
- 案例池 < 20 筆：降低門檻到 25 分
- 案例池 20-50 筆：使用當前門檻（30 分）
- 案例池 > 50 筆：提高門檻到 35 分

---

### **2. 智能篩選**

使用機器學習模型預測援引相關性：
- 訓練模型識別高價值援引
- 減少對 AI 的依賴
- 降低 API 成本

---

### **3. 用戶反饋機制**

收集律師對推薦援引的反饋：
- 記錄哪些援引被使用
- 記錄哪些援引被忽略
- 根據反饋調整篩選邏輯

---

## ✅ **總結**

### **修改內容**
- ✅ 降低價值評估門檻（40 → 30）
- ✅ 增加多次使用條件（usageCount >= 2）
- ✅ 增加稀有度條件（rareness >= 25）
- ✅ 增加 Mini 初篩處理數量（20 → 30）
- ✅ 增加 Mini 初篩選擇數量（5-15 → 8-20）

### **預期效果**
- ✅ 從 40 筆判決書中找出 3-8 個援引判例（原本 1 個）
- ✅ 保持高品質標準（經過 GPT-4o 驗證）
- ✅ 提供更多選擇給律師

### **下一步**
1. 重啟後端服務
2. 測試援引分析功能
3. 觀察推薦數量和品質
4. 根據實際效果調整門檻

---

**修改完成時間**: 2025-10-12
**修改人員**: Augment Agent
**狀態**: ✅ 修改完成，待測試驗證

