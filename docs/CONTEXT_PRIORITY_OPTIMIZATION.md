# 上下文優先級優化

## 📅 實施日期
2025-10-03

## 🎯 問題描述

### **發現的問題**

用戶問題: "分析法官的判決統計數據"
- 法官上下文: 黃麟捷
- Intent Classifier 提取: `question_type: "其他"`

**GPT 的錯誤回答**:
```
請提供您想要分析的法官姓名,以便我可以為您提供該法官在2025年6月至7月期間的判決統計數據。
```

**問題分析**:
- ❌ GPT 完全忽略了 System Prompt 中的法官上下文
- ❌ System Prompt 中明確說明 `法官姓名: 黃麟捷`
- ❌ GPT 仍然問用戶是哪位法官

---

## 🔍 根本原因

### **原因 1: 上下文位置不當**

**舊版本 System Prompt 結構**:
```
[基礎 Prompt - 約 2000 tokens]
  ↓
[大量範例 - 約 1500 tokens]
  ↓
[工具選擇策略 - 約 500 tokens]
  ↓
[關鍵規則 - 約 500 tokens]
  ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 **重要上下文 - 問題預處理結果**  ← 在最後面!
**法官姓名**: 黃麟捷
**問題類型**: 其他
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**問題**:
- 重要的上下文被埋在最後面
- GPT 的注意力機制優先關注前面的內容
- 當問題模糊時,GPT 可能直接匹配前面的範例,忽略後面的上下文

---

### **原因 2: 問題本身太模糊**

用戶問題: "分析法官的判決統計數據"
- 沒有明確的分析目標
- 沒有明確的法官名稱
- GPT 認為需要用戶澄清

**合理的行為**: GPT 應該說:
```
您想要分析黃麟捷法官的哪些統計數據? 例如:
- 勝訴率分析
- 案由分布
- 常引用法條
```

**實際行為**: GPT 說:
```
請提供您想要分析的法官姓名
```

---

## 💡 解決方案

### **方案 1: 將上下文移到 System Prompt 最前面** ✅

**新版本 System Prompt 結構**:
```
🔴 **當前對話上下文** (最高優先級 - 請優先閱讀)  ← 在最前面!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**當前查詢的法官**: 黃麟捷
**關鍵規則** (必須遵守):
1. 用戶問題中的「法官」都是指「黃麟捷」法官
2. 在**所有**工具調用中,必須使用 judge_name="黃麟捷"
3. **不要**問用戶是哪位法官,直接使用「黃麟捷」
4. 如果用戶問題模糊,提供具體的分析選項,但明確是針對「黃麟捷」法官
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ↓
[基礎 Prompt]
  ↓
[範例]
  ↓
[工具選擇策略]
```

**優勢**:
- ✅ GPT 首先看到最重要的資訊
- ✅ 明確標記 "最高優先級 - 請優先閱讀"
- ✅ 強調 "不要問用戶是哪位法官"

---

### **方案 2: 在用戶問題中明確注入法官名稱** ✅

**實施**:
```javascript
let enhancedQuestion = question;
if (judgeName && !question.includes(judgeName)) {
    enhancedQuestion = `[關於${judgeName}法官] ${question}`;
}
```

**範例**:
- 原始問題: "分析法官的判決統計數據"
- 增強後: "[關於黃麟捷法官] 分析法官的判決統計數據"

**優勢**:
- ✅ 雙重保險,確保 GPT 知道是在問黃麟捷法官
- ✅ 即使 System Prompt 被忽略,用戶問題中也有明確資訊

---

### **方案 3: 針對"其他"類型問題,提供明確建議** ✅

**實施**:
```javascript
if (questionType === '其他') {
    contextSection += `
**用戶問題較為模糊,建議**:
1. 先調用 analyze_judge(judge_name="${judgeName}") 獲取法官整體統計
2. 根據結果,向用戶提供具體的分析選項,例如:
   - "您想了解${judgeName}法官的勝訴率分析嗎?"
   - "您想了解${judgeName}法官常引用的法條嗎?"
   - "您想了解${judgeName}法官的案由分布嗎?"
3. **重要**: 在回答中明確提到是「${judgeName}法官」,不要問用戶是哪位法官
`;
}
```

**優勢**:
- ✅ 提供明確的工作流程
- ✅ 強調要在回答中提到法官名稱
- ✅ 明確禁止問用戶是哪位法官

---

## 🔧 實施細節

### **修改的文件**

**`controllers/ai-agent-controller.js`**

**修改 1**: 將上下文構建邏輯移到最前面
```javascript
// 🆕 動態構建 System Prompt (上下文優先,放在最前面)
let systemPrompt = '';

// 🔴 優先級最高: 將上下文放在最前面
if (judgeName || questionType) {
    let contextSection = `🔴 **當前對話上下文** (最高優先級 - 請優先閱讀)
...
`;
    // 🔴 將上下文放在最前面,然後加上基礎 Prompt
    systemPrompt = contextSection + SYSTEM_PROMPT;
} else {
    systemPrompt = SYSTEM_PROMPT;
}
```

**修改 2**: 增強用戶問題
```javascript
// 🆕 增強用戶問題,明確包含法官名稱 (雙重保險)
let enhancedQuestion = question;
if (judgeName && !question.includes(judgeName)) {
    enhancedQuestion = `[關於${judgeName}法官] ${question}`;
    console.log('[AI Agent] 🔴 增強用戶問題,明確包含法官名稱');
}

const messages = [
    { role: 'system', content: systemPrompt },
    ...conversation_history,
    { role: 'user', content: enhancedQuestion }
];
```

**修改 3**: 針對"其他"類型問題的建議
```javascript
if (questionType === '其他') {
    contextSection += `
**用戶問題較為模糊,建議**:
1. 先調用 analyze_judge(judge_name="${judgeName}") 獲取法官整體統計
2. 根據結果,向用戶提供具體的分析選項
3. **重要**: 在回答中明確提到是「${judgeName}法官」,不要問用戶是哪位法官
`;
}
```

---

## 📊 預期效果

### **場景: 用戶問 "分析法官的判決統計數據"**

**舊版本** (有問題):
```
GPT 回答: "請提供您想要分析的法官姓名"
```

**新版本** (已修復):
```
選項 1: GPT 直接調用 analyze_judge(judge_name="黃麟捷")
選項 2: GPT 回答: "您想了解黃麟捷法官的哪些統計數據? 例如:
  - 勝訴率分析
  - 案由分布
  - 常引用法條
  - 判決金額趨勢"
```

---

## ✅ 關鍵改進

1. ✅ **上下文優先級最高** (放在 System Prompt 最前面)
2. ✅ **明確標記** "最高優先級 - 請優先閱讀"
3. ✅ **用戶問題增強** (明確包含法官名稱)
4. ✅ **針對模糊問題的建議** (提供明確的工作流程)
5. ✅ **強調禁止行為** ("不要問用戶是哪位法官")

---

## 🧪 測試

**測試腳本**: `test-context-priority.js`

**測試結果**:
- ✅ 上下文位置: 最前面 (優先級最高)
- ✅ 用戶問題增強: `[關於黃麟捷法官] 分析法官的判決統計數據`
- ✅ 針對"其他"類型問題,提供明確建議

---

## 📝 後續建議

### 1. 監控實際效果
- 收集真實用戶問題的 GPT 回答
- 驗證 GPT 是否正確識別法官名稱
- 統計 GPT 問用戶是哪位法官的頻率

### 2. 進一步優化
- 如果效果仍不理想,考慮使用 OpenAI 的 `name` 參數
- 考慮簡化 System Prompt,移除不太重要的範例
- 考慮使用多個 `system` 消息,分離上下文和基礎 Prompt

### 3. A/B 測試
- 對比舊版本和新版本的效果
- 收集用戶反饋
- 根據數據調整策略

---

## 🎉 總結

成功實施了上下文優先級優化:

1. ✅ **將上下文移到最前面** - 確保 GPT 首先看到最重要的資訊
2. ✅ **增強用戶問題** - 雙重保險,明確包含法官名稱
3. ✅ **針對模糊問題的建議** - 提供明確的工作流程和禁止行為

**預期效果**: GPT 將能夠正確識別法官名稱,不再問用戶是哪位法官,而是提供針對該法官的具體分析選項或直接調用相關工具。

