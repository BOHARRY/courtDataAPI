# 建議類問題修正總結

## 問題描述

用戶報告：當詢問「我剛好有一個案件是關於返還不當得利的，明天開庭，法官就是王婉如法官，當事人是被告，你會建議我怎麼處理?」時，Intent Classifier 錯誤地將其分類為 `out_of_scope`，導致系統拒絕回答。

## 根本原因分析

### 問題 1: Intent Classifier 無法理解「隱含的查詢意圖」 ❌

**用戶的真實意圖**：
```
表面問題: "你會建議我怎麼處理?"
真實意圖: "王婉如法官在返還不當得利案件中，被告的勝訴率是多少？有哪些判決案例？法官的判決傾向是什麼？"
```

**Intent Classifier 的錯誤判斷**：
- 看到「你會建議我怎麼處理?」→ 認為是「法律諮詢」
- 看到「明天開庭」→ 認為是「未來案件」而非「判決分析」
- 看到「當事人是被告」→ 認為是「個人法律諮詢」
- 結論：`intent = "out_of_scope"` ❌

### 問題 2: System Prompt 缺少「訴訟策略查詢」的範例 ❌

當前的 System Prompt 只有：
- ✅ 勝訴率查詢
- ✅ 列表查詢
- ✅ 法條查詢
- ✅ 摘要查詢
- ❌ **缺少：訴訟策略/建議查詢**

### 問題 3: 守門條款過於嚴格 ❌

當前的規則無法區分：
- 「法律諮詢」（應拒絕）
- 「基於判決數據的分析」（應提供）

---

## 完整修正方案

### 修正 1: 添加新的 `question_type` ✅

**修正前**：
```javascript
"question_type": "勝訴率" | "列表" | "法條" | "判決傾向" | "金額" | "摘要" | "其他" | null
```

**修正後**：
```javascript
"question_type": "建議" | "摘要" | "勝訴率" | "金額" | "法條" | "判決傾向" | "列表" | "其他" | null
```

**說明**：
- 將「建議」放在最前面，強調其重要性
- 當用戶問「如何處理、該怎麼做、建議策略」時，標記為 `question_type="建議"`

---

### 修正 2: 更新 Intent Classifier 規則 ✅

**添加規則 6 和 7**：
```javascript
6. [重要] 若問題包含「怎麼處理」「你建議我」「該怎麼做」「勝算大嗎」「如何應對」等尋求建議的關鍵字，
   則標記為 intent=legal_analysis, question_type="建議"，並交給下游模組決定如何回覆

7. 不要因為問題帶有策略性或諮詢性質，就直接判為 out_of_scope；
   只要與法官判決分析相關，都應標為 legal_analysis
```

---

### 修正 3: 添加正樣例 ✅

**新增範例**：
```javascript
問題: "我剛好有一個案件是關於返還不當得利的，明天開庭，法官就是王婉如法官，當事人是被告，你會建議我怎麼處理?"
→ {"intent":"legal_analysis","question_type":"建議","case_type":"返還不當得利","verdict_type":null,"case_id":null}

問題: "我是原告，要對王婉如法官提起侵權訴訟，勝算大嗎?"
→ {"intent":"legal_analysis","question_type":"建議","case_type":"侵權","verdict_type":null,"case_id":null}

問題: "面對這個法官，我該怎麼準備?"
→ {"intent":"legal_analysis","question_type":"建議","case_type":null,"verdict_type":null,"case_id":null}
```

---

### 修正 4: 在 System Prompt（GPT 端）添加處理原則 ✅

**添加「建議類問題的處理原則」**：

#### **✅ 可以做的（基於數據的分析）**:
1. 提供法官在該案由的判決統計（勝訴率、敗訴率、部分勝訴率）
2. 分析法官常引用的法條和判決理由
3. 提供該案由的平均請求金額和獲准金額
4. 列舉相似案件的判決結果
5. 總結法官的判決傾向（如：重視證據類型、常見駁回理由等）

#### **❌ 不能做的（避免法律諮詢責任）**:
1. 不提供具體的訴訟策略建議（如「你應該這樣辯護」）
2. 不預測個案的判決結果（如「你一定會贏」）
3. 不提供法律意見（如「你應該主張XX權利」）
4. 不建議具體的證據準備方向（如「你應該準備XX證據」）

---

### 修正 5: 提供回答模板 ✅

**標準回答模板**：
```
根據 [法官姓名] 在 [案由] 案件中的判決數據（2025年6-7月）：

📊 判決結果統計：
- 原告勝訴率：XX%
- 被告勝訴率：XX%
- 部分勝訴部分敗訴：XX%

⚖️ 判決傾向：
- 常引用法條：民法第XX條、第YY條
- 重視的證據類型：...
- 常見駁回理由：...

💰 金額統計（如適用）：
- 平均請求金額：XX元
- 平均獲准金額：XX元
- 獲准比例：XX%

📋 相似案例：
[列舉2-3個相似案件]

⚠️ 重要提醒：
以上僅為該法官過去判決數據的統計分析，供您參考。本系統不提供法律建議或訴訟策略。具體案件處理請諮詢您的律師。
```

---

### 修正 6: 添加範例 11（建議類查詢） ✅

**在 System Prompt 中添加**：
```
範例 11: "我剛好有一個案件是關於返還不當得利的，明天開庭，法官就是王婉如法官，當事人是被告，你會建議我怎麼處理?"
步驟:
1. [重要] 識別出這是一個「建議」類查詢，用戶想了解法官在該案由的判決傾向
2. 調用 semantic_search_judgments (query="返還不當得利", judge_name="王婉如", limit=30, intended_analysis="deep_analysis")
3. 調用 calculate_verdict_statistics (judgments=結果) - 計算勝訴率統計
4. 調用 calculate_citation_frequency (judgments=結果) - 分析常引用法條
5. 生成回答（使用建議類回答模板）並添加免責聲明
```

---

## 修正效果對比

### 修正前 ❌

```
用戶: "我剛好有一個案件是關於返還不當得利的，明天開庭，法官就是王婉如法官，當事人是被告，你會建議我怎麼處理?"

Intent Classifier 返回:
{
  "intent": "out_of_scope",  // ❌ 錯誤！
  "question_type": null,
  "case_type": null,
  "verdict_type": null,
  "case_id": null
}

系統回應:
"抱歉,這裡是 **王婉如法官** 的檢索頁面,目前只能回答和 **王婉如法官判決內容** 相關的分析唷! 😊"
```

### 修正後 ✅

```
用戶: "我剛好有一個案件是關於返還不當得利的，明天開庭，法官就是王婉如法官，當事人是被告，你會建議我怎麼處理?"

Intent Classifier 返回:
{
  "intent": "legal_analysis",  // ✅ 正確！
  "question_type": "建議",      // ✅ 正確識別為建議類！
  "case_type": "返還不當得利",
  "verdict_type": null,
  "case_id": null
}

系統行為:
1. 識別為 legal_analysis + 建議，進入完整分析流程
2. 調用 semantic_search_judgments 獲取相關判決
3. 調用 calculate_verdict_statistics 計算勝訴率
4. 調用 calculate_citation_frequency 分析常引用法條
5. 生成基於數據的分析回答
6. 添加免責聲明

系統回應:
"根據王婉如法官在返還不當得利案件中的判決數據（2025年6-7月）：

📊 判決結果統計：
- 原告勝訴率：70%
- 被告勝訴率：20%
- 部分勝訴部分敗訴：10%

⚖️ 判決傾向：
- 常引用法條：民法第179條、第184條
- 重視的證據類型：契約文件、金流證明
- 常見駁回理由：證據不足、請求權時效

📋 相似案例：
1. PCDV,113,訴,XXX - 原告勝訴，判賠125萬元
2. PCDV,114,訴,YYY - 被告勝訴，駁回原告請求
...

⚠️ 重要提醒：
以上僅為該法官過去判決數據的統計分析，供您參考。本系統不提供法律建議或訴訟策略。具體案件處理請諮詢您的律師。"
```

---

## 測試驗證

### 測試結果 ✅

```
總測試數: 10
通過: 10 ✅
失敗: 0 ❌
通過率: 100.0%
```

### 測試案例

1. ✅ 訴訟策略建議（完整描述）
2. ✅ 勝算評估
3. ✅ 簡短建議請求
4. ✅ 處理方式詢問
5. ✅ 策略詢問
6. ✅ 應對方式
7. ✅ 勝訴率查詢（非建議）
8. ✅ 列表查詢（非建議）
9. ✅ 打招呼（非建議）
10. ✅ 超出範圍（非建議）

---

## 修正的檔案

1. ✅ `services/intentClassifier.js`
   - 更新 Schema（添加 question_type="建議"）
   - 添加規則 6 和 7
   - 添加正樣例

2. ✅ `utils/ai-agent-tools.js`
   - 添加建議類問題的處理原則
   - 添加回答模板
   - 添加範例 11

3. ✅ `test_intent_classifier_advice.js`
   - 測試腳本

4. ✅ `docs/ADVICE_QUESTION_FIX_SUMMARY.md`
   - 本文件

---

## 設計理念

### 1. 責任邊界清晰 ⚖️

**可以做**：基於歷史判決數據的統計分析
**不能做**：個案的法律建議和訴訟策略

### 2. 價值最大化 💎

雖然不能提供法律建議，但可以提供：
- 法官的判決傾向
- 相似案件的結果
- 常引用的法條
- 金額統計

這些資訊對律師和當事人都非常有價值！

### 3. 風險最小化 🛡️

通過免責聲明明確告知：
- 這只是數據分析
- 不構成法律建議
- 具體案件請諮詢律師

---

## 部署檢查清單

- [x] 修正 Intent Classifier Schema
- [x] 添加建議類識別規則
- [x] 添加正樣例
- [x] 添加處理原則
- [x] 添加回答模板
- [x] 添加範例 11
- [x] 本地測試通過
- [ ] 推送到 GitHub
- [ ] 部署到 Vercel
- [ ] 端到端測試

---

## 相關文件

- `test_intent_classifier_advice.js` - 測試腳本
- `ADVICE_QUESTION_FIX_SUMMARY.md` - 本文件
- `INTENT_CLASSIFIER_FIX_SUMMARY.md` - 案號查詢修正總結
- `AMOUNT_FIELD_FIX_SUMMARY.md` - 金額欄位修正總結
- `QUICK_DEPLOY_GUIDE.md` - 快速部署指南

---

**修正完成時間**: 2025-10-04  
**修正人員**: Augment Agent  
**問題報告人**: BOHARRY  
**特別感謝**: BOHARRY 提供的精準需求分析和設計方案

