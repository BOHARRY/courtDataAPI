# 語意搜尋功能測試指南

## 🎯 測試目標

驗證以下功能:
1. ✅ MCP Session 管理正常 (連續查詢不失敗)
2. ✅ 語意搜尋工具正常工作
3. ✅ 同義詞自動匹配
4. ✅ 口語化查詢理解
5. ✅ AI Agent 智能工具選擇

---

## 📋 測試清單

### 測試 1: 基礎查詢 (驗證 Session 初始化)

**問題**: "分析王婉如法官的判決傾向"

**預期結果**:
- ✅ AI Agent 調用 `analyze_judge` 工具
- ✅ 返回法官統計數據
- ✅ Session 初始化成功

**檢查點**:
- [ ] 查詢成功
- [ ] 返回判決數量、勝訴率等數據
- [ ] 後端日誌顯示 "MCP Session 初始化成功"

---

### 測試 2: 語意搜尋 - 同義詞匹配 (核心功能)

**問題**: "王婉如法官在債務清償案件的判決有什麼共通性?"

**預期結果**:
- ✅ AI Agent 調用 `semantic_search_judgments` 工具
- ✅ 自動匹配 "清償債務" 案由 (同義詞)
- ✅ 返回案件分析和共通性

**檢查點**:
- [ ] 查詢成功 (不出現 Session 錯誤)
- [ ] 找到相關案件 (包含 "清償債務")
- [ ] 返回勝訴率、常引用法條等分析
- [ ] 後端日誌顯示 "調用 MCP 工具: semantic_search_judgments"
- [ ] 如果第一次失敗,日誌顯示 "Session 錯誤,重新初始化並重試"

---

### 測試 3: 口語化查詢

**問題**: "王婉如法官對欠錢不還的案件怎麼判?"

**預期結果**:
- ✅ AI Agent 調用 `semantic_search_judgments`
- ✅ 理解 "欠錢不還" = 債務相關案件
- ✅ 返回判決傾向分析

**檢查點**:
- [ ] 查詢成功
- [ ] 匹配到債務相關案由 (清償債務、給付借款等)
- [ ] 返回勝訴率和判決傾向

---

### 測試 4: 複雜語意查詢

**問題**: "房東趕房客的案件,這位法官傾向如何?"

**預期結果**:
- ✅ AI Agent 調用 `semantic_search_judgments`
- ✅ 理解 "房東趕房客" = 返還房屋、遷讓房屋等
- ✅ 返回相關案件分析

**檢查點**:
- [ ] 查詢成功
- [ ] 匹配到房屋租賃相關案由
- [ ] 返回判決傾向

---

### 測試 5: 連續查詢 (Session 穩定性)

**問題序列**:
1. "分析王婉如法官的判決傾向"
2. "王婉如法官在債務清償案件的判決有什麼共通性?"
3. "原告勝訴的案件都有哪些共通性?"

**預期結果**:
- ✅ 所有查詢都成功
- ✅ 沒有 Session 錯誤
- ✅ 自動重試機制正常工作 (如果需要)

**檢查點**:
- [ ] 3 個查詢都成功
- [ ] 沒有出現 "No valid session ID" 錯誤
- [ ] 如果有重試,日誌清晰顯示

---

### 測試 6: 工具選擇智能性

**問題**: "車禍賠償案件在王婉如法官面前的勝訴率?"

**預期結果**:
- ✅ AI Agent 選擇 `semantic_search_judgments` (因為 "車禍賠償" 是口語化)
- ✅ 匹配到 "交通事故損害賠償" 等案由
- ✅ 調用 `calculate_verdict_statistics` 計算勝訴率

**檢查點**:
- [ ] 使用語意搜尋而非關鍵詞搜尋
- [ ] 匹配到交通相關案由
- [ ] 返回準確的勝訴率

---

## 🔍 後端日誌檢查

### 成功的日誌應該包含:

```
[AI Agent] 初始化 MCP Session...
[AI Agent] MCP Session 初始化成功: <session-id>
[AI Agent] 調用 MCP 工具: semantic_search_judgments { query: '債務清償', judge_name: '王婉如', limit: 50 }
[AI Agent] MCP 原始響應: data: {"jsonrpc":"2.0","id":...
[AI Agent] MCP 工具調用成功
```

### 如果有重試,應該看到:

```
[AI Agent] MCP Server 錯誤響應: Bad Request: No valid session ID provided
[AI Agent] Session 錯誤,重新初始化並重試 (1/2)...
[AI Agent] 初始化 MCP Session...
[AI Agent] MCP Session 初始化成功: <new-session-id>
[AI Agent] 調用 MCP 工具: semantic_search_judgments ...
[AI Agent] MCP 工具調用成功
```

---

## 📊 測試結果記錄

### 測試環境
- 前端: https://frontend-court-search-web.vercel.app/ai-agent-test
- 後端: https://courtdataapi.onrender.com
- MCP Server: https://esmcp.onrender.com

### 測試時間
- 日期: ___________
- 測試人員: ___________

### 測試結果

| 測試項目 | 狀態 | 備註 |
|---------|------|------|
| 測試 1: 基礎查詢 | ⬜ 通過 / ⬜ 失敗 | |
| 測試 2: 同義詞匹配 | ⬜ 通過 / ⬜ 失敗 | |
| 測試 3: 口語化查詢 | ⬜ 通過 / ⬜ 失敗 | |
| 測試 4: 複雜語意 | ⬜ 通過 / ⬜ 失敗 | |
| 測試 5: 連續查詢 | ⬜ 通過 / ⬜ 失敗 | |
| 測試 6: 工具選擇 | ⬜ 通過 / ⬜ 失敗 | |

---

## 🐛 常見問題排查

### 問題 1: Session 錯誤仍然出現

**症狀**: "No valid session ID provided"

**排查步驟**:
1. 檢查後端日誌,確認是否有重試
2. 檢查 MCP Server 是否正常運行
3. 檢查 Session 過期時間設置 (預設 5 分鐘)

**解決方案**:
- 如果重試失敗,可能是 MCP Server 問題
- 檢查 MCP Server 日誌
- 重啟 MCP Server

### 問題 2: 語意搜尋無結果

**症狀**: 返回 0 筆結果

**排查步驟**:
1. 檢查 OPENAI_API_KEY 是否設置
2. 檢查 Elasticsearch 向量索引是否存在
3. 檢查查詢文本是否合理

**解決方案**:
- 確認環境變數設置
- 檢查 ES mapping 中的 `summary_ai_vector` 欄位

### 問題 3: 工具選擇錯誤

**症狀**: AI 使用關鍵詞搜尋而非語意搜尋

**排查步驟**:
1. 檢查系統提示詞是否正確
2. 檢查工具定義是否完整

**解決方案**:
- 更新系統提示詞
- 添加更多範例

---

## ✅ 驗收標準

所有測試項目通過,且:
- [ ] 連續查詢成功率 > 95%
- [ ] 語意搜尋匹配準確率 > 90%
- [ ] 平均響應時間 < 3 秒
- [ ] 無未處理的錯誤

---

## 📝 測試報告模板

```
# 語意搜尋功能測試報告

## 測試概要
- 測試日期: YYYY-MM-DD
- 測試環境: 生產環境
- 測試人員: XXX

## 測試結果
- 總測試數: 6
- 通過數: X
- 失敗數: X
- 通過率: XX%

## 詳細結果
[填寫各測試項目的詳細結果]

## 發現的問題
[列出發現的問題和解決方案]

## 結論
[總結測試結果和建議]
```

---

## 🎉 測試完成後

如果所有測試通過:
1. ✅ 標記功能為 "生產就緒"
2. ✅ 更新用戶文檔
3. ✅ 通知團隊新功能上線
4. ✅ 開始監控使用數據

如果有測試失敗:
1. ❌ 記錄失敗詳情
2. ❌ 分析根本原因
3. ❌ 修復並重新測試
4. ❌ 更新測試文檔

