# Intent Classifier 簡化重構

## 📅 重構日期
2025-10-03

## 🎯 **核心理念**

> **相信 GPT 的判斷能力,給予大方向而非面面俱到的規則書**

---

## 🔴 **問題: 過度工程化**

### **之前的 Prompt (複雜版)**

**長度**: ~1000 tokens

**結構**:
```
1. 意圖分類 (4種)
   - legal_analysis
     - 包括: 詢問法官是否審理某類案件
     - 包括: 詢問法官審理的案件類型
     - 包括: 詢問特定案由的案件 (即使數據庫中可能沒有)
   - greeting
   - out_of_scope
     - 注意: 詢問法官審理的案件類型**不是** out_of_scope
   - unclear

2. 問題類型 (6種)
   - 勝訴率 - 詢問勝訴率、判決結果比例
   - 列表 - 列出判決書、案件
   - 法條 - 詢問常引用的法條
   - 判決傾向 - 詢問法官的判決傾向
   - 金額 - 詢問判決金額趨勢
   - 其他 - 其他法律分析問題

3. 案由提取規則
   - 例: "損害賠償", "交通", "返還不當得利", "債務清償" 等
   - 如果問題中沒有明確案由,填 null

4. 判決類型提取規則
   - "原告勝訴", "原告敗訴", "部分勝訴部分敗訴"
   - 如果問題中沒有明確判決類型,填 null

5. 對話上下文規則
   - 如果用戶問題是延續性問題 (如: "只有這些嗎?", "還有嗎?")...
   - 如果對話歷史中最近討論的是法官判決相關內容...
   - 代詞 ("這些", "那個", "它") 需要結合上下文理解

6. 範例 × 9
   - 範例 1: "王婉如法官在交通案件中的勝訴率?"
   - 範例 2: "損害賠償案件有哪些?"
   - 範例 3: "法官常引用哪些法條?"
   - 範例 4: "法官有沒有經手刑事案件?"
   - 範例 5: "法官審理過民事案件嗎?"
   - 範例 6: "法官有處理過交通事故的案子嗎?"
   - 範例 7: "你好"
   - 範例 8: "法官單身嗎?"
   - 範例 9: "法官幾歲?"
```

**問題**:
- ❌ 太複雜,GPT 難以消化
- ❌ 太僵化,失去彈性
- ❌ 永遠無法涵蓋所有情況
- ❌ 每次發現新問題就加新規則 → 惡性循環
- ❌ Token 消耗高 (~1000 tokens)

---

## ✅ **解決方案: 簡化重構**

### **現在的 Prompt (簡化版)**

**長度**: ~300 tokens (縮減 70%)

**結構**:
```javascript
你是一個意圖分類器。判斷用戶問題是否與「法官判決分析」相關。

**返回 JSON 格式**:
{
  "intent": "legal_analysis" | "greeting" | "out_of_scope" | "unclear",
  "question_type": "勝訴率" | "列表" | "法條" | "判決傾向" | "金額" | "其他" | null,
  "case_type": "案由關鍵字" | null,
  "verdict_type": "原告勝訴" | "原告敗訴" | "部分勝訴部分敗訴" | null
}

**意圖分類**:
- legal_analysis: 與法官判決、案件、勝訴率、法條等法律分析相關
- greeting: 打招呼、問候
- out_of_scope: 與法律分析無關 (如: 法官個人生活、天氣)
- unclear: 無法理解

**核心原則**:
- 詢問法官的判決、案件、勝訴率、法條、判決傾向 → legal_analysis
- 詢問法官的年齡、婚姻、外貌、個人生活 → out_of_scope
- 延續性問題 (如: "還有嗎?") 需結合對話歷史判斷

**範例**:
問題: "法官在交通案件中的勝訴率?" → {"intent":"legal_analysis",...}
問題: "法官有沒有經手刑事案件?" → {"intent":"legal_analysis",...}
問題: "你好" → {"intent":"greeting",...}
問題: "法官單身嗎?" → {"intent":"out_of_scope",...}

只返回 JSON,不要其他文字。
```

**優勢**:
- ✅ 簡潔明瞭 (~300 tokens)
- ✅ 給 GPT 判斷空間
- ✅ 保持彈性
- ✅ 易於維護
- ✅ Token 消耗低 (節省 70%)

---

## 📊 **對比**

| 項目 | 複雜版 | 簡化版 |
|------|--------|--------|
| **Token 數** | ~1000 | ~300 ✅ |
| **範例數量** | 9 個 | 4 個 ✅ |
| **規則數量** | 20+ 條 | 3 條 ✅ |
| **可讀性** | 難以閱讀 | 清晰易懂 ✅ |
| **維護性** | 難以維護 | 易於維護 ✅ |
| **彈性** | 僵化 | 靈活 ✅ |
| **GPT 理解** | 困難 | 容易 ✅ |

---

## 💡 **核心洞察**

### **錯誤的思維**
```
發現新問題 → 添加新規則 → 發現新問題 → 添加新規則 → ...
```

**結果**: Prompt 越來越長,越來越複雜,越來越難維護

---

### **正確的思維**
```
相信 GPT 的判斷能力
  ↓
給予大方向和核心原則
  ↓
提供少量代表性範例
  ↓
讓 GPT 自己推理
```

**結果**: Prompt 簡潔,靈活,易於維護

---

## 🎯 **設計原則**

### **1. 相信 GPT**
- GPT-4o-mini 已經足夠聰明
- 不需要手把手教它每一個細節
- 給予大方向,讓它自己推理

### **2. 核心原則 > 詳細規則**
- ❌ 錯誤: "包括: 詢問法官是否審理某類案件 (如: "法官有沒有經手刑事案件?")"
- ✅ 正確: "詢問法官的判決、案件、勝訴率、法條 → legal_analysis"

### **3. 少量代表性範例 > 大量窮舉**
- ❌ 錯誤: 9 個範例,試圖涵蓋所有情況
- ✅ 正確: 4 個代表性範例,展示核心區別

### **4. 簡潔 > 詳盡**
- ❌ 錯誤: 1000 tokens 的詳細說明
- ✅ 正確: 300 tokens 的核心原則

---

## 📈 **預期效果**

### **準確性**
- 複雜版: 可能因為規則太多而混淆
- 簡化版: 核心原則清晰,更容易理解

### **彈性**
- 複雜版: 僵化,無法處理未見過的問題
- 簡化版: 靈活,可以推理新問題

### **維護性**
- 複雜版: 每次發現新問題都要添加新規則
- 簡化版: 核心原則不變,無需頻繁修改

### **成本**
- 複雜版: ~1000 tokens × $0.15/1M = $0.00015 per request
- 簡化版: ~300 tokens × $0.15/1M = $0.000045 per request
- **節省**: 70%

---

## 🧪 **測試**

### **測試案例 1: 常見問題**
```
問題: "法官在損害賠償中的勝訴率?"
預期: legal_analysis, question_type: 勝訴率, case_type: 損害賠償
```

### **測試案例 2: 邊緣案例**
```
問題: "法官有沒有經手刑事案件?"
預期: legal_analysis, question_type: 列表, case_type: 刑事
```

### **測試案例 3: Out of Scope**
```
問題: "法官單身嗎?"
預期: out_of_scope
```

### **測試案例 4: 新問題 (未見過)**
```
問題: "法官處理過環保案件嗎?"
預期: legal_analysis, question_type: 列表, case_type: 環保
```

**關鍵**: 簡化版應該能夠正確處理**未見過的新問題**,因為它理解了核心原則,而不是死記硬背規則。

---

## 🎉 **總結**

### **核心改進**
1. ✅ **Token 縮減 70%** (1000 → 300)
2. ✅ **範例縮減 55%** (9 → 4)
3. ✅ **規則簡化** (20+ → 3)
4. ✅ **提升彈性** (僵化 → 靈活)
5. ✅ **易於維護** (複雜 → 簡潔)

### **核心理念**
> **相信 GPT 的判斷能力,給予大方向而非面面俱到的規則書**

### **設計原則**
1. 相信 GPT
2. 核心原則 > 詳細規則
3. 少量代表性範例 > 大量窮舉
4. 簡潔 > 詳盡

### **預期效果**
- 更高的準確性 (核心原則清晰)
- 更好的彈性 (可以處理新問題)
- 更低的成本 (Token 縮減 70%)
- 更易維護 (無需頻繁修改)

---

## 📝 **後續建議**

1. **監控準確性**
   - 收集真實用戶問題
   - 驗證分類準確性
   - 如果準確性下降,再考慮添加範例

2. **保持簡潔**
   - 抵制添加新規則的誘惑
   - 只在核心原則不清楚時才修改
   - 優先修改核心原則,而非添加新規則

3. **定期審查**
   - 每月審查一次 Prompt
   - 移除不必要的範例
   - 保持 Prompt 簡潔

---

**記住**: 人類的意圖是無法用正則表達式和一堆堆永無止盡的舉例去全面涵蓋的。相信 GPT,給予大方向,讓它自己推理! 🚀

