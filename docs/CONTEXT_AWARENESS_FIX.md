# 🎯 上下文感知優化記錄

## 📋 問題描述

### 發現的問題

**用戶場景**: 在王婉如法官的詳情頁面，提問「法官對於勝訴的案件，有什麼樣的共通性?」

**錯誤行為**:
```javascript
AI 調用: search_judgments({ 
  query: '*', 
  verdict_type: '原告勝訴', 
  limit: 100 
})
// ❌ 沒有 judge_name 參數!

結果: 返回所有法官的 1997 筆原告勝訴案件
```

**問題分析**:
1. ❌ AI 沒有識別到用戶在特定法官的頁面
2. ❌ 用戶問「法官」時，AI 理解為「所有法官」而非「王婉如法官」
3. ❌ 前端的上下文注入不夠明確
4. ❌ 後端的 System Prompt 沒有強調上下文感知

**預期行為**:
```javascript
AI 調用: search_judgments({ 
  query: '*', 
  judge_name: '王婉如',  // ✅ 應該加上法官名稱!
  verdict_type: '原告勝訴', 
  limit: 100 
})

結果: 返回王婉如法官的原告勝訴案件（約 7 筆）
```

---

## ✅ 解決方案

### 修改 1: 前端上下文注入優化

**文件**: `d:/court_data/frontend-court-search-web/lawsowl/src/components/judge/JudgeConversationPanelGreen.js`

**原本的上下文**:
```javascript
當前查詢的法官資訊：
- 法官姓名：王婉如
- 所屬法院：台灣新北地方法院
- 近三年案件數：19

用戶問題：法官對於勝訴的案件，有什麼樣的共通性?
```

**優化後的上下文**:
```javascript
⚠️ 重要上下文：用戶正在查詢特定法官的資訊，請務必針對這位法官進行分析。

當前查詢的法官：
- 法官姓名：王婉如
- 所屬法院：台灣新北地方法院
- 近三年案件數：19

⚠️ 如果用戶問題中提到「法官」、「這位法官」、「該法官」等詞，都是指「王婉如」法官。
⚠️ 請在所有工具調用中使用 judge_name="王婉如" 參數。

用戶問題：法官對於勝訴的案件，有什麼樣的共通性?
```

**改進點**:
1. ✅ 使用 ⚠️ emoji 強調重要性
2. ✅ 明確說明「法官」指的是「王婉如」
3. ✅ 直接指示要使用 judge_name 參數
4. ✅ 格式更清晰，更容易被 AI 識別

---

### 修改 2: 後端 System Prompt 優化

**文件**: `d:/court_data/courtDataAPI/utils/ai-agent-tools.js`

**新增工作流程步驟**:
```
**工作流程**:
1. 理解用戶問題
2. ⚠️ **檢查上下文** - 如果用戶問題中包含「當前查詢的法官」資訊,
   務必使用該法官名稱
3. 決定需要調用哪些工具
4. 先調用 MCP 工具獲取數據
5. 再調用本地函數處理數據
6. 生成自然語言回答
```

**新增重要提醒**:
```
**重要提醒 - 上下文感知**:
- 如果用戶問題開頭有「⚠️ 重要上下文：用戶正在查詢特定法官」,
  表示用戶在特定法官的頁面
- 此時用戶問題中的「法官」、「這位法官」、「該法官」都是指上下文中提到的法官
- 務必在所有工具調用中使用 judge_name 參數指定該法官
- 範例: 上下文說「當前查詢的法官：王婉如」,用戶問「法官的勝訴率?」
  → 調用工具時使用 judge_name="王婉如"
```

**新增範例 6**:
```
範例 6: "法官對於勝訴的案件，有什麼樣的共通性?" (帶上下文) ⭐ 重要範例
上下文:
⚠️ 重要上下文：用戶正在查詢特定法官的資訊
當前查詢的法官：王婉如

步驟:
1. ⚠️ 識別上下文 - 用戶問的是「王婉如法官」的勝訴案件
2. 調用 search_judgments (
     query="*", 
     judge_name="王婉如",  // ⚠️ 務必加上!
     verdict_type="原告勝訴", 
     limit=100
   )
3. 調用 calculate_case_type_distribution (judgments=結果, group_by="case_type")
4. 生成回答: "根據 2025年6-7月 的數據,王婉如法官在原告勝訴案件中,
   常見案由包括: XX、YY、ZZ..."
```

---

## 📊 預期效果

### 修改前
```
用戶在王婉如法官頁面問: "法官對於勝訴的案件，有什麼樣的共通性?"

AI 理解: 所有法官的勝訴案件

AI 調用:
search_judgments({ query: '*', verdict_type: '原告勝訴', limit: 100 })
→ 返回 1997 筆（所有法官）

AI 回答:
"根據數據，對於勝訴案件的共通性分析...
 常見案由包括: 清償債務、返還財產..." ❌
（這是所有法官的統計，不是王婉如法官的）
```

### 修改後
```
用戶在王婉如法官頁面問: "法官對於勝訴的案件，有什麼樣的共通性?"

前端注入上下文:
⚠️ 重要上下文：用戶正在查詢特定法官的資訊
當前查詢的法官：王婉如
⚠️ 如果用戶問題中提到「法官」，都是指「王婉如」法官

AI 理解: 王婉如法官的勝訴案件

AI 調用:
search_judgments({ 
  query: '*', 
  judge_name: '王婉如',  // ✅ 加上了!
  verdict_type: '原告勝訴', 
  limit: 100 
})
→ 返回 7 筆（王婉如法官的原告勝訴案件）

AI 回答:
"根據 2025年6-7月 的數據，王婉如法官在原告勝訴案件中，
 常見案由包括: 返還投資本金、返還信託財產、損害賠償..." ✅
（這是王婉如法官的統計）
```

---

## 🧪 測試計劃

### 測試案例 1: 勝訴案件共通性
```
場景: 在王婉如法官頁面
問題: "法官對於勝訴的案件，有什麼樣的共通性?"

預期:
- AI 調用 search_judgments 時加上 judge_name="王婉如"
- 返回約 7 筆案件（王婉如法官的原告勝訴案件）
- 回答中提到「王婉如法官」
- 案由統計符合王婉如法官的數據
```

### 測試案例 2: 敗訴案件分析
```
場景: 在王婉如法官頁面
問題: "法官對於敗訴的案件，有什麼特點?"

預期:
- AI 調用時加上 judge_name="王婉如"
- 返回王婉如法官的原告敗訴案件
- 回答針對王婉如法官
```

### 測試案例 3: 泛指問題
```
場景: 在王婉如法官頁面
問題: "這位法官的判決傾向如何?"

預期:
- AI 理解「這位法官」= 王婉如
- 調用 analyze_judge(judge_name="王婉如")
- 回答針對王婉如法官
```

### 測試案例 4: 對比測試（judge-mcp-demo）
```
場景: 在 judge-mcp-demo 頁面
問題: "法官對於勝訴的案件，有什麼樣的共通性?"

預期:
- 因為沒有上下文，AI 會查詢所有法官
- 返回 1997 筆案件
- 這是正確的行為（因為沒有指定法官）
```

---

## 🔍 技術細節

### 上下文注入時機

**第一次提問時注入**:
```javascript
if (messages.length === 1) {  // 只有歡迎消息
  contextualQuestion = `
    ⚠️ 重要上下文：...
    當前查詢的法官：${judgeName}
    ...
    用戶問題：${userQuestion}
  `.trim();
}
```

**後續提問不重複注入**:
- 對話歷史已經包含上下文
- AI 會記住當前查詢的法官
- 避免重複注入導致 token 浪費

### AI 識別上下文的關鍵

1. **⚠️ emoji**: 視覺上突出重要信息
2. **明確指示**: 「請務必針對這位法官」
3. **具體範例**: 「judge_name="王婉如"」
4. **重複強調**: 多次提到要使用 judge_name 參數

---

## ✅ 檢查清單

### 前端修改
- [x] 優化上下文注入格式
- [x] 添加 ⚠️ 強調標記
- [x] 明確指示使用 judge_name 參數

### 後端修改
- [x] 新增工作流程步驟（檢查上下文）
- [x] 新增重要提醒（上下文感知）
- [x] 新增範例 6（帶上下文的問題）

### 待測試
- [ ] 測試案例 1: 勝訴案件共通性
- [ ] 測試案例 2: 敗訴案件分析
- [ ] 測試案例 3: 泛指問題
- [ ] 測試案例 4: 對比測試
- [ ] 驗證 AI 調用時加上 judge_name
- [ ] 驗證返回案件數符合預期

### 待部署
- [ ] 重啟前端服務
- [ ] 重啟後端服務
- [ ] 清除瀏覽器緩存
- [ ] 重新測試問題

---

## 🚀 部署步驟

### 1. 重啟後端服務
```bash
cd d:\court_data\courtDataAPI
# Ctrl+C 停止服務
npm start
```

### 2. 重啟前端服務
```bash
cd d:\court_data\frontend-court-search-web\lawsowl
# Ctrl+C 停止服務
npm start
```

### 3. 清除瀏覽器緩存
```
F12 > Application > Clear storage > Clear site data
```

### 4. 測試
```
1. 訪問 http://localhost:3001
2. 搜索法官: 王婉如
3. 提問: "法官對於勝訴的案件，有什麼樣的共通性?"
4. 查看 Console 日誌
```

### 5. 驗證結果

**預期 Console 日誌**:
```javascript
[AI Assistant] 發送問題: 
⚠️ 重要上下文：用戶正在查詢特定法官的資訊...
當前查詢的法官：王婉如
...
用戶問題：法官對於勝訴的案件，有什麼樣的共通性?

[AI Agent] 調用 MCP 工具: search_judgments {
  query: '*',
  judge_name: '王婉如',  // ✅ 有了!
  verdict_type: '原告勝訴',
  limit: 100
}

[AI Agent] 返回 7 筆案件 ✅
```

---

## 📚 相關文檔

- **前端組件**: `lawsowl/src/components/judge/JudgeConversationPanelGreen.js`
- **後端工具定義**: `courtDataAPI/utils/ai-agent-tools.js`
- **Prompt 優化記錄**: `courtDataAPI/docs/AI_AGENT_PROMPT_OPTIMIZATION.md`

---

**修改完成時間**: 2025-10-03  
**修改人員**: AI Assistant  
**狀態**: ✅ 完成，待測試

