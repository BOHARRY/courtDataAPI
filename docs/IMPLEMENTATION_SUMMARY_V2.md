# å¯¦æ–½ç¸½çµ: æ–¹æ¡ˆ A (è¼•é‡ç´š"äº¤æ£’") + æ–¹æ¡ˆ 1 (è‡ªå‹•æå–æ•¸æ“š)

## ğŸ“… å¯¦æ–½æ—¥æœŸ
2025-10-03

## ğŸ¯ ç›®æ¨™
è§£æ±º GPT-4o åœ¨è¨ˆç®—å‹è¨´ç‡æ™‚è·³éæ•¸æ“šæª¢ç´¢æ­¥é©Ÿçš„å•é¡Œ,é€šéä»¥ä¸‹å…©å€‹æ–¹æ¡ˆçš„çµ„åˆ:
1. **æ–¹æ¡ˆ A**: Intent Classifier ä½œç‚ºè¼•é‡ç´š"äº¤æ£’æ‰‹",æå–é—œéµè³‡è¨Š
2. **æ–¹æ¡ˆ 1**: `calculate_verdict_statistics` å‡½æ•¸è‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–æ•¸æ“š

## ğŸ”§ å¯¦æ–½å…§å®¹

### 1. Intent Classifier å¢å¼· (è¼•é‡ç´šé è™•ç†)

**æ–‡ä»¶**: `services/intentClassifier.js`

**ä¿®æ”¹å…§å®¹**:
- ä¿®æ”¹ System Prompt,è¦æ±‚è¿”å› JSON æ ¼å¼
- æå–é—œéµè³‡è¨Š:
  - `question_type`: å•é¡Œé¡å‹ (å‹è¨´ç‡ã€åˆ—è¡¨ã€æ³•æ¢ã€åˆ¤æ±ºå‚¾å‘ã€é‡‘é¡ã€å…¶ä»–)
  - `case_type`: æ¡ˆç”±é—œéµå­—
  - `verdict_type`: åˆ¤æ±ºé¡å‹
- ä¿®æ”¹ `classifyIntent` å‡½æ•¸,è§£æ JSON è¿”å›
- å¢åŠ  `max_tokens` å¾ 10 â†’ 100 ä»¥æ”¯æŒ JSON è¿”å›

**è¿”å›æ ¼å¼**:
```javascript
{
  "intent": "legal_analysis",
  "isLegalRelated": true,
  "confidence": "high",
  "extractedInfo": {
    "question_type": "å‹è¨´ç‡",
    "case_type": "æå®³è³ å„Ÿ",
    "verdict_type": "åŸå‘Šå‹è¨´"
  },
  "tokenUsage": { ... }
}
```

**Token æ¶ˆè€—**:
- ä¹‹å‰: ~300 tokens
- ç¾åœ¨: ~500 tokens
- å¢åŠ : ~200 tokens (~$0.00003 per request)

---

### 2. AI Agent æ§åˆ¶å™¨å¢å¼· (å‹•æ…‹æ³¨å…¥æå–çš„è³‡è¨Š)

**æ–‡ä»¶**: `controllers/ai-agent-controller.js`

**ä¿®æ”¹å…§å®¹**:
- å¾ Intent Classifier çµæœä¸­æå– `extractedInfo`
- å‹•æ…‹æ§‹å»º System Prompt,æ³¨å…¥:
  - æ³•å®˜å§“å
  - å•é¡Œé¡å‹
  - æ¡ˆç”±
  - åˆ¤æ±ºé¡å‹
- æ ¹æ“šå•é¡Œé¡å‹æä¾›**å»ºè­°çš„å·¥ä½œæµç¨‹**

**ç¯„ä¾‹ (å‹è¨´ç‡å•é¡Œ)**:
```
ğŸ”´ **é‡è¦ä¸Šä¸‹æ–‡ - å•é¡Œé è™•ç†çµæœ**

**æ³•å®˜å§“å**: é»ƒéºŸæ·
**å•é¡Œé¡å‹**: å‹è¨´ç‡
**æ¡ˆç”±**: æå®³è³ å„Ÿ
**åˆ¤æ±ºé¡å‹**: åŸå‘Šå‹è¨´

**å»ºè­°å·¥ä½œæµç¨‹** (å‹è¨´ç‡è¨ˆç®—):
1. [ç¬¬1è¼ª] èª¿ç”¨ semantic_search_judgments(query="æå®³è³ å„Ÿ", judge_name="é»ƒéºŸæ·", limit=50)
2. [ç¬¬2è¼ª] èª¿ç”¨ calculate_verdict_statistics(analysis_type="verdict_rate", verdict_type="åŸå‘Šå‹è¨´")
   - âš ï¸ **ä¸è¦å‚³é judgments åƒæ•¸!** å‡½æ•¸æœƒè‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–æ•¸æ“š
3. [ç¬¬3è¼ª] ç”Ÿæˆå›ç­”
```

---

### 3. æœ¬åœ°å‡½æ•¸å¢å¼· (è‡ªå‹•æå–æ•¸æ“š)

**æ–‡ä»¶**: `utils/ai-agent-local-functions.js`

**ä¿®æ”¹å…§å®¹**:
- ä¿®æ”¹ `calculate_verdict_statistics` å‡½æ•¸ç°½å,æ¥æ”¶ `conversationHistory` åƒæ•¸
- å¯¦ç¾è‡ªå‹•æ•¸æ“šæå–é‚è¼¯:
  - å¦‚æœæ²’æœ‰ `judgments` åƒæ•¸,å¾å°è©±æ­·å²ä¸­æå–
  - æ”¯æŒå…©ç¨®ç­–ç•¥:
    1. **ç„¡éæ¿¾æ¢ä»¶**: ä½¿ç”¨æœ€è¿‘çš„ä¸€å€‹ tool æ¶ˆæ¯
    2. **æœ‰éæ¿¾æ¢ä»¶** (judge_name æˆ– case_type): æ”¶é›†æ‰€æœ‰ tool æ¶ˆæ¯,ç„¶å¾Œéæ¿¾
- æ”¯æŒæ ¹æ“š `judge_name` å’Œ `case_type` éæ¿¾æ•¸æ“š

**æ ¸å¿ƒé‚è¼¯**:
```javascript
// å¾å°è©±æ­·å²ä¸­æŸ¥æ‰¾ tool æ¶ˆæ¯
for (let i = conversationHistory.length - 1; i >= 0; i--) {
    const msg = conversationHistory[i];
    if (msg.role === 'tool') {
        const data = JSON.parse(msg.content);
        if (data['åˆ¤æ±ºæ›¸'] && Array.isArray(data['åˆ¤æ±ºæ›¸'])) {
            judgments = data['åˆ¤æ±ºæ›¸'];
            // å¯é¸: æ ¹æ“š judge_name å’Œ case_type éæ¿¾
            break;
        }
    }
}
```

---

### 4. å·¥å…·å®šç¾©æ›´æ–°

**æ–‡ä»¶**: `utils/ai-agent-tools.js`

**ä¿®æ”¹å…§å®¹**:
- æ›´æ–° `calculate_verdict_statistics` å·¥å…·å®šç¾©:
  - `judgments` å¾ `required` ä¸­ç§»é™¤
  - æ·»åŠ  `judge_name` å’Œ `case_type` åƒæ•¸
  - æ›´æ–° description èªªæ˜è‡ªå‹•æå–æ©Ÿåˆ¶

**æ–°çš„å·¥å…·å®šç¾©**:
```javascript
{
  name: "calculate_verdict_statistics",
  description: "è¨ˆç®—åˆ¤æ±ºçµæœçµ±è¨ˆã€‚å¦‚æœæ²’æœ‰æä¾› judgments åƒæ•¸,å‡½æ•¸æœƒè‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–æœ€è¿‘ä¸€æ¬¡ semantic_search_judgments æˆ– search_judgments çš„çµæœã€‚",
  parameters: {
    properties: {
      judgments: {
        type: "array",
        description: "[å¯é¸] åˆ¤æ±ºæ›¸é™£åˆ—ã€‚å¦‚æœä¸æä¾›,å‡½æ•¸æœƒè‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–ã€‚"
      },
      analysis_type: { ... },
      verdict_type: { ... },
      judge_name: {
        type: "string",
        description: "[å¯é¸] æ³•å®˜å§“å,ç”¨æ–¼éæ¿¾å°è©±æ­·å²ä¸­çš„åˆ¤æ±ºæ›¸æ•¸æ“š"
      },
      case_type: {
        type: "string",
        description: "[å¯é¸] æ¡ˆç”±é—œéµå­—,ç”¨æ–¼éæ¿¾å°è©±æ­·å²ä¸­çš„åˆ¤æ±ºæ›¸æ•¸æ“š"
      }
    },
    required: ["analysis_type"]  // ç§»é™¤ judgments
  }
}
```

---

### 5. å‡½æ•¸èª¿ç”¨éˆæ›´æ–°

**æ–‡ä»¶**: `controllers/ai-agent-controller.js`

**ä¿®æ”¹å…§å®¹**:
- `executeToolCall` å‡½æ•¸æ¥æ”¶ `conversationHistory` åƒæ•¸
- `callLocalFunction` å‡½æ•¸æ¥æ”¶ `conversationHistory` åƒæ•¸
- åœ¨å·¥å…·èª¿ç”¨æ™‚å‚³éå°è©±æ­·å²

**èª¿ç”¨éˆ**:
```
handleAIAgentChat
  â†’ executeToolCall(toolCall, messages)
    â†’ callLocalFunction(functionName, args, conversationHistory)
      â†’ calculate_verdict_statistics(judgments, options, conversationHistory)
```

---

## âœ… æ¸¬è©¦çµæœ

### ç«¯åˆ°ç«¯æ¸¬è©¦ (`test-e2e-workflow.js`)

**æ¸¬è©¦ 1**: ä¸å‚³é judgments åƒæ•¸ (æ‡‰è©²è‡ªå‹•æå–)
- âœ… **é€šé**: æˆåŠŸå¾å°è©±æ­·å²ä¸­æå– 5 ç­†åˆ¤æ±ºæ›¸
- çµæœ: ç¸½æ¡ˆä»¶æ•¸ 5, åŸå‘Šå‹è¨´ 3 ç­† (60.0%)

**æ¸¬è©¦ 2**: å‚³éç©ºé™£åˆ— (æ‡‰è©²è‡ªå‹•æå–)
- âœ… **é€šé**: æˆåŠŸå¾å°è©±æ­·å²ä¸­æå–æ•¸æ“š

**æ¸¬è©¦ 3**: æ²’æœ‰å°è©±æ­·å² (æ‡‰è©²è¿”å›éŒ¯èª¤)
- âœ… **é€šé**: æ­£ç¢ºè¿”å›éŒ¯èª¤è¨Šæ¯

**æ¸¬è©¦ 4**: ä½¿ç”¨ judge_name éæ¿¾
- âœ… **é€šé**: æˆåŠŸéæ¿¾æ³•å®˜,å¾ 6 ç­† â†’ 5 ç­† (æ’é™¤ç‹å©‰å¦‚çš„ 1 ç­†)

---

## ğŸ“Š é æœŸæ•ˆæœ

### 1. è§£æ±ºæ ¸å¿ƒå•é¡Œ
- âœ… GPT ä¸å†éœ€è¦å‚³éå¤§å‹æ•¸æ“šçµæ§‹ (18 ç­†åˆ¤æ±ºæ›¸ = 5000-10000 tokens)
- âœ… `calculate_verdict_statistics` è‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–æ•¸æ“š
- âœ… æ”¯æŒæ ¹æ“š `judge_name` å’Œ `case_type` éæ¿¾

### 2. æå‡å•é¡Œç†è§£
- âœ… Intent Classifier æå–é—œéµè³‡è¨Š (å•é¡Œé¡å‹ã€æ¡ˆç”±ã€åˆ¤æ±ºé¡å‹)
- âœ… AI Agent æ”¶åˆ°çµæ§‹åŒ–çš„ä¸Šä¸‹æ–‡
- âœ… æä¾›æ˜ç¢ºçš„å·¥ä½œæµç¨‹å»ºè­°

### 3. Token å„ªåŒ–
- Intent Classifier: +200 tokens (~$0.00003)
- AI Agent: ä¿æŒä¸è®Š (~5000 tokens)
- **ç¸½é«”**: è¼•å¾®å¢åŠ ,ä½†æå‡äº†æº–ç¢ºæ€§

### 4. ä¿æŒéˆæ´»æ€§
- âœ… AI Agent ä»ç„¶å¯ä»¥è‡ªä¸»æ±ºç­–
- âœ… ä¸å¼·åˆ¶åŸ·è¡Œå›ºå®šçš„å·¥ä½œæµç¨‹
- âœ… å‘å¾Œå…¼å®¹ (ä»ç„¶å¯ä»¥ç›´æ¥å‚³é judgments)

---

## ğŸ”„ å·¥ä½œæµç¨‹å°æ¯”

### ä¹‹å‰ (æœ‰å•é¡Œ)
```
ç”¨æˆ¶: "æ³•å®˜åœ¨æå®³è³ å„Ÿä¸­çš„å‹è¨´ç‡?"
  â†“
AI Agent (ç¬¬1è¼ª): semantic_search_judgments(...) â†’ è¿”å› 18 ç­†åˆ¤æ±ºæ›¸
  â†“
AI Agent (ç¬¬2è¼ª): calculate_verdict_statistics(judgments=[...18ç­†...], ...)
  â†“
âŒ éŒ¯èª¤: GPT ç„¡æ³•å‚³éå¤§å‹æ•¸æ“šçµæ§‹
  â†“
AI Agent (ç¬¬2è¼ª): calculate_verdict_statistics(analysis_type="verdict_rate", ...)
  â†“
âŒ éŒ¯èª¤: "ç„¡åˆ¤æ±ºæ›¸æ•¸æ“š"
```

### ç¾åœ¨ (å·²ä¿®å¾©)
```
ç”¨æˆ¶: "æ³•å®˜åœ¨æå®³è³ å„Ÿä¸­çš„å‹è¨´ç‡?"
  â†“
Intent Classifier: 
  - intent: legal_analysis
  - question_type: å‹è¨´ç‡
  - case_type: æå®³è³ å„Ÿ
  - verdict_type: åŸå‘Šå‹è¨´
  â†“
AI Agent (æ”¶åˆ°ä¸Šä¸‹æ–‡ + å»ºè­°å·¥ä½œæµç¨‹)
  â†“
AI Agent (ç¬¬1è¼ª): semantic_search_judgments(query="æå®³è³ å„Ÿ", judge_name="é»ƒéºŸæ·", limit=50)
  â†’ è¿”å› 18 ç­†åˆ¤æ±ºæ›¸
  â†’ æ·»åŠ åˆ°å°è©±æ­·å²
  â†“
AI Agent (ç¬¬2è¼ª): calculate_verdict_statistics(analysis_type="verdict_rate", verdict_type="åŸå‘Šå‹è¨´")
  â†’ å‡½æ•¸è‡ªå‹•å¾å°è©±æ­·å²ä¸­æå– 18 ç­†åˆ¤æ±ºæ›¸
  â†’ è¨ˆç®—çµ±è¨ˆ
  â†“
âœ… æˆåŠŸ: è¿”å› { ç¸½æ¡ˆä»¶æ•¸: 18, åŸå‘Šå‹è¨´: 7, å‹è¨´ç‡: "38.9%" }
  â†“
AI Agent (ç¬¬3è¼ª): ç”Ÿæˆå›ç­”
  â†’ "æ ¹æ“š 2025å¹´6-7æœˆ çš„æ•¸æ“š,é»ƒéºŸæ·æ³•å®˜åœ¨æå®³è³ å„Ÿæ¡ˆä»¶ä¸­,åŸå‘Šå‹è¨´ç‡ç‚º 38.9%..."
```

---

## ğŸ“ å¾ŒçºŒå»ºè­°

### 1. ç›£æ§å’Œèª¿æ•´
- ç›£æ§ Intent Classifier çš„æå–æº–ç¢ºæ€§
- æ”¶é›† GPT çš„å¯¦éš›è¡Œç‚ºæ•¸æ“š
- æ ¹æ“šå¯¦éš›æ•ˆæœèª¿æ•´ System Prompt

### 2. æ“´å±•åˆ°å…¶ä»–å‡½æ•¸
- è€ƒæ…®å°‡è‡ªå‹•æå–æ©Ÿåˆ¶æ‡‰ç”¨åˆ°å…¶ä»–æœ¬åœ°å‡½æ•¸:
  - `analyze_amount_trends`
  - `calculate_case_type_distribution`

### 3. å„ªåŒ– Token æ¶ˆè€—
- å¦‚æœ Intent Classifier çš„ Token æ¶ˆè€—éé«˜,è€ƒæ…®ç°¡åŒ–æå–é‚è¼¯
- ç›£æ§å¯¦éš›çš„ Token ä½¿ç”¨æƒ…æ³

---

## ğŸ‰ ç¸½çµ

æˆåŠŸå¯¦æ–½äº† **æ–¹æ¡ˆ A (è¼•é‡ç´š"äº¤æ£’") + æ–¹æ¡ˆ 1 (è‡ªå‹•æå–æ•¸æ“š)** çš„çµ„åˆæ–¹æ¡ˆ:

1. âœ… **Intent Classifier** ä½œç‚ºè¼•é‡ç´šé è™•ç†å™¨,æå–é—œéµè³‡è¨Š
2. âœ… **AI Agent** æ”¶åˆ°çµæ§‹åŒ–çš„ä¸Šä¸‹æ–‡å’Œå»ºè­°å·¥ä½œæµç¨‹
3. âœ… **`calculate_verdict_statistics`** è‡ªå‹•å¾å°è©±æ­·å²ä¸­æå–æ•¸æ“š
4. âœ… **æ‰€æœ‰æ¸¬è©¦é€šé**,é©—è­‰äº†å¯¦æ–½çš„æ­£ç¢ºæ€§

é€™å€‹æ–¹æ¡ˆ:
- è§£æ±ºäº† GPT ç„¡æ³•å‚³éå¤§å‹æ•¸æ“šçµæ§‹çš„æ ¹æœ¬å•é¡Œ
- æå‡äº†å•é¡Œç†è§£çš„æº–ç¢ºæ€§
- ä¿æŒäº†ç³»çµ±çš„éˆæ´»æ€§
- Token æ¶ˆè€—å¢åŠ è¼•å¾®,ä½†æå‡äº†æº–ç¢ºæ€§

**é æœŸæ•ˆæœ**: GPT å°‡èƒ½å¤ æ­£ç¢ºåŸ·è¡Œå‹è¨´ç‡è¨ˆç®—çš„å®Œæ•´å·¥ä½œæµç¨‹,ä¸å†è·³éæ•¸æ“šæª¢ç´¢æ­¥é©Ÿã€‚

