# æ´å¼•åˆ†æç³»çµ±æŒ‡å— v3.0

---
**æ–‡æª”ç‹€æ…‹**: active  
**ç‰ˆæœ¬**: v3.0  
**æœ€å¾Œæ›´æ–°**: 2024-01-19  
**APIç‰ˆæœ¬**: v1.2.3  
**ä¸‹æ¬¡å¯©æŸ¥**: 2024-02-19  
**ç¶­è­·è€…**: LawSowl å¾Œç«¯é–‹ç™¼åœ˜éšŠ  
---

## ğŸ¯ ç³»çµ±æ¦‚è¿°

æ´å¼•åˆ†æç³»çµ±æ˜¯LawSowlçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæä¾›æ™ºèƒ½çš„åˆ¤ä¾‹æ´å¼•åˆ†æå’Œæ³•å¾‹é©ç”¨æŒ‡å°ã€‚æœ¬æŒ‡å—æ•´åˆäº†ç³»çµ±æ¶æ§‹ã€å¯¦æ–½ç¶“é©—å’Œæœ€ä½³å¯¦è¸ã€‚

### **æ ¸å¿ƒåŠŸèƒ½**
- ğŸ” **æ™ºèƒ½æ´å¼•æª¢æ¸¬**ï¼šè‡ªå‹•è­˜åˆ¥å’Œåˆ†æåˆ¤æ±ºæ›¸ä¸­çš„æ´å¼•åˆ¤ä¾‹
- ğŸ“Š **å…©éšæ®µåˆ†ææ¶æ§‹**ï¼šå…ˆç¯©é¸å¾Œæ·±åº¦åˆ†æï¼Œæå‡æº–ç¢ºæ€§
- ğŸ¯ **ç«‹å ´å°å‘åˆ†æ**ï¼šæ”¯æŒåŸå‘Š/è¢«å‘Šç«‹å ´çš„é‡å°æ€§åˆ†æ
- ğŸ“ˆ **é€²åº¦è¿½è¹¤ç³»çµ±**ï¼šå¯¦æ™‚é¡¯ç¤ºåˆ†æé€²åº¦å’Œç‹€æ…‹

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### **å…©éšæ®µåˆ†ææ¶æ§‹**

#### **éšæ®µä¸€ï¼šé‡è¦æ€§ç¯©é¸**
```javascript
async function selectTopCitationsForAnalysis(valuableCitations, position, caseDescription) {
    // 1. æº–å‚™ç°¡åŒ–çš„æ´å¼•æ•¸æ“šï¼ˆåªåŒ…å«åŸºæœ¬çµ±è¨ˆä¿¡æ¯ï¼‰
    const simplifiedCitations = valuableCitations.map(citation => ({
        citationId: citation.citationId,
        caseTitle: citation.caseTitle,
        totalOccurrences: citation.totalOccurrences,
        inCourtInsightCount: citation.inCourtInsightCount,
        rarityScore: citation.rarityScore,
        valueScore: citation.valueScore
    }));

    // 2. ä½¿ç”¨ GPT-4o-mini å¿«é€Ÿè©•ä¼°ç›¸é—œæ€§
    const selectionPrompt = `
        æ¡ˆä»¶æè¿°ï¼š${caseDescription}
        åˆ†æç«‹å ´ï¼š${position}
        
        è«‹å¾ä»¥ä¸‹æ´å¼•åˆ¤ä¾‹ä¸­é¸å‡ºæœ€é‡è¦çš„3-5å€‹é€²è¡Œæ·±åº¦åˆ†æï¼š
        ${JSON.stringify(simplifiedCitations, null, 2)}
        
        ç¯©é¸æ¨™æº–ï¼š
        1. èˆ‡æ¡ˆä»¶ä¸»é¡Œæœ€ç›¸é—œ
        2. å„ªå…ˆé¸æ“‡åœ¨æ³•é™¢è¦‹è§£å…§è¢«å¼•ç”¨çš„åˆ¤ä¾‹
        3. è€ƒæ…®ç¨€æœ‰åº¦å’Œåƒ¹å€¼åˆ†æ•¸çš„å¹³è¡¡
    `;

    // 3. è¿”å›ç¯©é¸çµæœ
    return selectedCitations;
}
```

#### **éšæ®µäºŒï¼šæ·±åº¦åˆ†æ**
```javascript
async function performDetailedAnalysis(selectedCitations, position, caseDescription) {
    const analysisResults = [];
    
    // é€ä¸€åˆ†ææ¯å€‹ç¯©é¸å‡ºçš„åˆ¤ä¾‹
    for (const citation of selectedCitations) {
        // 1. ç²å–å®Œæ•´çš„ä¸Šä¸‹æ–‡æ•¸æ“š
        const fullContext = await getCitationFullContext(citation.citationId);
        
        // 2. ä½¿ç”¨ GPT-4o é€²è¡Œæ·±åº¦åˆ†æ
        const analysis = await analyzeCitationInDepth({
            citation,
            context: fullContext,
            position,
            caseDescription
        });
        
        analysisResults.push(analysis);
    }
    
    return analysisResults;
}
```

### **æ•¸æ“šæµæ¶æ§‹**
```
ğŸ“Š åˆ¤æ±ºæ›¸è¼¸å…¥
    â†“
ğŸ” æ´å¼•æª¢æ¸¬ (citationAnalysisService)
    â†“
ğŸ“‹ åƒ¹å€¼è©•ä¼° (rarityScore, valueScore)
    â†“
ğŸ¯ éšæ®µä¸€ï¼šé‡è¦æ€§ç¯©é¸ (GPT-4o-mini)
    â†“
ğŸ“š éšæ®µäºŒï¼šæ·±åº¦åˆ†æ (GPT-4o)
    â†“
ğŸ“ˆ é€²åº¦è¿½è¹¤æ›´æ–°
    â†“
ğŸ“„ åˆ†æçµæœè¼¸å‡º
```

## ğŸ› ï¸ æ ¸å¿ƒæœå‹™

### **citationAnalysisService.js**

#### **ä¸»è¦æ–¹æ³•**
```javascript
class CitationAnalysisService {
    // å•Ÿå‹•æ´å¼•åˆ†æ
    async startCitationAnalysis(caseId, position, options = {}) {
        // 1. åˆå§‹åŒ–é€²åº¦è¿½è¹¤
        // 2. æª¢æ¸¬æ´å¼•åˆ¤ä¾‹
        // 3. åŸ·è¡Œå…©éšæ®µåˆ†æ
        // 4. ä¿å­˜çµæœ
    }

    // ç²å–åˆ†æé€²åº¦
    async getAnalysisProgress(caseId) {
        // è¿”å›å¯¦æ™‚é€²åº¦ä¿¡æ¯
    }

    // å…©éšæ®µåˆ†æå¯¦æ–½
    async performTwoStageAnalysis(citations, position, caseDescription) {
        // å¯¦æ–½å…©éšæ®µåˆ†æé‚è¼¯
    }
}
```

#### **é—œéµé…ç½®**
```javascript
const ANALYSIS_CONFIG = {
    // éšæ®µä¸€é…ç½®
    stage1: {
        model: 'gpt-4o-mini',
        maxCitations: 10,
        selectionCount: 3-5,
        timeout: 30000
    },
    
    // éšæ®µäºŒé…ç½®
    stage2: {
        model: 'gpt-4o',
        maxContextLength: 8000,
        timeout: 60000,
        retryAttempts: 3
    },
    
    // é€²åº¦è¿½è¹¤é…ç½®
    progress: {
        updateInterval: 1000,
        stages: ['æª¢æ¸¬æ´å¼•', 'ç¯©é¸åˆ¤ä¾‹', 'æ·±åº¦åˆ†æ', 'ç”Ÿæˆå ±å‘Š']
    }
};
```

## ğŸ“Š é€²åº¦è¿½è¹¤ç³»çµ±

### **é€²åº¦ç‹€æ…‹ç®¡ç†**
```javascript
// é€²åº¦ç‹€æ…‹çµæ§‹
const progressState = {
    caseId: 'case-uuid',
    status: 'processing', // 'pending', 'processing', 'completed', 'error'
    currentStage: 'citation-detection',
    totalStages: 4,
    completedStages: 1,
    progress: 25, // ç™¾åˆ†æ¯”
    
    // è©³ç´°é€²åº¦ä¿¡æ¯
    stages: {
        'citation-detection': { status: 'completed', progress: 100 },
        'citation-selection': { status: 'processing', progress: 60 },
        'detailed-analysis': { status: 'pending', progress: 0 },
        'report-generation': { status: 'pending', progress: 0 }
    },
    
    // çµæœçµ±è¨ˆ
    results: {
        totalCitations: 12,
        selectedCitations: 4,
        analyzedCitations: 2,
        errors: 0
    },
    
    // æ™‚é–“æˆ³
    startTime: '2024-01-19T10:00:00Z',
    lastUpdate: '2024-01-19T10:05:30Z',
    estimatedCompletion: '2024-01-19T10:15:00Z'
};
```

### **å¯¦æ™‚æ›´æ–°æ©Ÿåˆ¶**
```javascript
// é€²åº¦æ›´æ–°æœå‹™
class ProgressTrackingService {
    async updateProgress(caseId, stageUpdate) {
        // 1. æ›´æ–°é€²åº¦ç‹€æ…‹
        const currentProgress = await this.getProgress(caseId);
        const updatedProgress = this.mergeProgress(currentProgress, stageUpdate);
        
        // 2. ä¿å­˜åˆ°æ•¸æ“šåº«
        await this.saveProgress(caseId, updatedProgress);
        
        // 3. é€šçŸ¥å‰ç«¯ï¼ˆWebSocketæˆ–è¼ªè©¢ï¼‰
        await this.notifyFrontend(caseId, updatedProgress);
        
        return updatedProgress;
    }
}
```

## ğŸ¯ ç«‹å ´å°å‘åˆ†æ

### **åˆ†æç«‹å ´é…ç½®**
```javascript
const POSITION_CONFIGS = {
    plaintiff: {
        name: 'åŸå‘Šç«‹å ´',
        color: 'green',
        focusAreas: ['æœ‰åˆ©åˆ¤ä¾‹', 'æ³•å¾‹é©ç”¨', 'è­‰æ“šæ”¯æŒ'],
        analysisPrompt: `
            å¾åŸå‘Šè§’åº¦åˆ†ææ­¤æ´å¼•åˆ¤ä¾‹ï¼š
            1. æ­¤åˆ¤ä¾‹å¦‚ä½•æ”¯æŒåŸå‘Šä¸»å¼µï¼Ÿ
            2. å¯ä»¥å¦‚ä½•é‹ç”¨æ­¤åˆ¤ä¾‹çš„æ³•å¾‹è¦‹è§£ï¼Ÿ
            3. æ­¤åˆ¤ä¾‹çš„æ ¸å¿ƒåƒ¹å€¼å’Œé©ç”¨æ™‚æ©Ÿï¼Ÿ
        `
    },
    
    defendant: {
        name: 'è¢«å‘Šç«‹å ´',
        color: 'red',
        focusAreas: ['æŠ—è¾¯ä¾æ“š', 'ä¾‹å¤–æƒ…æ³', 'é™åˆ¶è§£é‡‹'],
        analysisPrompt: `
            å¾è¢«å‘Šè§’åº¦åˆ†ææ­¤æ´å¼•åˆ¤ä¾‹ï¼š
            1. æ­¤åˆ¤ä¾‹æ˜¯å¦å¯ç”¨æ–¼æŠ—è¾¯ï¼Ÿ
            2. åˆ¤ä¾‹çš„é™åˆ¶æ¢ä»¶å’Œä¾‹å¤–æƒ…æ³ï¼Ÿ
            3. å¦‚ä½•å€åˆ¥æˆ–é™åˆ¶æ­¤åˆ¤ä¾‹çš„é©ç”¨ï¼Ÿ
        `
    },
    
    neutral: {
        name: 'ä¸­ç«‹åˆ†æ',
        color: 'gray',
        focusAreas: ['æ³•ç†åˆ†æ', 'é©ç”¨æ¢ä»¶', 'å¯¦å‹™å½±éŸ¿'],
        analysisPrompt: `
            å®¢è§€åˆ†ææ­¤æ´å¼•åˆ¤ä¾‹ï¼š
            1. åˆ¤ä¾‹çš„æ ¸å¿ƒæ³•å¾‹åŸå‰‡ï¼Ÿ
            2. é©ç”¨æ¢ä»¶å’Œé™åˆ¶ï¼Ÿ
            3. å°å¯¦å‹™çš„å½±éŸ¿å’Œæ„ç¾©ï¼Ÿ
        `
    }
};
```

## ğŸ”§ APIæ¥å£

### **å•Ÿå‹•åˆ†æ**
```http
POST /api/citation-analysis/start
Content-Type: application/json

{
    "caseId": "case-uuid",
    "position": "plaintiff", // "plaintiff", "defendant", "neutral"
    "options": {
        "maxCitations": 10,
        "analysisDepth": "detailed",
        "includeContext": true
    }
}
```

### **ç²å–é€²åº¦**
```http
GET /api/citation-analysis/progress/:caseId

Response:
{
    "status": "processing",
    "progress": 65,
    "currentStage": "detailed-analysis",
    "estimatedCompletion": "2024-01-19T10:15:00Z",
    "results": {
        "totalCitations": 12,
        "analyzedCitations": 7
    }
}
```

### **ç²å–çµæœ**
```http
GET /api/citation-analysis/results/:caseId

Response:
{
    "caseId": "case-uuid",
    "position": "plaintiff",
    "analysisResults": [
        {
            "citationId": "citation-uuid",
            "caseTitle": "æœ€é«˜æ³•é™¢109å¹´å°ä¸Šå­—ç¬¬2908è™Ÿåˆ¤æ±º",
            "analysis": {
                "coreValue": "ç¢ºç«‹äº†...",
                "applicability": "é©ç”¨æ–¼...",
                "limitations": "é™åˆ¶æ¢ä»¶..."
            },
            "confidence": 0.85
        }
    ],
    "summary": {
        "totalAnalyzed": 4,
        "averageConfidence": 0.82,
        "keyInsights": ["...", "..."]
    }
}
```

## ğŸš¨ éŒ¯èª¤è™•ç†

### **å¸¸è¦‹éŒ¯èª¤é¡å‹**
```javascript
const ERROR_TYPES = {
    CITATION_DETECTION_FAILED: {
        code: 'CD001',
        message: 'æ´å¼•æª¢æ¸¬å¤±æ•—',
        recovery: 'é‡è©¦æª¢æ¸¬æˆ–æ‰‹å‹•æŒ‡å®šæ´å¼•'
    },
    
    AI_ANALYSIS_TIMEOUT: {
        code: 'AI002',
        message: 'AIåˆ†æè¶…æ™‚',
        recovery: 'æ¸›å°‘åˆ†æç¯„åœæˆ–é‡è©¦'
    },
    
    CONTEXT_DATA_MISSING: {
        code: 'CD003',
        message: 'ä¸Šä¸‹æ–‡æ•¸æ“šç¼ºå¤±',
        recovery: 'é‡æ–°ç²å–åˆ¤æ±ºæ›¸æ•¸æ“š'
    },
    
    QUOTA_EXCEEDED: {
        code: 'AI004',
        message: 'APIé…é¡è¶…é™',
        recovery: 'ç­‰å¾…é…é¡é‡ç½®æˆ–ä½¿ç”¨å‚™ç”¨API'
    }
};
```

### **éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶**
```javascript
class ErrorRecoveryService {
    async handleAnalysisError(error, context) {
        switch (error.code) {
            case 'AI002': // AIåˆ†æè¶…æ™‚
                return await this.retryWithReducedScope(context);
                
            case 'CD003': // ä¸Šä¸‹æ–‡æ•¸æ“šç¼ºå¤±
                return await this.refetchContextData(context);
                
            case 'AI004': // é…é¡è¶…é™
                return await this.switchToBackupAPI(context);
                
            default:
                return await this.logAndNotify(error, context);
        }
    }
}
```

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–

### **ç·©å­˜ç­–ç•¥**
```javascript
const CACHE_CONFIG = {
    // æ´å¼•æª¢æ¸¬çµæœç·©å­˜
    citationDetection: {
        ttl: 24 * 60 * 60, // 24å°æ™‚
        key: (caseId) => `citation:detection:${caseId}`
    },
    
    // AIåˆ†æçµæœç·©å­˜
    analysisResults: {
        ttl: 7 * 24 * 60 * 60, // 7å¤©
        key: (caseId, position) => `citation:analysis:${caseId}:${position}`
    },
    
    // ä¸Šä¸‹æ–‡æ•¸æ“šç·©å­˜
    contextData: {
        ttl: 30 * 24 * 60 * 60, // 30å¤©
        key: (citationId) => `citation:context:${citationId}`
    }
};
```

### **ä¸¦è¡Œè™•ç†å„ªåŒ–**
```javascript
// ä¸¦è¡Œåˆ†æå¤šå€‹æ´å¼•
async function analyzeMultipleCitations(citations, position, caseDescription) {
    const batchSize = 3; // é¿å…APIé™åˆ¶
    const results = [];
    
    for (let i = 0; i < citations.length; i += batchSize) {
        const batch = citations.slice(i, i + batchSize);
        
        // ä¸¦è¡Œè™•ç†ç•¶å‰æ‰¹æ¬¡
        const batchResults = await Promise.all(
            batch.map(citation => 
                this.analyzeSingleCitation(citation, position, caseDescription)
            )
        );
        
        results.push(...batchResults);
        
        // æ‰¹æ¬¡é–“å»¶é²ï¼Œé¿å…APIé™åˆ¶
        if (i + batchSize < citations.length) {
            await this.delay(1000);
        }
    }
    
    return results;
}
```

## ğŸ“š ç›¸é—œæ–‡æª”

- [APIè¨­è¨ˆè¦ç¯„](./APIè¨­è¨ˆè¦ç¯„_v3.0.md)
- [æ•¸æ“šè™•ç†æ¶æ§‹æŒ‡å—](./æ•¸æ“šè™•ç†æ¶æ§‹æŒ‡å—_v3.0.md)
- [ç³»çµ±ç›£æ§å’Œèª¿è©¦æŒ‡å—](./ç³»çµ±ç›£æ§å’Œèª¿è©¦æŒ‡å—_v3.0.md)
- [æ´å¼•åˆ†æAPIæ–‡æª”](../api/citation-analysis-api.md)

## ğŸ”„ ç‰ˆæœ¬æ­·å²

### **v3.0** (2024-01-19)
- æ•´åˆå…©éšæ®µåˆ†ææ¶æ§‹
- å®Œå–„é€²åº¦è¿½è¹¤ç³»çµ±
- å„ªåŒ–ç«‹å ´å°å‘åˆ†æ
- æ”¹é€²éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

### **v2.1** (2024-01-15)
- å¯¦æ–½å…©éšæ®µåˆ†æ
- æ”¹é€²AIæç¤ºè©
- å¢åŠ ä¸Šä¸‹æ–‡æ•¸æ“šæ¢å¾©

### **v2.0** (2024-01-10)
- é‡æ§‹åˆ†ææ¶æ§‹
- æ·»åŠ é€²åº¦è¿½è¹¤
- å„ªåŒ–æ€§èƒ½å’Œç·©å­˜

---

**ç¶­è­·è€…**ï¼šLawSowl å¾Œç«¯é–‹ç™¼åœ˜éšŠ  
**æŠ€è¡“å¯©æŸ¥**ï¼šAIç³»çµ±æ¶æ§‹å¸«  
**è³ªé‡ä¿è­‰**ï¼šæ¸¬è©¦å’Œé©—è­‰åœ˜éšŠ  

**å‚™è¨»**ï¼šæ­¤æŒ‡å—æ•´åˆäº†æ´å¼•åˆ†æç³»çµ±çš„å®Œæ•´å¯¦æ–½ç¶“é©—ï¼Œç‚ºç³»çµ±ç¶­è­·å’ŒåŠŸèƒ½æ“´å±•æä¾›æ¬Šå¨åƒè€ƒã€‚
