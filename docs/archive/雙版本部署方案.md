# LawSowl 雙版本部署方案技術文檔

> 更新日期：2025-09-25

本文件說明 LawSowl 目前前後端雙版本部署現況、操作流程與後續待辦，供前端、後端與 DevOps 團隊共同參考。

---

## 1. 現況速覽

- **前端 Git 倉庫**：`frontend-court-search-web`（本地 `d:/court_data/frontend-court-search-web/lawsowl`）
- **後端 Git 倉庫**：`courtDataAPI`（本地 `d:/court_data/courtDataAPI`）
- **主線分支策略**：`develop` → 測試環境、`main` → 生產環境。
- **正式站 (Stable)**：`https://frontend-court-search-web.vercel.app`，來源 `main`。
- **測試站 (Beta)**：`https://frontend-court-beta.vercel.app`，來源 `develop`。
- **後端 API**：`https://courtdataapi.onrender.com`（Stable）與 `https://ourtdataapi-beta.onrender.com`（Beta）。
- **部署方式**：Vercel/Render 自動部署為主，必要時搭配 `src/scripts` 底下的備份與回滾腳本。

---

## 2. 整體架構（2025/09 現況）

```
┌─────────────────────────────────────────────────────────────┐
│                        使用者端入口                          │
├─────────────────────────────────────────────────────────────┤
│  Stable (main)              │  Beta (develop)                │
│  frontend-court-search-web  │  frontend-court-beta           │
│  .vercel.app                │  .vercel.app                   │
├─────────────────────────────────────────────────────────────┤
│  Vercel 前端專案                                               │
│  ├── Create React App 產出物 (build/)                         │
│  ├── 環境變數：REACT_APP_ENVIRONMENT=production/beta          │
│  └── 共用：裁判書/律師模組、版本切換器、Log 攔截器            │
├─────────────────────────────────────────────────────────────┤
│  Render 後端服務                                               │
│  ├── courtdataapi.onrender.com  ← 維持 Stable API              │
│  └── ourtdataapi-beta.onrender.com ← 新增 Beta API             │
├─────────────────────────────────────────────────────────────┤
│  共用外部資源                                                   │
│  ├── Elasticsearch（判決檢索）                                 │
│  ├── Firebase Admin（認證、儲存）                             │
│  └── 第三方 AI （OpenAI / Anthropic / xAI）                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 分支與部署流程

| 階段 | 動作 | 負責人 | 結果 |
|------|------|--------|------|
| 1 | 在 `develop` 開發功能 | 前端/後端工程師 | Vercel 自動部署到 Beta，Render 自動部署 `ourtdataapi-beta` |
| 2 | QA 驗證通過後建立 PR → 合併到 `main` | 研發 + Reviewer | 觸發 Vercel Stable 與 Render Stable 部署 |
| 3 | 熱修流程：`main` 建 hotfix，完成後回灌 `develop` | 研發 | Beta 與 Stable 維持同步 |
| 4 | 部署前執行 `src/scripts/create-deployment-backup.*` 備份 | 研發/DevOps | 確保隨時可回滾 |

---

## 4. Vercel / Render 專案設定

| 類型 | 名稱 | 來源分支 | 主要環境變數 | 備註 |
|------|------|----------|--------------|------|
| Vercel Stable | `frontend-court-search-web` | `main` | `REACT_APP_ENVIRONMENT=production`<br>`REACT_APP_API_BASE_URL=https://courtdataapi.onrender.com/api` | 正式站（Stable） |
| Vercel Beta | `frontend-court-beta` | `develop` | `REACT_APP_ENVIRONMENT=beta`<br>`REACT_APP_API_BASE_URL=https://ourtdataapi-beta.onrender.com/api` | 測試站（Beta） |
| Render Stable | `courtdataapi` | `main` | `APP_BASE_URL=https://frontend-court-search-web.vercel.app`<br>`IS_BETA=false`<br>`STABLE_APP_BASE_URL=https://frontend-court-search-web.vercel.app` | 舊有生產 API |
| Render Beta | `ourtdataapi-beta` | `develop` | `APP_BASE_URL=https://frontend-court-beta.vercel.app`<br>`IS_BETA=true`<br>`CORS_ADDITIONAL_ORIGINS=https://frontend-court-search-web.vercel.app` | 新增 Beta API（與 Stable 共享程式碼） |

> **CORS 提醒**：`config/express.js` 會自動載入 `APP_BASE_URL`、`STABLE_APP_BASE_URL`、`CORS_ADDITIONAL_ORIGINS`。兩個後端服務都需設定對方的前端網域，避免跨域錯誤。

---

## 5. 環境變數管理

### 5.1 前端

| 類別 | 變數 | Stable | Beta | 備註 |
|------|------|--------|------|------|
| 共用 | `REACT_APP_FIREBASE_*` | ✓ | ✓ | 同一 Firebase 專案 |
| 共用 | `REACT_APP_API_BASE_URL` | `https://courtdataapi.onrender.com/api` | `https://ourtdataapi-beta.onrender.com/api` | 於 Vercel 專案分別設定 |
| 環境旗標 | `REACT_APP_ENVIRONMENT` | `production` | `beta` | 控制版本徽章、Log、功能旗標 |
| 其他 | `REACT_APP_SUPPRESS_*` | 視需求 | 視需求 | 日誌抑制設定 |

### 5.2 後端

| 類別 | 變數 | Stable 服務 | Beta 服務 | 說明 |
|------|------|-------------|-----------|------|
| Firebase | `FIREBASE_SERVICE_ACCOUNT_KEY_JSON` | 同 | 同 | 需為合法 JSON 字串 |
| 搜尋 | `ES_URL`, `ES_API_KEY` | 同 | 同 | 目前共用叢集 |
| AI 金鑰 | `OPENAI_API_KEY`, `XAI_API_KEY`, `CLAUDE_API_KEY` | 同 | 同 | 建議平台 Secret 管理 |
| 版本旗標 | `IS_BETA` | `false` | `true` | 可用於程式條件分支 |
| 前端 URL | `APP_BASE_URL` | Stable 網域 | Beta 網域 | 配合 CORS/通知使用 |
| CORS | `STABLE_APP_BASE_URL`, `CORS_ADDITIONAL_ORIGINS` | `STABLE_*` 指向 Stable 前端 | `STABLE_*` 同 Stable，`CORS_ADDITIONAL_ORIGINS` 包含 Stable 網域 | `config/express.js` 會自動合併這兩組值 |

> `.env` 僅存在於各服務平台，請勿提交至 Git。若需本地測試，可在根目錄建立 `.env.local` 自行維護。

---

## 6. 手動部署操作流程

### 6.1 前端（僅限必要時）
1. 確認 `main`/`develop` 最新 commit 均已合併。
2. （選）本地 `npm run build` 驗證。
3. （選）執行 `src/scripts/create-deployment-backup.*` 備份。
4. Vercel 後台選擇專案 → **Deploy**（或 `vercel --prod`）。

### 6.2 後端（Render）
1. Render 後台選擇 `courtdataapi` 或 `ourtdataapi-beta`。
2. 確認環境變數已同步（特別是 `APP_BASE_URL`、`CORS_ADDITIONAL_ORIGINS`）。
3. 點選 **Manual Deploy > Deploy Latest Commit**。
4. 監控 Render Logs：應看到 Firebase Init、Elasticsearch ping 成功後聽 10000 port。

---

## 7. 回滾策略

| 類型 | 操作 |
|------|------|
| 前端 | Vercel 後台 `Promote` 舊部署或 `vercel --prod --rollback <url>` |
| 後端 | Render Dashboard 選擇歷史部署 → **Rollback**；必要時 `git revert` 後重新部署 |
| 本地備援 | `src/scripts/emergency-rollback.*` 可快速回覆至備份版本 |

---

## 8. 常見檢查清單

- [ ] PR 經過 Code Review，功能已在 Beta 驗證。
- [ ] `git status` 確認無未提交檔案。
- [ ] Vercel / Render 環境變數與 `.env.example`、本文一致。
- [ ] Beta 站驗證通過再合併 `main`。
- [ ] 部署後 30 分鐘內監控前端 Console 與 Render Logs。

---

## 9. 後續工作（高優先）

1. **建立自動化檢查**：導入 GitHub Actions（lint/build）與簡易 smoke test。
2. **補充 API 文件**：在 repo 中新增 `/docs/api-beta.md`，記錄 Beta 專屬行為。
3. **資料備份策略**：確認 Elasticsearch、Firebase 定期備份與災難復原流程。
4. **Secrets 輪替計畫**：建立金鑰輪替 SOP，並於 Render/Vercel 設定提醒。

Beta API 已經上線，後續請依本文件持續維護分支與環境設定，確保雙版本部署流程一致且可追蹤。
