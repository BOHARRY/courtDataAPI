# æ³•å®˜èªæ„AIåŠ©æ‰‹ - å®Œæ•´æŠ€è¡“äº¤æ¥æ–‡æª”

> **æ–‡æª”ç‰ˆæœ¬**: 1.0  
> **æœ€å¾Œæ›´æ–°**: 2025-10-02  
> **ä½œè€…**: Augment AI Agent  
> **ç‹€æ…‹**: å‰ç«¯å·²å®Œæˆ,å¾Œç«¯å¾…é–‹ç™¼

---

## ğŸ“‹ ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [å‰ç«¯å¯¦ä½œç¸½çµ (å·²å®Œæˆ)](#2-å‰ç«¯å¯¦ä½œç¸½çµ-å·²å®Œæˆ)
3. [å¾Œç«¯å¯¦ä½œæ–¹æ¡ˆ (å¾…é–‹ç™¼)](#3-å¾Œç«¯å¯¦ä½œæ–¹æ¡ˆ-å¾…é–‹ç™¼)
4. [æ•¸æ“šé‚Šç•Œæ§åˆ¶ (é‡è¦!)](#4-æ•¸æ“šé‚Šç•Œæ§åˆ¶-é‡è¦)
5. [å®‰å…¨æ€§èˆ‡é™åˆ¶](#5-å®‰å…¨æ€§èˆ‡é™åˆ¶)
6. [é–‹ç™¼æ³¨æ„äº‹é …](#6-é–‹ç™¼æ³¨æ„äº‹é …)
7. [æ¸¬è©¦ç­–ç•¥](#7-æ¸¬è©¦ç­–ç•¥)
8. [éƒ¨ç½²æª¢æŸ¥æ¸…å–®](#8-éƒ¨ç½²æª¢æŸ¥æ¸…å–®)
9. [æœªä¾†æ“´å±•æ–¹å‘](#9-æœªä¾†æ“´å±•æ–¹å‘)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

**æ³•å®˜èªæ„AIåŠ©æ‰‹**æ˜¯ä¸€å€‹åŸºæ–¼ GPT-4 çš„æ™ºèƒ½å°è©±ç³»çµ±,å…è¨±å¾‹å¸«é€éè‡ªç„¶èªè¨€èˆ‡æ³•å®˜åˆ¤æ±ºæ•¸æ“šé€²è¡Œæ·±åº¦äº’å‹•ã€‚

**æ ¸å¿ƒåƒ¹å€¼**:
- âœ… **çªç ´å‚³çµ±çµ±è¨ˆä»‹é¢çš„é™åˆ¶**: å¾ã€Œè¢«å‹•æŸ¥çœ‹æ•¸æ“šã€å‡ç´šç‚ºã€Œä¸»å‹•æ¢ç´¢æ´å¯Ÿã€
- âœ… **æä¾›å¯æ“ä½œçš„è¨´è¨Ÿå»ºè­°**: ä¸åªæ˜¯çµ±è¨ˆæ•¸å­—,è€Œæ˜¯å…·é«”çš„è­‰æ“šæº–å‚™å’Œç­–ç•¥å»ºè­°
- âœ… **æ”¯æ´é€£çºŒè¿½å•**: ç¬¦åˆå¾‹å¸«çš„æ€è€ƒæµç¨‹,å¯ä»¥é€æ­¥æ·±å…¥æ¢ç´¢
- âœ… **åš´æ ¼çš„æ•¸æ“šé‚Šç•Œæ§åˆ¶**: åªå›ç­”åŸºæ–¼åˆ¤æ±ºæ›¸çš„å•é¡Œ,æ‹’çµ•æ³•å®˜å€‹äººè³‡è¨ŠæŸ¥è©¢

### 1.2 èˆ‡ç¾æœ‰æ³•å®˜æœç´¢é é¢çš„æ•´åˆ

**æ•´åˆæ–¹å¼**:
- éš±è—åŸæœ‰çš„ã€Œè£åˆ¤å‚¾å‘åˆ†æ (AI)ã€å’Œã€Œå¸¸ç”¨æ³•å¾‹ä¾æ“šã€å…©å€‹å€å¡Š
- æ–°å¢ã€Œæ™ºèƒ½æ³•å®˜åˆ†æåŠ©æ‰‹ã€å°è©±é¢æ¿
- ä¿ç•™ã€Œæ³•å®˜åŸºæœ¬ä»‹ç´¹ã€å’Œã€Œæ¡ˆä»¶åˆ†å¸ƒè³‡è¨Šã€

**å¸ƒå±€çµæ§‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¦å´å›ºå®šé¢æ¿ (300px)  â”‚  ä¸»å…§å®¹å€åŸŸ                    â”‚
â”‚  â”œâ”€ è¿”å›æŒ‰éˆ•           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â””â”€ æ³•å®˜åŸºæœ¬ä»‹ç´¹       â”‚  â”‚ æ¡ˆä»¶é¡å‹åˆ‡æ›æŒ‰éˆ•           â”‚â”‚
â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                        â”‚  â”‚ æ¡ˆä»¶åˆ†å¸ƒ â”‚ æ™ºèƒ½å°è©±é¢æ¿     â”‚â”‚
â”‚                        â”‚  â”‚ çµ±è¨ˆ     â”‚                  â”‚â”‚
â”‚                        â”‚  â”‚          â”‚ â€¢ å°è©±æ­·å²       â”‚â”‚
â”‚                        â”‚  â”‚ â€¢ æ¡ˆä»¶   â”‚ â€¢ å»ºè­°å•é¡Œ       â”‚â”‚
â”‚                        â”‚  â”‚   é¡å‹   â”‚ â€¢ è¼¸å…¥æ¡†         â”‚â”‚
â”‚                        â”‚  â”‚   çµ±è¨ˆ   â”‚ â€¢ è­¦å‘Šæç¤º       â”‚â”‚
â”‚                        â”‚  â”‚          â”‚                  â”‚â”‚
â”‚                        â”‚  â”‚ â€¢ ä»£è¡¨æ€§ â”‚                  â”‚â”‚
â”‚                        â”‚  â”‚   æ¡ˆä¾‹   â”‚                  â”‚â”‚
â”‚                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç”¨æˆ¶ä½¿ç”¨å ´æ™¯

**å ´æ™¯ 1: æ¡ˆä»¶é¡å‹æ¢ç´¢**
```
å¾‹å¸«: ã€Œé€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„é›¢å©šæ¡ˆä»¶?ã€
AI: ã€Œå‘‚å®‰æ¨‚æ³•å®˜å…±è™•ç† 15 ä»¶é›¢å©šæ¡ˆä»¶,åˆ†é¡å¦‚ä¸‹:
     1. å”è­°é›¢å©š (6ä»¶, 40%)
     2. è£åˆ¤é›¢å©š (9ä»¶, 60%)
        - æ¶‰åŠå­å¥³ç›£è­·æ¬Š: 8ä»¶
        - æ¶‰åŠè²¡ç”¢åˆ†é…: 7ä»¶
     æ‚¨æƒ³æ·±å…¥äº†è§£å“ªä¸€é¡æ¡ˆä»¶?ã€
```

**å ´æ™¯ 2: åˆ¤æ±ºå‚¾å‘åˆ†æ**
```
å¾‹å¸«: ã€Œåœ¨å­å¥³ç›£è­·æ¬Šçˆ­è­°ä¸­,æ³•å®˜é€šå¸¸å¦‚ä½•åˆ¤æ±º?ã€
AI: ã€Œæ ¹æ“š 8 ä»¶ç›¸é—œæ¡ˆä¾‹:
     â€¢ å…±åŒç›£è­·: 62.5%
     â€¢ å–®ç¨ç›£è­· (æ¯è¦ª): 25%
     â€¢ å–®ç¨ç›£è­· (çˆ¶è¦ª): 12.5%
     
     æ³•å®˜é‡è¦–çš„è­‰æ“š:
     1. å­å¥³æ„é¡˜é™³è¿° (100%)
     2. é›™æ–¹ç¶“æ¿Ÿèƒ½åŠ› (87.5%)
     3. å®¶åº­è¨ªè¦–å ±å‘Š (75%)ã€
```

**å ´æ™¯ 3: è­‰æ“šç­–ç•¥å»ºè­°**
```
å¾‹å¸«: ã€Œæˆ‘æ‡‰è©²æº–å‚™å“ªäº›è­‰æ“š?ã€
AI: ã€Œå»ºè­°æº–å‚™:
     âœ… å¿…å‚™è­‰æ“š:
        - å­å¥³ç…§é¡§ç´€éŒ„
        - ç¶“æ¿Ÿèƒ½åŠ›è­‰æ˜
        - å±…ä½ç’°å¢ƒèªªæ˜
     
     âœ… åŠ åˆ†è­‰æ“š:
        - å­å¥³æ„é¡˜é™³è¿°
        - å®¶åº­è¨ªè¦–å ±å‘Š
     
     âŒ é¿å…éŒ¯èª¤:
        - éåº¦å¼·èª¿å°æ–¹ç¼ºé»
        - æä¾›éæ™‚è­‰æ“š (>1å¹´)ã€
```

---

## 2. å‰ç«¯å¯¦ä½œç¸½çµ (å·²å®Œæˆ)

### 2.1 å·²ä¿®æ”¹çš„æ–‡ä»¶æ¸…å–®

#### âœ… æ–°å¢æ–‡ä»¶

1. **`lawsowl/src/components/judge/JudgeConversationPanel.js`**
   - æ™ºèƒ½å°è©±é¢æ¿ä¸»çµ„ä»¶
   - å°è©±æ¶ˆæ¯åˆ—è¡¨é¡¯ç¤º
   - ç”¨æˆ¶è¼¸å…¥è™•ç†
   - å»ºè­°å•é¡Œå¿«é€Ÿé¸æ“‡
   - åŠ è¼‰ç‹€æ…‹å‹•ç•«

2. **`lawsowl/src/components/judge/JudgeConversationPanel.css`**
   - å°è©±é¢æ¿å®Œæ•´æ¨£å¼
   - æ¼¸è®Šè‰²æ¨™é¡Œè¨­è¨ˆ
   - æ¶ˆæ¯æ°£æ³¡æ¨£å¼ (AI/ç”¨æˆ¶å€åˆ†)
   - æ»‘å…¥å‹•ç•«æ•ˆæœ
   - éŸ¿æ‡‰å¼å¸ƒå±€

#### âœ… ä¿®æ”¹æ–‡ä»¶

1. **`lawsowl/src/components/SearchJudgeResults.js`**
   - éš±è— `JudgeTendencyAnalysis` çµ„ä»¶ (ç¬¬ 11 è¡Œè¨»è§£)
   - éš±è— `JudgeLegalAnalysisCharts` çµ„ä»¶ (ç¬¬ 10 è¡Œè¨»è§£)
   - æ–°å¢ `JudgeConversationPanel` çµ„ä»¶å°å…¥ (ç¬¬ 13 è¡Œ)
   - èª¿æ•´å¸ƒå±€ç‚ºå…©æ¬„çµæ§‹ (ç¬¬ 573-621 è¡Œ)

2. **`lawsowl/src/JudgeAnalysis.css`**
   - æ–°å¢ `.unified-content-three-column` æ¨£å¼ (ç¬¬ 394-396 è¡Œ)
   - æ–°å¢ `.case-stats-pane-unified` æ¨£å¼ (ç¬¬ 399-404 è¡Œ)
   - æ–°å¢ `.conversation-pane-unified` æ¨£å¼ (ç¬¬ 407-412 è¡Œ)
   - æ›´æ–°éŸ¿æ‡‰å¼è¨­è¨ˆ (ç¬¬ 779-800 è¡Œ)

### 2.2 æ–°å¢çµ„ä»¶èªªæ˜

#### JudgeConversationPanel çµ„ä»¶

**Props**:
```javascript
{
  judgeName: string,    // æ³•å®˜å§“å
  judgeData: object     // æ³•å®˜å®Œæ•´æ•¸æ“š (ç”¨æ–¼æœªä¾†æ“´å±•)
}
```

**State**:
```javascript
{
  messages: Array,      // å°è©±æ¶ˆæ¯åˆ—è¡¨
  inputValue: string,   // ç•¶å‰è¼¸å…¥å€¼
  isLoading: boolean    // åŠ è¼‰ç‹€æ…‹
}
```

**é—œéµåŠŸèƒ½**:
1. **æ¶ˆæ¯ç®¡ç†**: ç¶­è­·å°è©±æ­·å²,æ”¯æ´ç”¨æˆ¶å’Œ AI æ¶ˆæ¯
2. **å»ºè­°å•é¡Œ**: åˆæ¬¡é€²å…¥æ™‚é¡¯ç¤º 4 å€‹å»ºè­°å•é¡Œ
3. **è‡ªå‹•æ»¾å‹•**: æ–°æ¶ˆæ¯è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
4. **Enter ç™¼é€**: æ”¯æ´ Enter éµå¿«é€Ÿç™¼é€ (Shift+Enter æ›è¡Œ)
5. **æ•¸æ“šé‚Šç•Œè­¦å‘Š**: é¡¯ç¤ºé»ƒè‰²è­¦å‘Šæ¡†,æé†’ç”¨æˆ¶æŸ¥è©¢é™åˆ¶

**ç›®å‰ç‹€æ…‹**:
- âœ… UI å®Œæ•´å¯¦ä½œ
- âœ… æœ¬åœ°ç‹€æ…‹ç®¡ç†
- â³ API èª¿ç”¨é‚è¼¯ (ä½”ä½å¯¦ä½œ,å¾…å¾Œç«¯å®Œæˆå¾Œæ•´åˆ)

### 2.3 å¸ƒå±€èª¿æ•´èªªæ˜

**éš±è—çš„çµ„ä»¶** (ä¿ç•™ä»£ç¢¼,æœªä¾†å¯æ¢å¾©):
```javascript
// ç¬¬ 598-618 è¡Œå·²è¨»è§£
/*
<div className="detailed-analysis-pane-unified">
  <JudgeTendencyAnalysis ... />
  <JudgeLegalAnalysisCharts ... />
</div>
*/
```

**æ–°å¢çš„å°è©±é¢æ¿**:
```javascript
// ç¬¬ 593-597 è¡Œ
<div className="conversation-pane-unified">
  <JudgeConversationPanel 
    judgeName={displayJudgeData.name}
    judgeData={displayJudgeData}
  />
</div>
```

### 2.4 å‰ç«¯ä»£ç¢¼ç‰‡æ®µ

#### æ¶ˆæ¯ç™¼é€é‚è¼¯ (ç›®å‰ç‚ºä½”ä½å¯¦ä½œ)

```javascript
// JudgeConversationPanel.js ç¬¬ 48-70 è¡Œ
const handleSendMessage = async () => {
  if (!inputValue.trim() || isLoading) return;

  const userMessage = {
    id: Date.now(),
    type: 'user',
    content: inputValue.trim(),
    timestamp: new Date()
  };

  setMessages(prev => [...prev, userMessage]);
  setInputValue('');
  setIsLoading(true);

  // TODO: å¯¦éš› API èª¿ç”¨å°‡åœ¨å¾ŒçºŒå¯¦ä½œ
  setTimeout(() => {
    const aiMessage = {
      id: Date.now() + 1,
      type: 'ai',
      content: 'æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­,å³å°‡ç‚ºæ‚¨æä¾›è©³ç´°çš„æ³•å®˜åˆ†æ...',
      timestamp: new Date()
    };
    setMessages(prev => [...prev, aiMessage]);
    setIsLoading(false);
  }, 1000);
};
```

#### å»ºè­°å•é¡Œé»æ“Šè™•ç†

```javascript
// JudgeConversationPanel.js ç¬¬ 73-76 è¡Œ
const handleSuggestedQuestionClick = (question) => {
  setInputValue(question);
  inputRef.current?.focus();
};
```

---

## 3. å¾Œç«¯å¯¦ä½œæ–¹æ¡ˆ (å¾…é–‹ç™¼)

### 3.1 æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

#### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React)                          â”‚
â”‚  JudgeConversationPanel.js                              â”‚
â”‚  â”œâ”€ ç”¨æˆ¶è¼¸å…¥                                            â”‚
â”‚  â”œâ”€ å°è©±æ­·å²                                            â”‚
â”‚  â””â”€ å»ºè­°å•é¡Œ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ POST /api/judges/:judgeName/chat
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¾Œç«¯ API å±¤ (Express)                       â”‚
â”‚  routes/judges.js                                       â”‚
â”‚  â”œâ”€ èº«ä»½é©—è­‰ (Firebase Auth)                           â”‚
â”‚  â”œâ”€ Rate Limiting                                       â”‚
â”‚  â””â”€ è¼¸å…¥é©—è­‰                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æœå‹™å±¤ (Business Logic)                        â”‚
â”‚  services/judgeConversationService.js                   â”‚
â”‚  â”œâ”€ 1. åˆ†æç”¨æˆ¶æ„åœ– (GPT-4)                            â”‚
â”‚  â”œâ”€ 2. é©—è­‰æ•¸æ“šé‚Šç•Œ                                     â”‚
â”‚  â”œâ”€ 3. æª¢ç´¢ç›¸é—œæ•¸æ“š (Elasticsearch)                    â”‚
â”‚  â”œâ”€ 4. ç”Ÿæˆ AI å›ç­” (GPT-4)                            â”‚
â”‚  â””â”€ 5. æ ¼å¼åŒ–å›æ‡‰                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI API   â”‚    â”‚ Elasticsearch    â”‚
â”‚ (GPT-4)      â”‚    â”‚ (judgement index)â”‚
â”‚              â”‚    â”‚                  â”‚
â”‚ â€¢ æ„åœ–åˆ†æ   â”‚    â”‚ â€¢ æ¡ˆä»¶çµ±è¨ˆ       â”‚
â”‚ â€¢ å›ç­”ç”Ÿæˆ   â”‚    â”‚ â€¢ æ¡ˆä¾‹æª¢ç´¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â€¢ èšåˆåˆ†æ       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æª”æ¡ˆçµæ§‹

```
courtDataAPI/
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ judges.js                     (ä¿®æ”¹: æ–°å¢ /chat ç«¯é»)
â”œâ”€â”€ services/
â”‚   â””â”€â”€ judgeConversationService.js   (æ–°å¢: æ ¸å¿ƒå°è©±æœå‹™)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ judgeQueryAnalyzer.js         (æ–°å¢: æ„åœ–åˆ†æ)
â”‚   â”œâ”€â”€ judgeDataRetriever.js         (æ–°å¢: æ•¸æ“šæª¢ç´¢)
â”‚   â””â”€â”€ responseFormatter.js          (æ–°å¢: å›æ‡‰æ ¼å¼åŒ–)
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ chatRateLimiter.js            (æ–°å¢: é€Ÿç‡é™åˆ¶)
â””â”€â”€ tests/
    â””â”€â”€ judgeConversation.test.js     (æ–°å¢: å–®å…ƒæ¸¬è©¦)
```

### 3.2 API ç«¯é»è¦æ ¼

#### POST /api/judges/:judgeName/chat

**è«‹æ±‚æ ¼å¼**:
```json
{
  "message": "é€™ä½æ³•å®˜åœ¨é›¢å©šæ¡ˆä»¶ä¸­å¦‚ä½•è™•ç†å­å¥³ç›£è­·æ¬Š?",
  "conversationHistory": [
    {
      "role": "user",
      "content": "é€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„æ¡ˆä»¶?"
    },
    {
      "role": "assistant",
      "content": "æ ¹æ“šæ•¸æ“šåº«è¨˜éŒ„,å‘‚å®‰æ¨‚æ³•å®˜å…±è™•ç†é..."
    }
  ]
}
```

**æˆåŠŸå›æ‡‰** (200 OK):
```json
{
  "success": true,
  "data": {
    "message": "æ ¹æ“šåˆ†æ 8 ä»¶ç›¸é—œæ¡ˆä¾‹,å‘‚å®‰æ¨‚æ³•å®˜åœ¨å­å¥³ç›£è­·æ¬Šçˆ­è­°ä¸­...",
    "sources": [
      {
        "type": "case",
        "caseId": "TPHV,111,å®¶ä¸Š,123",
        "relevance": "high",
        "summary": "åˆ¤æ±ºå…±åŒç›£è­·,å¼·èª¿é›™æ–¹å”å•†"
      },
      {
        "type": "statistics",
        "metric": "custody_decision_rate",
        "value": 0.625,
        "sampleSize": 8,
        "description": "å…±åŒç›£è­·æ¯”ä¾‹"
      }
    ],
    "dataRange": {
      "startDate": "2020-01-01",
      "endDate": "2024-12-31",
      "totalCases": 8
    },
    "confidence": "high"
  }
}
```

**æ•¸æ“šé‚Šç•Œè­¦å‘Š** (200 OK):
```json
{
  "success": true,
  "data": {
    "message": "æŠ±æ­‰,æˆ‘ç„¡æ³•å›ç­”é—œæ–¼æ³•å®˜å€‹äººè³‡è¨Šçš„å•é¡Œ...",
    "type": "boundary_warning",
    "suggestedQuestions": [
      "é€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„æ¡ˆä»¶?",
      "åœ¨æ°‘äº‹æ¡ˆä»¶ä¸­,æ³•å®˜çš„åˆ¤æ±ºå‚¾å‘å¦‚ä½•?"
    ]
  }
}
```

**éŒ¯èª¤å›æ‡‰** (400 Bad Request):
```json
{
  "success": false,
  "error": "Invalid message format",
  "code": "INVALID_INPUT"
}
```

**éŒ¯èª¤å›æ‡‰** (429 Too Many Requests):
```json
{
  "success": false,
  "error": "è«‹æ±‚éæ–¼é »ç¹,è«‹ç¨å¾Œå†è©¦",
  "code": "RATE_LIMIT_EXCEEDED",
  "retryAfter": 900
}
```

**éŒ¯èª¤å›æ‡‰** (500 Internal Server Error):
```json
{
  "success": false,
  "error": "è™•ç†æ‚¨çš„å•é¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤,è«‹ç¨å¾Œå†è©¦",
  "code": "INTERNAL_ERROR"
}
```

### 3.3 æ ¸å¿ƒæœå‹™é¡åˆ¥å®Œæ•´ä»£ç¢¼

#### 3.3.1 judgeConversationService.js (æ ¸å¿ƒå°è©±æœå‹™)

```javascript
// services/judgeConversationService.js

const { OpenAI } = require('openai');
const judgeDataRetriever = require('../utils/judgeDataRetriever');
const responseFormatter = require('../utils/responseFormatter');

class JudgeConversationService {
  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });
  }

  /**
   * è™•ç†æ³•å®˜å°è©±è«‹æ±‚
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {string} userMessage - ç”¨æˆ¶å•é¡Œ
   * @param {Array} conversationHistory - å°è©±æ­·å²
   * @returns {Promise<Object>} æ ¼å¼åŒ–çš„å›æ‡‰
   */
  async handleConversation(judgeName, userMessage, conversationHistory = []) {
    try {
      console.log(`[JudgeConversation] è™•ç†æ³•å®˜ ${judgeName} çš„å•é¡Œ: ${userMessage}`);

      // 1. åˆ†æç”¨æˆ¶æ„åœ–
      const intent = await this.analyzeUserIntent(userMessage, conversationHistory);
      console.log('[JudgeConversation] æ„åœ–åˆ†æçµæœ:', JSON.stringify(intent, null, 2));

      // 2. é©—è­‰å•é¡Œæ˜¯å¦åœ¨æ•¸æ“šé‚Šç•Œå…§
      const validation = this.validateQuery(intent, userMessage);
      if (!validation.isValid) {
        console.log(`[JudgeConversation] æ•¸æ“šé‚Šç•Œè­¦å‘Š: ${validation.reason}`);
        return this.createBoundaryResponse(validation.reason);
      }

      // 3. å¾ Elasticsearch æª¢ç´¢ç›¸é—œæ•¸æ“š
      const data = await judgeDataRetriever.retrieveData(judgeName, intent);
      console.log(`[JudgeConversation] æª¢ç´¢åˆ° ${data.totalCases || 0} ä»¶ç›¸é—œæ¡ˆä¾‹`);

      // 4. æª¢æŸ¥æ•¸æ“šå……åˆ†æ€§
      if (data.totalCases === 0) {
        return {
          message: `æŠ±æ­‰,åœ¨è³‡æ–™åº«ä¸­æ‰¾ä¸åˆ° ${judgeName} æ³•å®˜ç¬¦åˆæ‚¨æŸ¥è©¢æ¢ä»¶çš„æ¡ˆä»¶ã€‚è«‹å˜—è©¦èª¿æ•´æŸ¥è©¢æ¢ä»¶æˆ–è©¢å•å…¶ä»–å•é¡Œã€‚`,
          type: 'no_data',
          suggestedQuestions: [
            'é€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„æ¡ˆä»¶?',
            'æ³•å®˜æœ€è¿‘ä¸‰å¹´çš„æ¡ˆä»¶æ•¸é‡?'
          ]
        };
      }

      // 5. ä½¿ç”¨ GPT-4 ç”Ÿæˆå›ç­”
      const response = await this.generateResponse(
        userMessage,
        data,
        conversationHistory,
        judgeName
      );

      // 6. æ ¼å¼åŒ–å›æ‡‰
      return responseFormatter.format(response, data, intent);

    } catch (error) {
      console.error('[JudgeConversation] éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * åˆ†æç”¨æˆ¶æ„åœ–
   * @param {string} userMessage - ç”¨æˆ¶å•é¡Œ
   * @param {Array} conversationHistory - å°è©±æ­·å²
   * @returns {Promise<Object>} æ„åœ–åˆ†æçµæœ
   */
  async analyzeUserIntent(userMessage, conversationHistory) {
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹æ³•å®˜æ•¸æ“šæŸ¥è©¢æ„åœ–åˆ†æå™¨ã€‚
åˆ†æç”¨æˆ¶å•é¡Œ,æå–ä»¥ä¸‹è³‡è¨Š:

1. queryType (å•é¡Œé¡å‹):
   - "case_statistics": æ¡ˆä»¶çµ±è¨ˆ (æ•¸é‡ã€é¡å‹åˆ†å¸ƒç­‰)
   - "case_examples": æ¡ˆä¾‹æª¢ç´¢ (è¦æ±‚å…·é«”æ¡ˆä¾‹)
   - "verdict_analysis": åˆ¤æ±ºçµæœåˆ†æ (å‹è¨´ç‡ã€åˆ¤æ±ºå‚¾å‘)
   - "amount_analysis": é‡‘é¡åˆ†æ (æ°‘äº‹æ¡ˆä»¶çš„è«‹æ±‚é‡‘é¡ã€åˆ¤å‡†é‡‘é¡)
   - "evidence_preference": è­‰æ“šåå¥½ (æ³•å®˜é‡è¦–çš„è­‰æ“šé¡å‹)
   - "legal_basis": æ³•å¾‹ä¾æ“šåˆ†æ (å¸¸ç”¨æ³•æ¢)
   - "time_trend": æ™‚é–“è¶¨å‹¢ (åˆ¤æ±ºå‚¾å‘éš¨æ™‚é–“è®ŠåŒ–)
   - "general_overview": ä¸€èˆ¬æ¦‚è¦½

2. caseType (æ¡ˆä»¶é¡å‹):
   - "civil": æ°‘äº‹
   - "criminal": åˆ‘äº‹
   - "labor": å‹å‹•
   - "administrative": è¡Œæ”¿
   - "all": å…¨éƒ¨

3. specificTopic (å…·é«”ä¸»é¡Œ):
   - ä¾‹å¦‚: "é›¢å©š", "å­å¥³ç›£è­·æ¬Š", "è²¡ç”¢åˆ†é…", "ä¾µæ¬Š", "å¥‘ç´„"ç­‰
   - å¦‚æœç„¡æ³•åˆ¤æ–·,è¨­ç‚º null

4. timeRange (æ™‚é–“ç¯„åœ):
   - å¦‚æœç”¨æˆ¶æåŠæ™‚é–“,æå– { start: "YYYY-MM-DD", end: "YYYY-MM-DD" }
   - å¦‚æœç„¡æåŠ,è¨­ç‚º null

5. filters (å…¶ä»–ç¯©é¸æ¢ä»¶):
   - ä¾‹å¦‚: { "hasLawyer": true, "verdictType": "åŸå‘Šå‹è¨´" }
   - å¦‚æœç„¡,è¨­ç‚º {}

**é‡è¦**: åªè¿”å› JSON æ ¼å¼,ä¸è¦å…¶ä»–æ–‡å­—ã€‚

ç¯„ä¾‹è¼¸å‡º:
{
  "queryType": "verdict_analysis",
  "caseType": "civil",
  "specificTopic": "é›¢å©š",
  "timeRange": null,
  "filters": {}
}`;

    const response = await this.openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        { role: 'system', content: systemPrompt },
        ...conversationHistory.slice(-3), // åªä¿ç•™æœ€è¿‘3è¼ªå°è©±
        { role: 'user', content: userMessage }
      ],
      temperature: 0.3,
      response_format: { type: 'json_object' }
    });

    return JSON.parse(response.choices[0].message.content);
  }

  /**
   * é©—è­‰å•é¡Œæ˜¯å¦åœ¨æ•¸æ“šé‚Šç•Œå…§
   * @param {Object} intent - æ„åœ–åˆ†æçµæœ
   * @param {string} userMessage - åŸå§‹ç”¨æˆ¶å•é¡Œ
   * @returns {Object} é©—è­‰çµæœ
   */
  validateQuery(intent, userMessage) {
    // æª¢æŸ¥æ˜¯å¦è©¢å•æ³•å®˜å€‹äººè³‡è¨Š
    const personalInfoKeywords = [
      'å¹´é½¡', 'å©šå§»', 'å­¸æ­·', 'å®¶åº­', 'å–®èº«', 'çµå©š', 'é…å¶',
      'å­å¥³', 'å‡ºç”Ÿ', 'ç•¢æ¥­', 'å­¸æ ¡', 'ä½å€', 'é›»è©±', 'ä¿¡ç®±'
    ];

    const lowerMessage = userMessage.toLowerCase();
    if (personalInfoKeywords.some(kw => lowerMessage.includes(kw))) {
      return {
        isValid: false,
        reason: 'personal_info'
      };
    }

    // æª¢æŸ¥æ™‚é–“ç¯„åœæ˜¯å¦è¶…å‡ºæ•¸æ“šåº«ç¯„åœ
    if (intent.timeRange) {
      const startYear = new Date(intent.timeRange.start).getFullYear();
      const endYear = new Date(intent.timeRange.end).getFullYear();

      // å‡è¨­æ•¸æ“šåº«åªæœ‰ 2020 å¹´å¾Œçš„æ•¸æ“š
      if (startYear < 2020 || endYear < 2020) {
        return {
          isValid: false,
          reason: 'out_of_range'
        };
      }
    }

    // æª¢æŸ¥æ˜¯å¦è©¢å•æœªä¾†é æ¸¬
    const futureKeywords = ['æœªä¾†', 'å°‡æœƒ', 'æœƒä¸æœƒ', 'é æ¸¬', 'é è¨ˆ'];
    if (futureKeywords.some(kw => lowerMessage.includes(kw))) {
      return {
        isValid: false,
        reason: 'future_prediction'
      };
    }

    return { isValid: true };
  }

  /**
   * å‰µå»ºé‚Šç•Œè­¦å‘Šå›æ‡‰
   * @param {string} reason - è­¦å‘ŠåŸå› 
   * @returns {Object} è­¦å‘Šå›æ‡‰
   */
  createBoundaryResponse(reason) {
    const responses = {
      personal_info: {
        message: 'æŠ±æ­‰,æˆ‘ç„¡æ³•å›ç­”é—œæ–¼æ³•å®˜å€‹äººè³‡è¨Šçš„å•é¡Œã€‚\n\næˆ‘åªèƒ½æä¾›åŸºæ–¼å…¬é–‹åˆ¤æ±ºæ›¸çš„æ¡ˆä»¶åˆ†ææ•¸æ“š,ä¾‹å¦‚:\n\nâ€¢ æ³•å®˜è™•ç†éçš„æ¡ˆä»¶é¡å‹å’Œæ•¸é‡\nâ€¢ åˆ¤æ±ºçµæœçµ±è¨ˆ\nâ€¢ ä»£è¡¨æ€§æ¡ˆä¾‹åˆ†æ\nâ€¢ æ³•å¾‹ä¾æ“šä½¿ç”¨æƒ…æ³\nâ€¢ æ°‘äº‹æ¡ˆä»¶é‡‘é¡çµ±è¨ˆ\n\nè«‹å•æ‚¨æƒ³äº†è§£å“ªæ–¹é¢çš„åˆ¤æ±ºæ•¸æ“š?',
        type: 'boundary_warning',
        suggestedQuestions: [
          'é€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„æ¡ˆä»¶?',
          'åœ¨æ°‘äº‹æ¡ˆä»¶ä¸­,æ³•å®˜çš„åˆ¤æ±ºå‚¾å‘å¦‚ä½•?',
          'æ³•å®˜æœ€é‡è¦–å“ªäº›è­‰æ“š?',
          'æœ‰æ²’æœ‰ä»£è¡¨æ€§çš„åˆ¤æ±ºæ¡ˆä¾‹?'
        ]
      },
      out_of_range: {
        message: 'æŠ±æ­‰,æˆ‘å€‘çš„æ•¸æ“šåº«ç›®å‰åªåŒ…å« 2020 å¹´è‡³ä»Šçš„åˆ¤æ±ºæ•¸æ“šã€‚\n\nå¦‚æœæ‚¨æƒ³äº†è§£é€™ä½æ³•å®˜è¿‘å¹´çš„åˆ¤æ±ºå‚¾å‘,æˆ‘å¯ä»¥ç‚ºæ‚¨åˆ†æ 2020 å¹´å¾Œçš„æ¡ˆä»¶ã€‚',
        type: 'boundary_warning',
        suggestedQuestions: [
          'é€™ä½æ³•å®˜ 2020 å¹´å¾Œè™•ç†éå“ªäº›æ¡ˆä»¶?',
          'æœ€è¿‘ä¸‰å¹´çš„åˆ¤æ±ºå‚¾å‘å¦‚ä½•?'
        ]
      },
      future_prediction: {
        message: 'æŠ±æ­‰,æˆ‘ç„¡æ³•é æ¸¬æ³•å®˜æœªä¾†çš„åˆ¤æ±ºçµæœã€‚\n\næˆ‘åªèƒ½åŸºæ–¼æ­·å²åˆ¤æ±ºæ•¸æ“šæä¾›è¶¨å‹¢åˆ†æå’Œçµ±è¨ˆè³‡è¨Š,å¹«åŠ©æ‚¨äº†è§£æ³•å®˜éå»çš„åˆ¤æ±ºå‚¾å‘ã€‚',
        type: 'boundary_warning',
        suggestedQuestions: [
          'é€™ä½æ³•å®˜éå»çš„åˆ¤æ±ºå‚¾å‘å¦‚ä½•?',
          'åœ¨é¡ä¼¼æ¡ˆä»¶ä¸­,æ³•å®˜é€šå¸¸å¦‚ä½•åˆ¤æ±º?'
        ]
      }
    };

    return responses[reason] || {
      message: 'æŠ±æ­‰,é€™å€‹å•é¡Œè¶…å‡ºäº†æˆ‘èƒ½å›ç­”çš„ç¯„åœã€‚è«‹å˜—è©¦è©¢å•èˆ‡åˆ¤æ±ºæ•¸æ“šç›¸é—œçš„å•é¡Œã€‚',
      type: 'boundary_warning',
      suggestedQuestions: [
        'é€™ä½æ³•å®˜è™•ç†éå“ªäº›é¡å‹çš„æ¡ˆä»¶?',
        'æ³•å®˜çš„åˆ¤æ±ºå‚¾å‘å¦‚ä½•?'
      ]
    };
  }

  /**
   * ä½¿ç”¨ GPT-4 ç”Ÿæˆå›ç­”
   * @param {string} userMessage - ç”¨æˆ¶å•é¡Œ
   * @param {Object} data - æª¢ç´¢åˆ°çš„æ•¸æ“š
   * @param {Array} conversationHistory - å°è©±æ­·å²
   * @param {string} judgeName - æ³•å®˜å§“å
   * @returns {Promise<string>} AI ç”Ÿæˆçš„å›ç­”
   */
  async generateResponse(userMessage, data, conversationHistory, judgeName) {
    const systemPrompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ³•å®˜åˆ¤æ±ºæ•¸æ“šåˆ†æåŠ©æ‰‹ã€‚

**é‡è¦è¦å‰‡**:
1. âœ… åªèƒ½åŸºæ–¼æä¾›çš„æ•¸æ“šå›ç­”å•é¡Œ,çµ•å°ä¸å¯ä»¥ç·¨é€ æ•¸æ“š
2. âœ… æ¯å€‹çµ±è¨ˆæ•¸å­—éƒ½å¿…é ˆæ¨™è¨»æ¨£æœ¬æ•¸é‡
3. âœ… å¦‚æœæ•¸æ“šä¸è¶³ (æ¨£æœ¬æ•¸ < 5),å¿…é ˆè­¦å‘Šç”¨æˆ¶ã€Œæ•¸æ“šé‡è¼ƒå°‘,åƒ…ä¾›åƒè€ƒã€
4. âœ… å¼•ç”¨å…·é«”æ¡ˆä¾‹æ™‚,å¿…é ˆæä¾›æ¡ˆä»¶ ID
5. âœ… ä½¿ç”¨å°ˆæ¥­ä½†æ˜“æ‡‚çš„èªè¨€
6. âœ… æä¾›å¯æ“ä½œçš„æ´å¯Ÿ,è€Œéå–®ç´”çš„æ•¸æ“šç¾…åˆ—
7. âœ… å¦‚æœæ•¸æ“šä¸­æ²’æœ‰ç›¸é—œè³‡è¨Š,æ˜ç¢ºå‘ŠçŸ¥ç”¨æˆ¶

**å›ç­”æ ¼å¼**:
1. **ç›´æ¥å›ç­”** (1-2 å¥è©±ç¸½çµ)
2. **è©³ç´°æ•¸æ“šåˆ†æ** (åˆ†é»åˆ—å‡º,ä½¿ç”¨ Markdown æ ¼å¼)
3. **ä»£è¡¨æ€§æ¡ˆä¾‹** (å¦‚æœç›¸é—œä¸”æ•¸æ“šä¸­æœ‰æä¾›)
4. **å¯¦å‹™å»ºè­°** (å¦‚æœé©ç”¨)

**æ•¸æ“šä¾†æº**:
${JSON.stringify(data, null, 2)}

**æ³•å®˜å§“å**: ${judgeName}`;

    const response = await this.openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        { role: 'system', content: systemPrompt },
        ...conversationHistory.slice(-5), // ä¿ç•™æœ€è¿‘5è¼ªå°è©±
        { role: 'user', content: userMessage }
      ],
      temperature: 0.7,
      max_tokens: 1500
    });

    return response.choices[0].message.content;
  }
}

module.exports = new JudgeConversationService();
```

#### 3.3.2 judgeDataRetriever.js (Elasticsearch æ•¸æ“šæª¢ç´¢)

```javascript
// utils/judgeDataRetriever.js

const { esClient } = require('../config/elasticsearch');

class JudgeDataRetriever {
  /**
   * æ ¹æ“šæ„åœ–æª¢ç´¢ç›¸é—œæ•¸æ“š
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {Object} intent - æ„åœ–åˆ†æçµæœ
   * @returns {Promise<Object>} æª¢ç´¢åˆ°çš„æ•¸æ“š
   */
  async retrieveData(judgeName, intent) {
    const { queryType, caseType, specificTopic, timeRange, filters } = intent;

    console.log(`[DataRetriever] æª¢ç´¢é¡å‹: ${queryType}, æ¡ˆä»¶é¡å‹: ${caseType}`);

    switch (queryType) {
      case 'case_statistics':
        return await this.getCaseStatistics(judgeName, caseType, timeRange);

      case 'case_examples':
        return await this.getCaseExamples(judgeName, caseType, specificTopic, filters);

      case 'verdict_analysis':
        return await this.getVerdictAnalysis(judgeName, caseType, specificTopic, timeRange);

      case 'amount_analysis':
        return await this.getAmountAnalysis(judgeName, timeRange);

      case 'evidence_preference':
        return await this.getEvidencePreference(judgeName, caseType, specificTopic);

      case 'legal_basis':
        return await this.getLegalBasisAnalysis(judgeName, caseType);

      case 'time_trend':
        return await this.getTimeTrend(judgeName, caseType, specificTopic);

      default:
        return await this.getGeneralOverview(judgeName);
    }
  }

  /**
   * ç²å–æ¡ˆä»¶çµ±è¨ˆæ•¸æ“š
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {string} caseType - æ¡ˆä»¶é¡å‹
   * @param {Object} timeRange - æ™‚é–“ç¯„åœ
   * @returns {Promise<Object>} çµ±è¨ˆæ•¸æ“š
   */
  async getCaseStatistics(judgeName, caseType = 'all', timeRange = null) {
    const query = {
      bool: {
        must: [
          { match: { 'judges.keyword': judgeName } }
        ]
      }
    };

    // æ·»åŠ æ¡ˆä»¶é¡å‹ç¯©é¸
    if (caseType !== 'all') {
      query.bool.must.push({ match: { 'stage0_case_type': caseType } });
    }

    // æ·»åŠ æ™‚é–“ç¯„åœç¯©é¸
    if (timeRange) {
      query.bool.must.push({
        range: {
          JDATE: {
            gte: timeRange.start,
            lte: timeRange.end
          }
        }
      });
    }

    try {
      const response = await esClient.search({
        index: 'judgement',
        body: {
          query,
          size: 0, // åªè¦èšåˆçµæœ
          aggs: {
            // æ¡ˆä»¶é¡å‹åˆ†å¸ƒ
            case_type_distribution: {
              terms: {
                field: 'stage0_case_type.keyword',
                size: 10
              }
            },
            // åˆ¤æ±ºçµæœåˆ†å¸ƒ
            verdict_distribution: {
              terms: {
                field: 'verdict_type.keyword',
                size: 20
              }
            },
            // å¹´åº¦è¶¨å‹¢
            yearly_trend: {
              date_histogram: {
                field: 'JDATE',
                calendar_interval: 'year'
              }
            },
            // æ°‘äº‹æ¡ˆä»¶é‡‘é¡çµ±è¨ˆ
            civil_amount_stats: {
              filter: { term: { 'stage0_case_type': 'civil' } },
              aggs: {
                avg_claim: {
                  avg: { field: 'key_metrics.civil_metrics.claim_amount' }
                },
                avg_granted: {
                  avg: { field: 'key_metrics.civil_metrics.granted_amount' }
                },
                total_with_amount: {
                  value_count: { field: 'key_metrics.civil_metrics.claim_amount' }
                }
              }
            }
          }
        }
      });

      return {
        totalCases: response.hits.total.value,
        caseTypeDistribution: response.aggregations.case_type_distribution.buckets,
        verdictDistribution: response.aggregations.verdict_distribution.buckets,
        yearlyTrend: response.aggregations.yearly_trend.buckets,
        civilAmountStats: response.aggregations.civil_amount_stats,
        queryType: 'case_statistics'
      };
    } catch (error) {
      console.error('[DataRetriever] getCaseStatistics éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * ç²å–ä»£è¡¨æ€§æ¡ˆä¾‹
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {string} caseType - æ¡ˆä»¶é¡å‹
   * @param {string} specificTopic - å…·é«”ä¸»é¡Œ
   * @param {Object} filters - å…¶ä»–ç¯©é¸æ¢ä»¶
   * @param {number} limit - è¿”å›æ•¸é‡é™åˆ¶
   * @returns {Promise<Object>} æ¡ˆä¾‹æ•¸æ“š
   */
  async getCaseExamples(judgeName, caseType, specificTopic, filters, limit = 5) {
    const query = {
      bool: {
        must: [
          { match: { 'judges.keyword': judgeName } }
        ]
      }
    };

    if (caseType !== 'all') {
      query.bool.must.push({ match: { 'stage0_case_type': caseType } });
    }

    // å¦‚æœæœ‰å…·é«”ä¸»é¡Œ,ä½¿ç”¨èªæ„æœç´¢
    if (specificTopic) {
      query.bool.must.push({
        multi_match: {
          query: specificTopic,
          fields: ['JTITLE^3', 'summary_ai^2', 'main_reasons_ai'],
          fuzziness: 'AUTO'
        }
      });
    }

    try {
      const response = await esClient.search({
        index: 'judgement',
        body: {
          query,
          size: limit,
          _source: [
            'JID', 'JYEAR', 'JCASE', 'JNO', 'JDATE', 'JTITLE',
            'verdict_type', 'summary_ai', 'main_reasons_ai',
            'key_metrics', 'SCORE', 'stage0_case_type'
          ],
          sort: [
            { SCORE: { order: 'desc' } }, // å„ªå…ˆé¡¯ç¤ºé«˜åˆ†æ¡ˆä»¶
            { 'JDATE': { order: 'desc' } } // å…¶æ¬¡æŒ‰æ™‚é–“æ’åº
          ]
        }
      });

      return {
        totalCases: response.hits.total.value,
        cases: response.hits.hits.map(hit => hit._source),
        queryType: 'case_examples'
      };
    } catch (error) {
      console.error('[DataRetriever] getCaseExamples éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * ç²å–åˆ¤æ±ºçµæœåˆ†æ
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {string} caseType - æ¡ˆä»¶é¡å‹
   * @param {string} specificTopic - å…·é«”ä¸»é¡Œ
   * @param {Object} timeRange - æ™‚é–“ç¯„åœ
   * @returns {Promise<Object>} åˆ¤æ±ºåˆ†ææ•¸æ“š
   */
  async getVerdictAnalysis(judgeName, caseType, specificTopic, timeRange) {
    const query = {
      bool: {
        must: [
          { match: { 'judges.keyword': judgeName } }
        ]
      }
    };

    if (caseType !== 'all') {
      query.bool.must.push({ match: { 'stage0_case_type': caseType } });
    }

    if (specificTopic) {
      query.bool.must.push({
        multi_match: {
          query: specificTopic,
          fields: ['JTITLE', 'summary_ai'],
          fuzziness: 'AUTO'
        }
      });
    }

    if (timeRange) {
      query.bool.must.push({
        range: {
          JDATE: {
            gte: timeRange.start,
            lte: timeRange.end
          }
        }
      });
    }

    try {
      const response = await esClient.search({
        index: 'judgement',
        body: {
          query,
          size: 0,
          aggs: {
            verdict_types: {
              terms: {
                field: 'verdict_type.keyword',
                size: 20
              }
            },
            disposition_class: {
              terms: {
                field: 'disposition.class.keyword',
                size: 10
              }
            }
          }
        }
      });

      return {
        totalCases: response.hits.total.value,
        verdictTypes: response.aggregations.verdict_types.buckets,
        dispositionClass: response.aggregations.disposition_class.buckets,
        queryType: 'verdict_analysis'
      };
    } catch (error) {
      console.error('[DataRetriever] getVerdictAnalysis éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * ç²å–æ°‘äº‹æ¡ˆä»¶é‡‘é¡åˆ†æ
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {Object} timeRange - æ™‚é–“ç¯„åœ
   * @returns {Promise<Object>} é‡‘é¡åˆ†ææ•¸æ“š
   */
  async getAmountAnalysis(judgeName, timeRange) {
    const query = {
      bool: {
        must: [
          { match: { 'judges.keyword': judgeName } },
          { term: { 'stage0_case_type': 'civil' } },
          { exists: { field: 'key_metrics.civil_metrics.claim_amount' } }
        ]
      }
    };

    if (timeRange) {
      query.bool.must.push({
        range: {
          JDATE: {
            gte: timeRange.start,
            lte: timeRange.end
          }
        }
      });
    }

    try {
      const response = await esClient.search({
        index: 'judgement',
        body: {
          query,
          size: 0,
          aggs: {
            claim_amount_stats: {
              stats: { field: 'key_metrics.civil_metrics.claim_amount' }
            },
            granted_amount_stats: {
              stats: { field: 'key_metrics.civil_metrics.granted_amount' }
            },
            amount_ranges: {
              range: {
                field: 'key_metrics.civil_metrics.claim_amount',
                ranges: [
                  { to: 100000, key: '10è¬ä»¥ä¸‹' },
                  { from: 100000, to: 500000, key: '10-50è¬' },
                  { from: 500000, to: 1000000, key: '50-100è¬' },
                  { from: 1000000, to: 5000000, key: '100-500è¬' },
                  { from: 5000000, key: '500è¬ä»¥ä¸Š' }
                ]
              }
            }
          }
        }
      });

      return {
        totalCases: response.hits.total.value,
        claimAmountStats: response.aggregations.claim_amount_stats,
        grantedAmountStats: response.aggregations.granted_amount_stats,
        amountRanges: response.aggregations.amount_ranges.buckets,
        queryType: 'amount_analysis'
      };
    } catch (error) {
      console.error('[DataRetriever] getAmountAnalysis éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * ç²å–æ³•å¾‹ä¾æ“šåˆ†æ
   * @param {string} judgeName - æ³•å®˜å§“å
   * @param {string} caseType - æ¡ˆä»¶é¡å‹
   * @returns {Promise<Object>} æ³•å¾‹ä¾æ“šæ•¸æ“š
   */
  async getLegalBasisAnalysis(judgeName, caseType) {
    const query = {
      bool: {
        must: [
          { match: { 'judges.keyword': judgeName } },
          { exists: { field: 'legal_claim_basis' } }
        ]
      }
    };

    if (caseType !== 'all') {
      query.bool.must.push({ match: { 'stage0_case_type': caseType } });
    }

    try {
      const response = await esClient.search({
        index: 'judgement',
        body: {
          query,
          size: 100,
          _source: ['JID', 'legal_claim_basis', 'JTITLE']
        }
      });

      // çµ±è¨ˆæ³•å¾‹ä¾æ“šå‡ºç¾é »ç‡
      const legalBasisFrequency = {};
      response.hits.hits.forEach(hit => {
        const legalBasis = hit._source.legal_claim_basis;
        if (Array.isArray(legalBasis)) {
          legalBasis.forEach(law => {
            legalBasisFrequency[law] = (legalBasisFrequency[law] || 0) + 1;
          });
        }
      });

      // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
      const sortedLegalBasis = Object.entries(legalBasisFrequency)
        .map(([law, count]) => ({ law, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 20);

      return {
        totalCases: response.hits.total.value,
        legalBasisFrequency: sortedLegalBasis,
        queryType: 'legal_basis'
      };
    } catch (error) {
      console.error('[DataRetriever] getLegalBasisAnalysis éŒ¯èª¤:', error);
      throw error;
    }
  }

  /**
   * ç²å–ä¸€èˆ¬æ¦‚è¦½
   * @param {string} judgeName - æ³•å®˜å§“å
   * @returns {Promise<Object>} æ¦‚è¦½æ•¸æ“š
   */
  async getGeneralOverview(judgeName) {
    return await this.getCaseStatistics(judgeName, 'all', null);
  }
}

module.exports = new JudgeDataRetriever();
```


