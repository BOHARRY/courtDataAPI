# æ¡ˆç”±æœå°‹ - é–€æª»èª¿æ•´å ±å‘Š

## ğŸ› å•é¡Œè¨ºæ–·

### å•é¡Œ 1: Layer 1 è¿”å›éå¤šçµæœ

**ç¾è±¡**:
```
[CaseDescriptionSearch] ES è¿”å›ç¸½æ•¸: 9891
[CaseDescriptionSearch] Layer 1 å®Œæˆ: 200 ç­†å€™é¸
```

**åŸå› **:
- `minimum_should_match: 1` å¤ªå¯¬é¬†
- 10 å€‹é—œéµè©ä¸­åªè¦å‘½ä¸­ 1 å€‹å°±ç®—
- ã€Œæ‰¿ç§Ÿäººã€ã€ã€Œå‡ºç§Ÿäººã€ã€ã€Œç§Ÿè³ƒå¥‘ç´„ã€ç­‰è©åœ¨æ°‘äº‹åˆ¤æ±ºä¸­æ¥µç‚ºå¸¸è¦‹
- çµæœï¼šå¹¾ä¹æ‰€æœ‰æ°‘äº‹åˆ¤æ±ºï¼ˆ9,891 / 10,515 = 94%ï¼‰éƒ½è¢«åŒ¹é…

**ä¿®æ­£**:
```javascript
// ä¿®æ­£å‰
minimum_should_match: 1  // âŒ åªè¦å‘½ä¸­ 1 å€‹è©

// ä¿®æ­£å¾Œ
const minimumMatch = Math.max(2, Math.ceil(totalClauses * 0.3));  // âœ… è‡³å°‘ 30% æˆ– 2 å€‹è©
```

**é æœŸæ•ˆæœ**:
- 10 å€‹è© â†’ è‡³å°‘å‘½ä¸­ 3 å€‹è©
- æ‡‰è©²èƒ½å°‡çµæœå¾ 9,891 ç­†é™ä½åˆ° 1,000-2,000 ç­†å·¦å³

---

### å•é¡Œ 2: Layer 2 é–€æª»éé«˜

**ç¾è±¡**:
```
[CaseDescriptionSearch] å€™é¸ 0: similarity = 0.6266
[CaseDescriptionSearch] å€™é¸ 1: similarity = 0.5415
[CaseDescriptionSearch] å€™é¸ 2: similarity = 0.5778
[CaseDescriptionSearch] ç›¸ä¼¼åº¦ç¯„åœ: 0.3921 ~ 0.6587, å¹³å‡: 0.5564
[CaseDescriptionSearch] Layer 2 å®Œæˆ: 0 ç­†å€™é¸  âŒ
```

**åŸå› **:
- é–€æª»è¨­å®š: **0.70**
- å¯¦éš›æœ€é«˜ç›¸ä¼¼åº¦: **0.6587**
- æ‰€æœ‰ 200 ç­†å€™é¸éƒ½è¢«éæ¿¾æ‰äº†ï¼

**åˆ†æ**:
- å¹³å‡ç›¸ä¼¼åº¦: 0.5564
- æœ€é«˜ç›¸ä¼¼åº¦: 0.6587
- é–€æª» 0.70 éé«˜ï¼Œå°è‡´é›¶çµæœ

**ä¿®æ­£**:
```javascript
// ä¿®æ­£å‰
threshold = 0.70  // âŒ éé«˜

// ä¿®æ­£å¾Œ
threshold = 0.55  // âœ… ç•¥é«˜æ–¼å¹³å‡å€¼ï¼Œèƒ½ä¿ç•™é«˜å“è³ªçµæœ
```

**é æœŸæ•ˆæœ**:
- é–€æª» 0.55 æ‡‰è©²èƒ½ä¿ç•™ç´„ 50-60% çš„å€™é¸ï¼ˆ100-120 ç­†ï¼‰
- é€™äº›å€™é¸çš„ç›¸ä¼¼åº¦éƒ½åœ¨å¹³å‡å€¼ä»¥ä¸Š

---

## âœ… ä¿®æ­£æ–¹æ¡ˆ

### ä¿®æ­£ 1: å‹•æ…‹èª¿æ•´ minimum_should_match

**ä½ç½®**: `services/caseDescriptionSearchService.js` Line 144-178

**ä¿®æ­£å…§å®¹**:
```javascript
// å‹•æ…‹è¨ˆç®— minimum_should_match
// ç­–ç•¥ï¼šè‡³å°‘å‘½ä¸­ 30% çš„è©å½™ï¼Œä½†æœ€å°‘ 2 å€‹ï¼Œæœ€å¤šä¸è¶…éç¸½æ•¸
const totalClauses = shouldClauses.length;
const minimumMatch = Math.max(2, Math.min(totalClauses, Math.ceil(totalClauses * 0.3)));
console.log(`[CaseDescriptionSearch] minimum_should_match: ${minimumMatch} (ç¸½è©å½™: ${totalClauses})`);
```

**æ•ˆæœ**:
| ç¸½è©å½™æ•¸ | minimum_should_match | èªªæ˜ |
|---------|---------------------|------|
| 1-6 å€‹ | 2 | æœ€å°‘ 2 å€‹ |
| 7-9 å€‹ | 3 | 30% å‘ä¸Šå–æ•´ |
| 10 å€‹ | 3 | 30% = 3 å€‹ |
| 15 å€‹ | 5 | 30% å‘ä¸Šå–æ•´ |

### ä¿®æ­£ 2: é™ä½ Layer 2 èªç¾©éæ¿¾é–€æª»

**ä½ç½®**: `services/caseDescriptionSearchService.js` Line 225 & 573

**ä¿®æ­£å…§å®¹**:
```javascript
// å‡½æ•¸å®šç¾©
function semanticFilter(candidates, queryVector, threshold = 0.55) {
    // ...
}

// èª¿ç”¨
const layer2Candidates = semanticFilter(layer1Candidates, queryVector, 0.55);
```

**é–€æª»é¸æ“‡ç†ç”±**:
- å¯¦æ¸¬å¹³å‡ç›¸ä¼¼åº¦: 0.5564
- å¯¦æ¸¬æœ€é«˜ç›¸ä¼¼åº¦: 0.6587
- é¸æ“‡ 0.55 ç•¥ä½æ–¼å¹³å‡å€¼ï¼Œç¢ºä¿èƒ½ä¿ç•™è¶³å¤ çš„é«˜å“è³ªå€™é¸
- å¦‚æœ 0.55 ä»ç„¶éæ¿¾å¤ªå¤šï¼Œå¯ä»¥é€²ä¸€æ­¥é™ä½åˆ° 0.50

---

## ğŸ§ª æ¸¬è©¦é©—è­‰

### é æœŸ Log è¼¸å‡º

**Layer 1**:
```
[CaseDescriptionSearch] æ§‹å»ºçš„ should clauses æ•¸é‡: 10
[CaseDescriptionSearch] minimum_should_match: 3 (ç¸½è©å½™: 10)
[CaseDescriptionSearch] ES è¿”å›ç¸½æ•¸: 1500  âœ… å¾ 9891 é™ä½
[CaseDescriptionSearch] Layer 1 å®Œæˆ: 200 ç­†å€™é¸
```

**Layer 2**:
```
[CaseDescriptionSearch] Layer 2: èªç¾©éæ¿¾ï¼ˆé–€æª»: 0.55ï¼‰...
[CaseDescriptionSearch] ç›¸ä¼¼åº¦ç¯„åœ: 0.3921 ~ 0.6587, å¹³å‡: 0.5564
[CaseDescriptionSearch] Layer 2 å®Œæˆ: 100 ç­†å€™é¸  âœ… ä¸å†æ˜¯ 0
```

**Layer 3**:
```
[CaseDescriptionSearch] æ ¸å¿ƒæ³•æ¢: ['æ°‘æ³•ç¬¬767æ¢', 'æ°‘æ³•ç¬¬184æ¢', ...]
[CaseDescriptionSearch] Layer 3 å®Œæˆ: 25 ç­†å€™é¸  âœ…
```

**Layer 4**:
```
[CaseDescriptionSearch] Layer 4 å®Œæˆ: 15 ç­†æœ‰æ•ˆå€™é¸  âœ…
```

---

## ğŸ“Š é–€æª»èª¿æ•´ç­–ç•¥

### Layer 2 é–€æª»èª¿æ•´å»ºè­°

æ ¹æ“šå¯¦æ¸¬æ•¸æ“šï¼Œå»ºè­°çš„é–€æª»ç¯„åœï¼š

| é–€æª» | é æœŸä¿ç•™æ¯”ä¾‹ | é©ç”¨å ´æ™¯ |
|-----|------------|---------|
| 0.50 | ~70% | å¯¬é¬†ï¼Œç¢ºä¿å¬å›ç‡ |
| 0.55 | ~50% | **æ¨è–¦**ï¼Œå¹³è¡¡ç²¾ç¢ºåº¦èˆ‡å¬å›ç‡ |
| 0.60 | ~30% | åš´æ ¼ï¼Œæé«˜ç²¾ç¢ºåº¦ |
| 0.65 | ~10% | éå¸¸åš´æ ¼ï¼Œå¯èƒ½éæ¿¾å¤ªå¤š |
| 0.70 | ~0% | âŒ éé«˜ï¼Œå¯¦æ¸¬ç„¡çµæœ |

### å‹•æ…‹é–€æª»ç­–ç•¥ï¼ˆæœªä¾†å„ªåŒ–ï¼‰

å¯ä»¥è€ƒæ…®æ ¹æ“šå€™é¸æ•¸é‡å‹•æ…‹èª¿æ•´é–€æª»ï¼š

```javascript
// å¦‚æœå€™é¸å¤ªå¤šï¼Œæé«˜é–€æª»
// å¦‚æœå€™é¸å¤ªå°‘ï¼Œé™ä½é–€æª»
function adaptiveThreshold(candidates, targetCount = 60) {
    const similarities = candidates.map(c => 
        cosineSimilarity(queryVector, c.summary_ai_vector)
    ).sort((a, b) => b - a);
    
    // å–ç¬¬ targetCount åçš„ç›¸ä¼¼åº¦ä½œç‚ºé–€æª»
    return similarities[Math.min(targetCount, similarities.length - 1)];
}
```

---

## ğŸ” é€²ä¸€æ­¥å„ªåŒ–å»ºè­°

### 1. Layer 1 å„ªåŒ–

**å•é¡Œ**: å³ä½¿èª¿æ•´åˆ° `minimum_should_match: 3`ï¼Œå¯èƒ½é‚„æ˜¯æœƒè¿”å›å¤ªå¤šçµæœã€‚

**å»ºè­°**:
- ç‚ºä¸åŒé¡å‹çš„è©å½™è¨­ç½®ä¸åŒçš„æ¬Šé‡
- æ³•æ¢è©å½™ï¼ˆstatute_termsï¼‰æ¬Šé‡æ›´é«˜
- é€šç”¨è©å½™ï¼ˆå¦‚ã€Œæ‰¿ç§Ÿäººã€ï¼‰æ¬Šé‡è¼ƒä½

```javascript
// å„ªåŒ–å¾Œçš„ boost ç­–ç•¥
shouldClauses.push({
    multi_match: {
        query: term,
        fields: searchFields,
        type: 'best_fields',
        boost: getBoost(termType, term)  // å‹•æ…‹ boost
    }
});

function getBoost(termType, term) {
    if (termType === 'statute_terms') return 2.0;  // æ³•æ¢æœ€é«˜
    if (termType === 'legal_action_terms') return 1.5;  // æ³•å¾‹è¡Œç‚ºæ¬¡ä¹‹
    if (isCommonTerm(term)) return 0.5;  // å¸¸è¦‹è©é™ä½
    return 1.0;  // é è¨­
}
```

### 2. Layer 2 å„ªåŒ–

**å»ºè­°**: ä½¿ç”¨ Top-K ç­–ç•¥è€Œéå›ºå®šé–€æª»

```javascript
// ä¸ä½¿ç”¨å›ºå®šé–€æª»ï¼Œè€Œæ˜¯å– Top 60 å
function semanticFilterTopK(candidates, queryVector, k = 60) {
    const scored = candidates
        .map(candidate => ({
            ...candidate,
            semantic_score: cosineSimilarity(queryVector, candidate.summary_ai_vector)
        }))
        .sort((a, b) => b.semantic_score - a.semantic_score)
        .slice(0, k);  // å–å‰ k å
    
    return scored;
}
```

### 3. Layer 3 å„ªåŒ–

**å»ºè­°**: å¦‚æœæ ¸å¿ƒæ³•æ¢ç‚ºç©ºï¼Œä½¿ç”¨å‚™ç”¨ç­–ç•¥

```javascript
// å¦‚æœæ²’æœ‰æ ¸å¿ƒæ³•æ¢ï¼ˆå‡ºç¾æ¬¡æ•¸ >= 3ï¼‰ï¼Œé™ä½é–€æª»åˆ° >= 2
if (coreStatutes.length === 0) {
    coreStatutes = getStatutesWithMinCount(layer2Candidates, 2);
}
```

---

## ğŸ“ å·²ä¿®æ”¹çš„æª”æ¡ˆ

1. **`services/caseDescriptionSearchService.js`**
   - Line 144-178: å‹•æ…‹èª¿æ•´ `minimum_should_match`
   - Line 225: ä¿®æ”¹ `semanticFilter` é è¨­é–€æª» 0.70 â†’ 0.55
   - Line 573: ä¿®æ”¹èª¿ç”¨æ™‚çš„é–€æª» 0.70 â†’ 0.55

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **é‡å•Ÿå¾Œç«¯æœå‹™**
   ```bash
   cd d:\court_data\courtDataAPI
   node index.js
   ```

2. **å‰ç«¯æ¸¬è©¦**
   - è¼¸å…¥ç›¸åŒçš„æ¡ˆæƒ…æè¿°
   - è§€å¯Ÿæ–°çš„ log è¼¸å‡º

3. **é©—è­‰çµæœ**
   - Layer 1 æ‡‰è©²è¿”å›è¼ƒå°‘çµæœï¼ˆ1,000-2,000 ç­†ï¼‰
   - Layer 2 æ‡‰è©²ä¿ç•™ 50-100 ç­†å€™é¸
   - Layer 3 æ‡‰è©²æœ‰æ ¸å¿ƒæ³•æ¢
   - Layer 4 æ‡‰è©²æœ‰æœ€çµ‚çµæœ

4. **å¾®èª¿é–€æª»**
   - å¦‚æœ Layer 2 ä»ç„¶ 0 ç­† â†’ é™ä½åˆ° 0.50
   - å¦‚æœ Layer 2 å¤ªå¤šç­†ï¼ˆ>150ï¼‰ â†’ æé«˜åˆ° 0.60
   - å¦‚æœ Layer 1 ä»ç„¶å¤ªå¤š â†’ æé«˜ minimum_should_match åˆ° 40%

---

## âœ… ç¸½çµ

**å·²å®Œæˆçš„ä¿®æ­£**:
- âœ… å‹•æ…‹èª¿æ•´ `minimum_should_match`ï¼ˆ1 â†’ 30% æˆ–è‡³å°‘ 2 å€‹ï¼‰
- âœ… é™ä½ Layer 2 é–€æª»ï¼ˆ0.70 â†’ 0.55ï¼‰
- âœ… æ·»åŠ è©³ç´°çš„ debug log

**é æœŸæ•ˆæœ**:
- Layer 1: 9,891 ç­† â†’ 1,500 ç­†å·¦å³
- Layer 2: 0 ç­† â†’ 100 ç­†å·¦å³
- Layer 3: 0 ç­† â†’ 25 ç­†å·¦å³
- Layer 4: 0 ç­† â†’ 15 ç­†å·¦å³

æº–å‚™å¥½æ¸¬è©¦äº†ï¼ğŸ‰

