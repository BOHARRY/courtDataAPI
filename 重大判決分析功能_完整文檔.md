# 重大判決分析功能 - 完整文檔

**最後更新**: 2025-10-12
**版本**: V2

---

## 📋 **目錄**

1. [功能概述](#功能概述)
2. [核心改進](#核心改進)
3. [架構設計](#架構設計)
4. [實作細節](#實作細節)
5. [重要 Bug 修復](#重要-bug-修復)
6. [測試和驗證](#測試和驗證)
7. [未來優化建議](#未來優化建議)

---

## 1. 功能概述

### **功能名稱**
重大判決分析（Critical Judgment Analysis）

### **功能目的**
幫助律師分析重大勝訴和重大敗訴案例，學習成功策略並避免失敗陷阱。

### **核心價值**
1. ✅ **學習成功策略** - 分析重大勝訴案例，提取關鍵成功要素
2. ✅ **避免失敗陷阱** - 分析重大敗訴案例，識別常見錯誤
3. ✅ **對比分析** - 對比成功和失敗案例，識別關鍵差異
4. ✅ **客觀分析** - 不偏向有利判例，提供完整的判決分布

### **使用場景**
- 律師準備訴訟策略時，需要了解成功和失敗的關鍵因素
- 律師評估案件風險時，需要看到完整的判決分布
- 律師學習訴訟技巧時，需要對比成功和失敗案例

---

## 2. 核心改進

### **從「主流對決歸納」改為「重大判決分析」**

#### **舊邏輯（主流對決歸納）**
- ❌ 自動選擇數量最多的判決模式（主流）
- ❌ 結果：89% 都是部分勝訴，律師看不到關鍵差異
- ❌ 只分析一種判決類型，缺乏對比

#### **新邏輯（重大判決分析）**
- ✅ 優先選擇重大勝訴和重大敗訴案例（各最多 5 件）
- ✅ 不足 10 件時，用部分勝訴補充
- ✅ 律師可以學習成功策略和避免失敗陷阱
- ✅ 提供完整的判決分布（重大勝訴、部分勝訴、重大敗訴）

---

### **搜尋邏輯優化：移除過濾條件**

#### **舊邏輯（偏向有利判例）**
- ❌ 搜尋過濾條件偏向有利判例（`positive_precedent`, `major_victory`）
- ❌ Elasticsearch 評分機制提升有利判例的排名
- ❌ 結果：97% 重大勝訴，極不合理

#### **新邏輯（客觀分析）**
- ✅ 移除 `filterQuery`，只根據向量相似度排序
- ✅ 不偏向任何類型的判例
- ✅ 結果：30-35% 重大勝訴，40-45% 重大敗訴，20-25% 部分勝訴（合理）

---

## 3. 架構設計

### **數據流**

```
用戶點擊「歸納重大判決分析」
    ↓
前端調用 startMainstreamAnalysis()
    ↓
後端接收請求，創建任務
    ↓
從案例池中選擇重大判決案例
    ├─ 優先選擇重大勝訴（最多 5 件）
    ├─ 優先選擇重大敗訴（最多 5 件）
    └─ 不足時用部分勝訴補充
    ↓
調用 AI 分析案例
    ├─ 分析重大勝訴案例（成功要素）
    ├─ 分析重大敗訴案例（失敗原因）
    └─ 分析部分勝訴案例（常見結果）
    ↓
返回分析結果
    ├─ plaintiffSuccessFactors（勝訴要素）
    ├─ attackStrategies（攻擊策略/防禦策略）
    ├─ evidenceRequirements（舉證要點）
    └─ commonPitfalls（避免陷阱）
    ↓
前端顯示結果
    ├─ 概要 Tab
    ├─ 勝訴要素 Tab
    ├─ 攻擊策略/防禦策略 Tab
    ├─ 舉證要點 Tab
    └─ 避免陷阱 Tab
```

---

### **後端架構**

**核心函數**:
1. `getCriticalCasesFromPool()` - 選擇重大判決案例
2. `analyzeCriticalPattern()` - AI 分析案例
3. `getCriticalAnalysisPrompt()` - 生成 AI 提示詞

**數據結構**:
```javascript
{
  plaintiffSuccessFactors: [
    "勝訴要素1：被告已完成大部分設計工作 [1][2]",
    "勝訴要素2：被告提供完整的工作證明 [3]"
  ],
  attackStrategies: [
    "攻擊策略1：強調契約屬承攬性質 [1][3]",
    "攻擊策略2：提供完整的工作證明 [2][4]"
  ],
  evidenceRequirements: [
    "舉證要點1：提供完整的工作證明 [2][4]",
    "舉證要點2：證明已完成大部分工作 [5]"
  ],
  commonPitfalls: [
    "避免陷阱1：未能提供完整的工作證明 [5]",
    "避免陷阱2：未能證明已履行義務 [6]"
  ],
  caseDistribution: {
    majorVictory: 5,
    majorDefeat: 5,
    partialSuccess: 0
  }
}
```

---

### **前端架構**

**核心組件**:
- `FavorableAnalysisNodeV2.js` - 案件有利判決分析節點
- `MainstreamAnalysisNodeV2.js` - 重大判決分析節點
- `MainstreamAnalysisNodeV2Module.js` - 節點模組定義

**顯示邏輯**:
- 5 個 Tab：概要、勝訴要素、攻擊策略/防禦策略、舉證要點、避免陷阱
- 每個 Tab 顯示對應的分析內容
- 引用判決書 ID（如 [1][2]）

---

## 4. 實作細節

### **4.1 案例選擇邏輯**

**函數**: `getCriticalCasesFromPool()`
**位置**: `services/casePrecedentAnalysisService.js` Line 2437-2545

**邏輯**:
1. 從案例池中分類案例：
   - `major_victory` → majorVictory 陣列
   - `major_defeat` → majorDefeat 陣列
   - `partial_success` → partialSuccess 陣列

2. 優先選擇重大判決：
   - 重大勝訴：最多 5 件
   - 重大敗訴：最多 5 件

3. 補充部分勝訴：
   - 如果不足 10 件，從部分勝訴補充

4. 返回結果：
   - `cases`: 選中的案例陣列
   - `distribution`: 案例分布統計

**範例**:
```javascript
{
  cases: [
    { id: 'case1', overall_result: 'major_victory', ... },
    { id: 'case2', overall_result: 'major_victory', ... },
    { id: 'case3', overall_result: 'major_defeat', ... },
    ...
  ],
  distribution: {
    majorVictory: 5,
    majorDefeat: 5,
    partialSuccess: 0
  }
}
```

---

### **4.2 AI 分析邏輯**

**函數**: `analyzeCriticalPattern()`
**位置**: `services/casePrecedentAnalysisService.js` Line 2883-2927

**邏輯**:
1. 調用 `getCriticalAnalysisPrompt()` 生成提示詞
2. 調用 OpenAI API 進行分析
3. 解析 AI 返回的 JSON 結果
4. 添加 `caseDistribution` 到結果中

**AI 提示詞結構**:
- 原告方：分析重大勝訴、重大敗訴、部分勝訴，提供 4 個維度的分析
- 被告方：分析重大勝訴、重大敗訴、部分勝訴，提供 4 個維度的分析

**4 個維度**:
1. `plaintiffSuccessFactors` - 勝訴要素（陣列）
2. `attackStrategies` - 攻擊策略/防禦策略（陣列）
3. `evidenceRequirements` - 舉證要點（陣列）
4. `commonPitfalls` - 避免陷阱（陣列）

**強制引用判決書**:
- 每個要點都必須引用具體判決書 [數字]
- 範例：「勝訴要素1：被告已完成大部分設計工作 [1][2]」

---

### **4.3 搜尋邏輯優化**

**函數**: `getPositionBasedSearchStrategy()`
**位置**: `services/casePrecedentAnalysisService.js` Line 410-496

**修改前**:
```javascript
filterQuery: {
    bool: {
        should: [
            { term: { "position_based_analysis.plaintiff_perspective.case_value": "positive_precedent" } },
            { term: { "position_based_analysis.plaintiff_perspective.overall_result": "major_victory" } },
            { term: { "position_based_analysis.plaintiff_perspective.overall_result": "partial_success" } },
            { exists: { field: "position_based_analysis.plaintiff_perspective.successful_elements" } }
        ],
        minimum_should_match: 0
    }
}
```

**修改後**:
```javascript
// ✅ 移除 filterQuery，讓搜尋結果更客觀
// 不再偏向有利判例，而是返回所有相關案例（包含成功和失敗）
```

**效果**:
- 修改前：97% 重大勝訴（極不合理）
- 修改後：30-35% 重大勝訴，40-45% 重大敗訴，20-25% 部分勝訴（合理）

---

## 5. 重要 Bug 修復

### **5.1 ReferenceError Bug**

**問題**: 使用了不存在的變數 `mainStreamCases.length`
**位置**: Line 3092
**修復**: 改為 `criticalCases.length`

---

### **5.2 Tab 內容空白問題**

**問題**: AI 返回的欄位名稱與前端期望不匹配
**原因**: AI 返回 `majorVictoryAnalysis`，前端期望 `plaintiffSuccessFactors`
**修復**: 修改 AI 提示詞，返回前端期望的欄位名稱

---

### **5.3 97% 勝訴率問題**

**問題**: 原告分析顯示 97% 重大勝訴，極不合理
**根源**: 搜尋過濾條件偏向有利判例
**修復**: 移除 `filterQuery`，讓搜尋結果更客觀

**詳細分析**:
1. Elasticsearch 數據是正常的（整體分布 1:1:1）
2. 問題出在搜尋過濾條件
3. `should` 條件提升有利判例的分數
4. 最終導致搜尋結果偏向有利判例

**修復方案**:
- 移除 `filterQuery`
- 只根據向量相似度排序
- 不偏向任何類型的判例

---

## 6. 測試和驗證

### **測試步驟**

1. **重啟後端服務**
2. **清除瀏覽器緩存**（Ctrl+F5）
3. **創建案件規劃**
4. **執行案件有利判決分析**
5. **點擊「歸納重大判決分析」按鈕**
6. **等待約 30 秒**
7. **檢查結果**

### **預期結果**

**判決分布**:
- 原告重大勝訴：30-35% (9-10件)
- 原告部分勝訴：20-25% (6-8件)
- 原告重大敗訴：40-45% (12-14件)

**Tab 內容**:
- ✅ 概要 Tab：顯示完整的分析摘要
- ✅ 勝訴要素 Tab：顯示勝訴要素列表（帶引用）
- ✅ 攻擊策略/防禦策略 Tab：顯示策略列表（帶引用）
- ✅ 舉證要點 Tab：顯示舉證要點列表（帶引用）
- ✅ 避免陷阱 Tab：顯示避免陷阱列表（帶引用）

---

## 7. 未來優化建議

### **7.1 性能優化**

- 優化 AI 分析速度（目前約 30 秒）
- 優化案例選擇邏輯（減少計算量）
- 添加緩存機制（避免重複分析）

### **7.2 功能擴展**

- 提供「只看有利判例」的選項
- 提供「平衡分析」和「有利分析」兩種模式
- 添加判決分布圖表（圓餅圖、柱狀圖）

### **7.3 用戶體驗改進**

- 添加進度條（顯示分析進度）
- 添加案例詳情查看功能
- 添加引用判決書的快速查看功能

---

## 📚 **相關文檔**

- `交付給下一位工程師.md` - 整體架構說明
- `案件判決分析服務重構計劃.md` - 重構計劃
- `Phase1_重構完成報告.md` - 重構完成報告
- `ES查詢驗證報告.md` - ES 查詢驗證

---

**文檔維護**: 請在修改功能時，同步更新此文檔。

