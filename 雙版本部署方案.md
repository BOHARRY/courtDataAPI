# LawSowl 雙版本部署方案技術文檔

## 📋 專案概述

### 為什麼需要雙版本？

#### **業務需求**
- **快速功能驗證**：新功能在測試版驗證後再推送到穩定版
- **用戶體驗保障**：穩定版保持高可用性，測試版承擔實驗風險
- **開發效率提升**：並行開發，縮短功能上線週期
- **風險控制**：隔離實驗性功能，避免影響生產用戶

#### **技術優勢**
- **環境隔離**：測試版和穩定版完全獨立運行
- **數據安全**：生產數據與測試數據分離
- **功能差異化**：測試版可開啟實驗性功能
- **快速回滾**：出現問題時可快速切換到穩定版

## 🏗️ 技術架構設計

### 整體架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                    LawSowl 雙版本架構 (簡化版)               │
├─────────────────────────────────────────────────────────────┤
│  用戶訪問層                                                  │
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │   穩定版 (生產)      │    │   測試版 (Beta)      │         │
│  │ lawsowl-prod.vercel │    │ lawsowl-beta.vercel │         │
│  │      .app           │    │      .app           │         │
│  └─────────────────────┘    └─────────────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  前端應用層 (Vercel)                                         │
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │   React 18.2.0      │    │   React 18.2.0      │         │
│  │   main 分支         │    │   develop 分支       │         │
│  │   穩定功能          │    │   實驗功能          │         │
│  └─────────────────────┘    └─────────────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  後端 API 層 (Render.com)                                   │
│  ┌─────────────────────┐    ┌─────────────────────┐         │
│  │ courtdataapi-prod   │    │ courtdataapi-beta   │         │
│  │   main 分支         │    │   develop 分支       │         │
│  │   生產環境變數       │    │   測試環境變數       │         │
│  └─────────────────────┘    └─────────────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  共享數據存儲層                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Elasticsearch (共享)                       │ │
│  │              Firebase (共享)                           │ │
│  │              固定數據，兩版本共用                        │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 環境變數 + 分支策略

#### **分支管理策略 (簡化版)**
```
main (生產分支)
├── 穩定功能
├── 經過完整測試
└── 自動部署到生產環境

develop (開發分支)
├── 新功能開發
├── 實驗性功能
├── 自動部署到測試環境
└── 測試通過後直接合併到 main
```

**工作流程**：
1. 開發者直接在 `develop` 分支開發新功能
2. 推送到 `develop` 觸發測試版部署
3. 測試版驗證通過後，創建 PR 合併到 `main`
4. 合併到 `main` 觸發生產版部署

#### **環境配置策略**
```javascript
// 環境檢測邏輯
const getEnvironment = () => {
  // 1. 優先使用明確的環境變數
  if (process.env.REACT_APP_ENVIRONMENT) {
    return process.env.REACT_APP_ENVIRONMENT;
  }
  
  // 2. 基於域名自動檢測
  const hostname = window.location.hostname;
  if (hostname.includes('beta')) return 'beta';
  if (hostname.includes('localhost')) return 'development';
  
  // 3. 預設為生產環境
  return 'production';
};
```

## 🎯 前端實施指南

### Vercel 雙專案配置步驟

#### **步驟 1：創建生產環境專案**
1. 登入 Vercel Dashboard
2. 點擊 "New Project"
3. 選擇 LawSowl Git 倉庫
4. 配置如下：
   ```
   Project Name: lawsowl-production
   Framework Preset: Create React App
   Root Directory: lawsowl
   Build Command: npm run build
   Output Directory: build
   Install Command: npm install
   Git Branch: main
   ```

#### **步驟 2：創建測試環境專案**
1. 重複上述步驟，配置如下：
   ```
   Project Name: lawsowl-beta
   Framework Preset: Create React App
   Root Directory: lawsowl
   Build Command: npm run build
   Output Directory: build
   Install Command: npm install
   Git Branch: develop
   ```

#### **步驟 3：配置環境變數**

##### **生產環境變數 (lawsowl-production)**
```bash
# 基礎配置
REACT_APP_ENVIRONMENT=production
REACT_APP_VERSION=stable
REACT_APP_API_BASE_URL=https://courtdataapi-prod.onrender.com/api

# Firebase 配置 (共享)
REACT_APP_FIREBASE_API_KEY=your-shared-api-key
REACT_APP_FIREBASE_AUTH_DOMAIN=lawsowl.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=lawsowl
REACT_APP_FIREBASE_STORAGE_BUCKET=lawsowl.appspot.com
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=your-shared-sender-id
REACT_APP_FIREBASE_APP_ID=your-shared-app-id
REACT_APP_FIREBASE_MEASUREMENT_ID=your-shared-measurement-id

# 功能開關 (生產)
REACT_APP_SHOW_ADMIN_PANEL=false
REACT_APP_ENABLE_BETA_FEATURES=false
REACT_APP_ENABLE_DEBUG_MODE=false

# 日誌配置 (生產)
REACT_APP_SUPPRESS_FREQUENT_LOGS=true
REACT_APP_SUPPRESS_POLLING_LOGS=true
REACT_APP_SUPPRESS_DATA_SYNC_LOGS=true
REACT_APP_LOG_DEBUG=false
```

##### **測試環境變數 (lawsowl-beta)**
```bash
# 基礎配置
REACT_APP_ENVIRONMENT=beta
REACT_APP_VERSION=beta
REACT_APP_API_BASE_URL=https://courtdataapi-beta.onrender.com/api

# Firebase 配置 (共享)
REACT_APP_FIREBASE_API_KEY=your-shared-api-key
REACT_APP_FIREBASE_AUTH_DOMAIN=lawsowl.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=lawsowl
REACT_APP_FIREBASE_STORAGE_BUCKET=lawsowl.appspot.com
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=your-shared-sender-id
REACT_APP_FIREBASE_APP_ID=your-shared-app-id
REACT_APP_FIREBASE_MEASUREMENT_ID=your-shared-measurement-id

# 功能開關 (測試)
REACT_APP_SHOW_ADMIN_PANEL=true
REACT_APP_ENABLE_BETA_FEATURES=true
REACT_APP_ENABLE_DEBUG_MODE=true

# 日誌配置 (測試)
REACT_APP_SUPPRESS_FREQUENT_LOGS=false
REACT_APP_SUPPRESS_POLLING_LOGS=false
REACT_APP_SUPPRESS_DATA_SYNC_LOGS=false
REACT_APP_LOG_DEBUG=true
REACT_APP_SHOW_ENV_CHECK=true
```

### 代碼修改清單

#### **需要修改的核心文件**

##### **1. 創建環境配置文件**
文件：`src/config/environment.js`
```javascript
// 環境檢測與配置管理
const getEnvironmentFromDomain = () => {
  const hostname = window.location.hostname;
  
  if (hostname.includes('beta')) return 'beta';
  if (hostname.includes('localhost')) return 'development';
  return 'production';
};

const environment = process.env.REACT_APP_ENVIRONMENT || getEnvironmentFromDomain();

export const config = {
  production: {
    version: 'stable',
    apiUrl: process.env.REACT_APP_API_BASE_URL,
    features: {
      adminPanel: process.env.REACT_APP_SHOW_ADMIN_PANEL === 'true',
      betaFeatures: false,
      debugMode: false
    },
    ui: {
      showVersionBadge: false,
      enableFeedback: false,
      showBetaWarning: false
    }
  },
  beta: {
    version: 'beta',
    apiUrl: process.env.REACT_APP_API_BASE_URL,
    features: {
      adminPanel: true,
      betaFeatures: true,
      debugMode: true
    },
    ui: {
      showVersionBadge: true,
      enableFeedback: true,
      showBetaWarning: true
    }
  }
}[environment];
```

##### **2. 修改 Firebase 配置**
文件：`src/firebase.js`
```javascript
// 環境感知的 Firebase 配置
import { config } from './config/environment';

const getFirebaseConfig = () => {
  return {
    apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
    authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
    projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
    storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.REACT_APP_FIREBASE_APP_ID,
    measurementId: process.env.REACT_APP_FIREBASE_MEASUREMENT_ID
  };
};

const firebaseConfig = getFirebaseConfig();
```

##### **3. 修改主應用路由**
文件：`src/App.js`
```javascript
import { config } from './config/environment';

// 條件式路由
{config.features.adminPanel && (
  <Route path="/admin" element={<AdminRoute><AdminDashboard /></AdminRoute>} />
)}

{config.features.betaFeatures && (
  <Route path="/beta-features" element={<BetaFeaturesPage />} />
)}
```

##### **4. 創建版本相關組件**

**文件：`src/components/VersionBadge.js`**
```javascript
import React from 'react';
import { config } from '../config/environment';

const VersionBadge = () => {
  if (!config.ui.showVersionBadge) return null;

  return (
    <div className="version-badge">
      <span className="version-label">BETA</span>
      <span className="version-number">v{config.version}</span>
    </div>
  );
};

export default VersionBadge;
```

**文件：`src/components/VersionSwitcher.js`**
```javascript
import React from 'react';
import { config } from '../config/environment';

const VersionSwitcher = () => {
  const isProduction = config.version === 'stable';

  const switchVersion = () => {
    const currentPath = window.location.pathname + window.location.search;
    const targetDomain = isProduction
      ? 'https://lawsowl-beta.vercel.app'
      : 'https://lawsowl-production.vercel.app';

    window.location.href = targetDomain + currentPath;
  };

  return (
    <button onClick={switchVersion} className="version-switch-btn">
      {isProduction ? '🧪 試用測試版' : '🏠 回到穩定版'}
    </button>
  );
};

export default VersionSwitcher;
```

**文件：`src/components/BetaWarning.js`**
```javascript
import React, { useState } from 'react';
import { config } from '../config/environment';

const BetaWarning = () => {
  const [showWarning, setShowWarning] = useState(true);

  if (!config.ui.showBetaWarning || !showWarning) return null;

  return (
    <div className="beta-warning-banner">
      <div className="beta-warning-content">
        <span className="warning-icon">⚠️</span>
        <span className="warning-text">
          您正在使用測試版本，功能可能不穩定。
          <a href="https://lawsowl-production.vercel.app" className="stable-link">
            切換到穩定版本
          </a>
        </span>
        <button className="warning-close" onClick={() => setShowWarning(false)}>
          ✕
        </button>
      </div>
    </div>
  );
};

export default BetaWarning;
```

## 🔧 後端實施指南

### Render.com 雙服務配置步驟

#### **步驟 1：創建生產環境服務**
1. 登入 Render.com Dashboard
2. 點擊 "New +" → "Web Service"
3. 連接 Git 倉庫，配置如下：
   ```
   Name: courtdataapi-production
   Environment: Node
   Region: Oregon (US West)
   Branch: main
   Root Directory: (留空，如果後端在根目錄)
   Build Command: npm install
   Start Command: npm start
   ```

#### **步驟 2：創建測試環境服務**
1. 重複上述步驟，配置如下：
   ```
   Name: courtdataapi-beta
   Environment: Node
   Region: Oregon (US West)
   Branch: develop
   Root Directory: (留空)
   Build Command: npm install
   Start Command: npm start
   ```

#### **步驟 3：配置後端環境變數**

##### **生產環境變數 (courtdataapi-production)**
```bash
# 基礎配置
NODE_ENV=production
IS_BETA=false
PORT=10000

# 數據庫配置 (共享)
ES_URL=https://your-shared-elasticsearch-url
ES_API_KEY=your-shared-es-api-key
FIREBASE_SERVICE_ACCOUNT_KEY_JSON=your-shared-firebase-key

# AI 服務配置
OPENAI_API_KEY=your-openai-api-key
XAI_API_KEY=your-xai-api-key
CLAUDE_API_KEY=your-claude-api-key

# 其他服務配置
GMAIL_APP_USER=your-gmail-user
GMAIL_APP_PASSWORD=your-gmail-password
NEWEBPAY_MERCHANT_ID=your-merchant-id
NEWEBPAY_HASH_KEY=your-hash-key
NEWEBPAY_HASH_IV=your-hash-iv

# 前端 URL
APP_BASE_URL=https://lawsowl-production.vercel.app
```

##### **測試環境變數 (courtdataapi-beta)**
```bash
# 基礎配置
NODE_ENV=production
IS_BETA=true
PORT=10000

# 數據庫配置 (共享)
ES_URL=https://your-shared-elasticsearch-url
ES_API_KEY=your-shared-es-api-key
FIREBASE_SERVICE_ACCOUNT_KEY_JSON=your-shared-firebase-key

# AI 服務配置 (共享或測試專用)
OPENAI_API_KEY=your-openai-api-key
XAI_API_KEY=your-xai-api-key
CLAUDE_API_KEY=your-claude-api-key

# 測試專用配置
ENABLE_DEBUG_ENDPOINTS=true
ENABLE_EXPERIMENTAL_API=true

# 前端 URL
APP_BASE_URL=https://lawsowl-beta.vercel.app
```

### API 環境隔離配置

#### **修改後端環境檢測**
文件：`config/environment.js`
```javascript
// 環境檢測邏輯
const isBeta = process.env.IS_BETA === 'true';
const environment = isBeta ? 'beta' : 'production';

export const config = {
  environment,
  isBeta,

  // 功能開關
  features: {
    enableExperimentalAPI: isBeta,
    enableDebugEndpoints: process.env.ENABLE_DEBUG_ENDPOINTS === 'true',
    enableVerboseLogging: isBeta
  },

  // API 配置
  api: {
    corsOrigins: isBeta
      ? ['https://lawsowl-beta.vercel.app', 'http://localhost:3000']
      : ['https://lawsowl-production.vercel.app'],
    rateLimit: isBeta ? 1000 : 100 // 測試版更寬鬆的限制
  }
};
```

#### **條件式路由和中間件**
文件：`index.js` 或主應用文件
```javascript
import { config } from './config/environment.js';

// 條件式中間件
if (config.features.enableDebugEndpoints) {
  app.use('/api/debug', debugRoutes);
}

if (config.features.enableExperimentalAPI) {
  app.use('/api/experimental', experimentalRoutes);
}

// 環境特定的 CORS 配置
app.use(cors({
  origin: config.api.corsOrigins,
  credentials: true
}));
```

### 共享數據庫策略

#### **Elasticsearch 配置 (共享)**
```javascript
// 兩個版本使用相同的 Elasticsearch 實例
// 判決書數據是固定的，不需要分離
const getIndexName = (baseIndex) => {
  return baseIndex; // 直接使用原始索引名稱
};

// 使用範例
const judgmentIndex = 'judgments'; // 兩個版本都使用相同索引
```

#### **Firebase 項目 (共享)**
- **統一項目**：兩個版本使用同一個 Firebase 項目
- **用戶認證**：共享用戶系統，用戶可以在兩個版本間無縫切換
- **數據一致性**：用戶的工作區、搜尋歷史等數據在兩版本間同步

**優勢**：
- 簡化維護成本
- 用戶體驗一致
- 數據不重複
- 降低基礎設施成本

## 🚀 部署流程

### Git 分支管理策略

#### **分支結構**
```
main (生產分支)
├── 穩定版本
├── 經過完整測試
├── 自動部署到生產環境
└── 受保護分支（需要 PR 審查）

develop (開發分支)
├── 最新開發版本
├── 新功能開發
├── 自動部署到測試環境
├── 允許直接推送
└── 測試通過後合併到 main

hotfix/* (緊急修復分支)
├── 從 main 分支創建
├── 修復生產環境問題
├── 同時合併到 main 和 develop
└── 立即部署
```

**簡化的工作流程**：
1. 開發者直接在 `develop` 分支開發
2. 推送觸發測試版自動部署
3. 測試版驗證通過後，創建 PR 到 `main`
4. PR 合併後觸發生產版自動部署

#### **分支保護規則**
在 GitHub 設置以下保護規則：

**main 分支保護**
```yaml
Protection Rules:
  - Require pull request reviews: 2 reviewers
  - Dismiss stale reviews: true
  - Require status checks: true
  - Required status checks:
    - build
    - test
    - security-scan
  - Restrict pushes: true
  - Allowed users: [admin-users]
```

**develop 分支保護**
```yaml
Protection Rules:
  - Require pull request reviews: 1 reviewer
  - Require status checks: true
  - Required status checks:
    - build
    - test
```

### 自動化部署配置

#### **GitHub Actions 工作流程**

**文件：`.github/workflows/deploy-production.yml`**
```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: lawsowl/package-lock.json

      - name: Install dependencies
        run: |
          cd lawsowl
          npm ci

      - name: Run tests
        run: |
          cd lawsowl
          npm test -- --coverage --watchAll=false

      - name: Build application
        run: |
          cd lawsowl
          npm run build
        env:
          REACT_APP_ENVIRONMENT: production

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}
          working-directory: lawsowl
          vercel-args: '--prod'

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Render Production
        run: |
          curl -X POST "${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}"
```

**文件：`.github/workflows/deploy-beta.yml`**
```yaml
name: Deploy to Beta

on:
  push:
    branches: [develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: lawsowl/package-lock.json

      - name: Install dependencies
        run: |
          cd lawsowl
          npm ci

      - name: Run tests
        run: |
          cd lawsowl
          npm test -- --coverage --watchAll=false

      - name: Build application
        run: |
          cd lawsowl
          npm run build
        env:
          REACT_APP_ENVIRONMENT: beta

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel Beta
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_BETA_PROJECT_ID }}
          working-directory: lawsowl
          vercel-args: '--prod'

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Render Beta
        run: |
          curl -X POST "${{ secrets.RENDER_BETA_DEPLOY_HOOK }}"
```

#### **Vercel 配置文件**

**文件：`lawsowl/vercel.json`**
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "build"
      }
    }
  ],
  "routes": [
    {
      "src": "/static/(.*)",
      "headers": {
        "cache-control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "env": {
    "REACT_APP_BUILD_TIME": "@now"
  },
  "functions": {
    "lawsowl/build/static/js/*.js": {
      "maxDuration": 30
    }
  }
}
```

### 環境切換機制

#### **自動環境檢測**
```javascript
// src/utils/environmentDetector.js
export const detectEnvironment = () => {
  const hostname = window.location.hostname;
  const subdomain = hostname.split('.')[0];

  // 基於域名檢測
  if (subdomain.includes('beta')) return 'beta';
  if (hostname.includes('localhost')) return 'development';
  if (hostname.includes('vercel.app')) {
    return subdomain.includes('beta') ? 'beta' : 'production';
  }

  // 預設為生產環境
  return 'production';
};

// 環境配置載入
export const loadEnvironmentConfig = () => {
  const environment = detectEnvironment();

  return {
    environment,
    apiUrl: process.env.REACT_APP_API_BASE_URL,
    features: {
      adminPanel: environment === 'beta' || process.env.REACT_APP_SHOW_ADMIN_PANEL === 'true',
      betaFeatures: environment === 'beta',
      debugMode: environment !== 'production'
    }
  };
};
```

## 👨‍💻 開發者操作手冊

### 如何在兩個版本間切換測試

#### **方法 1：使用版本切換器**
1. 在應用中點擊版本切換按鈕
2. 系統會自動跳轉到對應版本
3. 保持當前頁面路徑和查詢參數

#### **方法 2：直接訪問域名**
```bash
# 穩定版
https://lawsowl-production.vercel.app

# 測試版
https://lawsowl-beta.vercel.app
```

#### **方法 3：本地開發環境**
```bash
# 模擬生產環境
REACT_APP_ENVIRONMENT=production npm start

# 模擬測試環境
REACT_APP_ENVIRONMENT=beta npm start
```

### 如何添加測試版專屬功能

#### **步驟 1：創建功能組件**
```javascript
// src/components/BetaFeature.js
import React from 'react';
import { config } from '../config/environment';

const BetaFeature = ({ children }) => {
  if (!config.features.betaFeatures) return null;

  return (
    <div className="beta-feature">
      <div className="beta-feature-badge">BETA</div>
      {children}
    </div>
  );
};

export default BetaFeature;
```

#### **步驟 2：在組件中使用**
```javascript
import BetaFeature from './BetaFeature';

const MyComponent = () => {
  return (
    <div>
      <h1>常規功能</h1>

      <BetaFeature>
        <button>實驗性功能按鈕</button>
      </BetaFeature>
    </div>
  );
};
```

#### **步驟 3：路由級別的功能控制**
```javascript
// src/App.js
{config.features.betaFeatures && (
  <>
    <Route path="/experimental-ai" element={<ExperimentalAIPage />} />
    <Route path="/advanced-analytics" element={<AdvancedAnalyticsPage />} />
  </>
)}
```

### 故障排除指南

#### **常見問題 1：環境變數未生效**

**症狀**：功能開關不工作，API 調用失敗

**排查步驟**：
```javascript
// 在瀏覽器控制台執行
console.log('環境檢查:', {
  environment: process.env.REACT_APP_ENVIRONMENT,
  apiUrl: process.env.REACT_APP_API_BASE_URL,
  hostname: window.location.hostname,
  detectedEnv: detectEnvironment()
});
```

**解決方案**：
1. 檢查 Vercel 環境變數設置
2. 確認變數名稱正確（必須以 `REACT_APP_` 開頭）
3. 重新部署應用

#### **常見問題 2：API 跨域錯誤**

**症狀**：`CORS policy` 錯誤

**排查步驟**：
```javascript
// 檢查 API 配置
console.log('API 配置:', {
  frontendDomain: window.location.origin,
  apiUrl: process.env.REACT_APP_API_BASE_URL,
  environment: process.env.REACT_APP_ENVIRONMENT
});
```

**解決方案**：
1. 檢查後端 CORS 配置
2. 確認前端域名在後端白名單中
3. 檢查 API URL 是否正確

#### **常見問題 3：Firebase 認證失敗**

**症狀**：登入失敗，認證錯誤

**排查步驟**：
```javascript
// 檢查 Firebase 配置
console.log('Firebase 配置:', {
  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
  environment: process.env.REACT_APP_ENVIRONMENT
});
```

**解決方案**：
1. 確認 Firebase 配置正確（兩版本使用相同配置）
2. 檢查 Firebase 項目的授權域名設置（需包含兩個 Vercel 域名）
3. 驗證 API 金鑰是否正確

## ⏱️ 實施時間估算與優先級

### 階段性實施計劃

#### **階段一：基礎環境配置 (優先級：高)**
**預估時間：2-3 工作天**

| 任務 | 預估時間 | 負責人 | 風險等級 |
|------|----------|--------|----------|
| 創建 Vercel 雙專案 | 2 小時 | DevOps | 低 |
| 創建 Render.com 雙服務 | 2 小時 | DevOps | 低 |
| 配置環境變數 | 4 小時 | 開發者 | 中 |
| 創建環境配置文件 | 4 小時 | 開發者 | 低 |
| 修改 Firebase 配置 | 3 小時 | 開發者 | 中 |
| 基礎測試 | 4 小時 | QA | 中 |

#### **階段二：功能差異化 (優先級：中)**
**預估時間：3-4 工作天**

| 任務 | 預估時間 | 負責人 | 風險等級 |
|------|----------|--------|----------|
| 創建版本檢測組件 | 4 小時 | 前端開發 | 低 |
| 實現功能開關邏輯 | 6 小時 | 前端開發 | 中 |
| 添加版本切換器 | 3 小時 | 前端開發 | 低 |
| 實現測試版專屬功能 | 8 小時 | 前端開發 | 中 |
| 後端條件式路由 | 4 小時 | 後端開發 | 中 |
| 整合測試 | 6 小時 | QA | 高 |

#### **階段三：自動化部署 (優先級：中)**
**預估時間：2-3 工作天**

| 任務 | 預估時間 | 負責人 | 風險等級 |
|------|----------|--------|----------|
| 設置 GitHub Actions | 4 小時 | DevOps | 中 |
| 配置分支保護規則 | 2 小時 | DevOps | 低 |
| 創建部署腳本 | 3 小時 | DevOps | 中 |
| 測試自動部署流程 | 4 小時 | DevOps | 高 |
| 文檔撰寫 | 3 小時 | 技術寫手 | 低 |

#### **階段四：監控與優化 (優先級：低)**
**預估時間：1-2 工作天**

| 任務 | 預估時間 | 負責人 | 風險等級 |
|------|----------|--------|----------|
| 設置監控告警 | 3 小時 | DevOps | 低 |
| 性能優化 | 4 小時 | 開發者 | 低 |
| 用戶反饋系統 | 4 小時 | 前端開發 | 低 |
| 最終測試 | 4 小時 | QA | 中 |

### 風險評估與緩解策略

#### **高風險項目**

**1. 整合測試階段**
- **風險**：多環境配置可能導致意外錯誤
- **緩解策略**：
  - 建立完整的測試檢查清單
  - 在低峰時段進行部署
  - 準備快速回滾方案

**2. 自動部署流程測試**
- **風險**：部署失敗可能影響生產環境
- **緩解策略**：
  - 先在測試環境完整驗證
  - 使用藍綠部署策略
  - 設置部署前檢查點

#### **中風險項目**

**1. 環境變數配置**
- **風險**：配置錯誤可能導致功能異常
- **緩解策略**：
  - 建立配置檢查清單
  - 實施配置驗證機制
  - 準備配置回滾方案

**2. Firebase 配置修改**
- **風險**：認證系統可能受影響
- **緩解策略**：
  - 先在測試環境驗證
  - 保留原有配置備份
  - 分階段遷移用戶

## 📋 具體執行任務清單

### 立即執行任務 (本週)

#### **任務 1：創建 Vercel 專案**
**負責人：DevOps/項目負責人**
**預估時間：2 小時**

**詳細步驟：**
1. 登入 Vercel Dashboard
2. 創建 `lawsowl-production` 專案
   - 連接 GitHub 倉庫
   - 設置分支為 `main`
   - 配置構建設置
3. 創建 `lawsowl-beta` 專案
   - 連接同一 GitHub 倉庫
   - 設置分支為 `develop`
   - 配置構建設置
4. 記錄專案 ID 和域名

**檢查點：**
- [ ] 兩個專案都能成功構建
- [ ] 域名可以正常訪問
- [ ] 專案 ID 已記錄

#### **任務 2：創建 Render.com 服務**
**負責人：DevOps/項目負責人**
**預估時間：2 小時**

**詳細步驟：**
1. 登入 Render.com Dashboard
2. 創建 `courtdataapi-production` 服務
   - 連接 GitHub 倉庫
   - 設置分支為 `main`
   - 配置環境為 Node.js
3. 創建 `courtdataapi-beta` 服務
   - 連接同一 GitHub 倉庫
   - 設置分支為 `develop`
   - 配置環境為 Node.js
4. 記錄服務 URL 和部署 Hook

**檢查點：**
- [ ] 兩個服務都能成功部署
- [ ] API 端點可以正常訪問
- [ ] 部署 Hook 已記錄

#### **任務 3：遷移現有環境變數**
**負責人：開發者**
**預估時間：2 小時**

**詳細步驟：**
1. 從現有 Vercel 專案複製環境變數
2. 設置到兩個新專案（大部分變數相同）：
   - `lawsowl-production`：添加 `REACT_APP_ENVIRONMENT=production`
   - `lawsowl-beta`：添加 `REACT_APP_ENVIRONMENT=beta`
3. 從現有 Render.com 服務複製環境變數
4. 設置到兩個新服務（數據庫配置相同）：
   - 生產服務：添加 `IS_BETA=false`
   - 測試服務：添加 `IS_BETA=true`

**檢查點：**
- [ ] 兩版本的數據庫配置相同
- [ ] 環境標識變數正確設置
- [ ] 測試環境有額外的調試變數

### 下週執行任務

#### **任務 4：實現環境配置系統**
**負責人：前端開發者**
**預估時間：6 小時**

**詳細步驟：**
1. 創建 `src/config/environment.js`
2. 修改 `src/firebase.js` 支援環境檢測
3. 創建版本相關組件
4. 修改主應用路由支援條件載入
5. 測試環境檢測邏輯

#### **任務 5：後端環境隔離**
**負責人：後端開發者**
**預估時間：4 小時**

**詳細步驟：**
1. 修改 `config/environment.js` 添加環境檢測
2. 實現條件式路由和中間件
3. 配置環境特定的 CORS 設置
4. 測試 API 環境隔離

#### **任務 6：設置自動化部署**
**負責人：DevOps**
**預估時間：4 小時**

**詳細步驟：**
1. 創建 GitHub Actions 工作流程
2. 配置 GitHub Secrets
3. 設置分支保護規則
4. 測試自動部署流程

### 注意事項與風險提醒

#### **⚠️ 關鍵注意事項**

1. **環境變數安全**
   - 絕不在代碼中硬編碼敏感信息
   - 定期輪換 API 金鑰
   - 使用不同的 Firebase 項目確保數據隔離

2. **用戶數據保護**
   - 兩版本共享數據庫，確保數據一致性
   - 測試版的實驗功能不影響核心數據
   - 定期備份重要數據

3. **部署安全**
   - 在低峰時段進行重要部署
   - 準備快速回滾方案
   - 監控部署後的系統狀態

4. **成本控制**
   - 監控 Vercel 和 Render.com 的使用量
   - 設置適當的資源限制
   - 定期檢查不必要的服務

#### **🚨 緊急聯絡資訊**

**技術負責人**：[姓名] - [聯絡方式]
**DevOps 負責人**：[姓名] - [聯絡方式]
**項目經理**：[姓名] - [聯絡方式]

#### **📞 緊急回滾程序**

如果部署後發現嚴重問題：

1. **立即停止新部署**
2. **聯絡技術負責人**
3. **執行回滾操作**：
   ```bash
   # Vercel 回滾
   vercel --prod --rollback [previous-deployment-url]

   # Render.com 回滾
   # 通過 Dashboard 選擇之前的部署版本
   ```
4. **通知相關團隊成員**
5. **分析問題原因並制定修復計劃**

---

## 📚 相關資源

- [Vercel 官方文檔](https://vercel.com/docs)
- [Render.com 官方文檔](https://render.com/docs)
- [GitHub Actions 文檔](https://docs.github.com/en/actions)
- [Firebase 多項目管理](https://firebase.google.com/docs/projects/learn-more)

---

**文檔版本**：v1.0
**最後更新**：2024-12-22
**下次檢查**：實施完成後一週
