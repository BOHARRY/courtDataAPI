# 金額節點開發計畫

## 📅 文檔日期
2025-10-24

---

## 🔍 一、資料庫結構分析

### **1.1 Elasticsearch Mapping 分析**

根據 `mapping.txt` (Lines 706-728)，民事案件的金額數據存儲在：

```json
{
  "key_metrics": {
    "civil_metrics": {
      "claim_amount": {
        "type": "float"  // 請求金額
      },
      "granted_amount": {
        "type": "float"  // 獲准金額
      }
    }
  }
}
```

### **1.2 實際判決書範例分析**

根據 `NHEV,114,湖小,471,20250619,1.json` (Lines 113-120)：

```json
{
  "key_metrics": {
    "civil_metrics": {
      "claim_amount": 37585,      // 請求金額：37,585 元
      "granted_amount": 14503     // 獲准金額：14,503 元
    },
    "criminal_metrics": null,
    "administrative_metrics": null
  }
}
```

**關鍵發現**：
- ✅ 金額數據已經結構化存儲在 `key_metrics.civil_metrics`
- ✅ 數據類型為 `float`，單位為「元」（新台幣）
- ✅ 只有民事案件有 `civil_metrics`，刑事和行政案件為 `null`
- ✅ 獲准率 = `granted_amount / claim_amount` = 14503 / 37585 = **38.6%**

---

## 📊 二、數據流分析

### **2.1 現有數據流**

```
CasePrecedentAnalysisNodeV2 (用戶輸入)
    ↓ 調用 startCasePrecedentAnalysis()
casePrecedentAnalysisService.js
    ↓ ES kNN 搜索（使用向量相似度）
    ↓ _source 字段包含：
    ↓   - JID, JTITLE, verdict_type, court, JYEAR
    ↓   - summary_ai_full, main_reasons_ai
    ↓   - position_based_analysis
    ↓   - 各種向量字段
    ↓ ❌ 但不包含 key_metrics！
返回 casePrecedentData
    ↓ 傳遞給 FavorableAnalysisNodeV2
顯示分析結果
```

**問題發現**：
- ❌ 現有的 ES 查詢**沒有**包含 `key_metrics` 字段
- ❌ 因此無法直接獲取金額數據
- ✅ 需要修改 ES 查詢的 `_source` 參數

### **2.2 需要修改的代碼位置**

#### **位置 1**: `casePrecedentAnalysisService.js` (Lines 1385-1396)

```javascript
_source: [
    'JID', 'JTITLE', 'verdict_type', 'court', 'JYEAR', 'summary_ai_full',
    'main_reasons_ai',
    'position_based_analysis',
    'plaintiff_combined_vector',
    'defendant_combined_vector',
    'replicable_strategies_vector',
    'main_reasons_ai_vector',
    'text_embedding',
    'legal_issues_vector'
    // ❌ 缺少 key_metrics！
],
```

**需要新增**：
```javascript
_source: [
    // ... 現有字段 ...
    'key_metrics'  // 🆕 新增金額數據
],
```

#### **位置 2**: `caseDataFetcher.js` (Lines 17-29)

```javascript
_source: [
    'JID', 'JTITLE', 'court', 'verdict_type',
    'summary_ai', 'main_reasons_ai',
    'legal_issues', 'citations',
    'position_based_analysis',
    'plaintiff_combined_vector',
    'defendant_combined_vector',
    'replicable_strategies_vector',
    'main_reasons_ai_vector',
    'text_embedding',
    'legal_issues_vector'
    // ❌ 缺少 key_metrics！
]
```

**需要新增**：
```javascript
_source: [
    // ... 現有字段 ...
    'key_metrics'  // 🆕 新增金額數據
],
```

---

## 🎯 三、金額分析功能設計

### **3.1 核心統計指標**

根據律師需求，我們需要計算：

1. **中位數 (Median)**
   - 請求金額中位數
   - 獲准金額中位數
   - 獲准率中位數

2. **四分位範圍 (IQR)**
   - Q1 (25th percentile)
   - Q3 (75th percentile)
   - IQR = Q3 - Q1

3. **平均數 (Mean)**
   - 請求金額平均數
   - 獲准金額平均數
   - 平均獲准率

4. **異常值處理**
   - 使用 IQR 法則：排除 < Q1 - 1.5×IQR 或 > Q3 + 1.5×IQR 的案例
   - 或使用百分位截尾：只取 5th ~ 95th percentile

### **3.2 數據提取邏輯**

```javascript
// 從判決列表中提取金額數據
function extractAmountData(cases) {
    const amounts = [];
    
    cases.forEach(case_ => {
        // 🔧 正確的提取路徑
        const keyMetrics = case_._source?.key_metrics || case_.key_metrics;
        const civilMetrics = keyMetrics?.civil_metrics;
        
        if (civilMetrics) {
            const claimAmount = civilMetrics.claim_amount;
            const grantedAmount = civilMetrics.granted_amount;
            
            // 只保留有效數據
            if (claimAmount > 0 && grantedAmount >= 0) {
                amounts.push({
                    caseId: case_._source?.JID || case_.JID,
                    caseTitle: case_._source?.JTITLE || case_.JTITLE,
                    claimAmount: claimAmount,
                    grantedAmount: grantedAmount,
                    approvalRate: grantedAmount / claimAmount,
                    court: case_._source?.court || case_.court,
                    year: case_._source?.JYEAR || case_.JYEAR
                });
            }
        }
    });
    
    return amounts;
}
```

### **3.3 統計計算邏輯**

```javascript
// 計算統計數據
function calculateStatistics(amounts) {
    if (amounts.length === 0) {
        return null;
    }
    
    // 排序
    const sortedClaim = amounts.map(a => a.claimAmount).sort((a, b) => a - b);
    const sortedGranted = amounts.map(a => a.grantedAmount).sort((a, b) => a - b);
    const sortedRate = amounts.map(a => a.approvalRate).sort((a, b) => a - b);
    
    // 計算中位數
    const median = (arr) => {
        const mid = Math.floor(arr.length / 2);
        return arr.length % 2 === 0 
            ? (arr[mid - 1] + arr[mid]) / 2 
            : arr[mid];
    };
    
    // 計算四分位數
    const quartile = (arr, q) => {
        const pos = (arr.length - 1) * q;
        const base = Math.floor(pos);
        const rest = pos - base;
        return arr[base + 1] !== undefined
            ? arr[base] + rest * (arr[base + 1] - arr[base])
            : arr[base];
    };
    
    // 計算平均數
    const mean = (arr) => arr.reduce((sum, val) => sum + val, 0) / arr.length;
    
    return {
        totalCases: amounts.length,
        claimAmount: {
            median: median(sortedClaim),
            mean: mean(sortedClaim),
            q1: quartile(sortedClaim, 0.25),
            q3: quartile(sortedClaim, 0.75),
            min: sortedClaim[0],
            max: sortedClaim[sortedClaim.length - 1]
        },
        grantedAmount: {
            median: median(sortedGranted),
            mean: mean(sortedGranted),
            q1: quartile(sortedGranted, 0.25),
            q3: quartile(sortedGranted, 0.75),
            min: sortedGranted[0],
            max: sortedGranted[sortedGranted.length - 1]
        },
        approvalRate: {
            median: median(sortedRate),
            mean: mean(sortedRate),
            q1: quartile(sortedRate, 0.25),
            q3: quartile(sortedRate, 0.75)
        }
    };
}
```

---

## 🚀 四、實作計劃

### **階段一：後端 API 開發**

#### **Step 1: 修改 ES 查詢（必須）**

**文件**: `services/casePrecedentAnalysisService.js`

**修改位置**: Line 1385-1396

```javascript
_source: [
    'JID', 'JTITLE', 'verdict_type', 'court', 'JYEAR', 'summary_ai_full',
    'main_reasons_ai',
    'position_based_analysis',
    'plaintiff_combined_vector',
    'defendant_combined_vector',
    'replicable_strategies_vector',
    'main_reasons_ai_vector',
    'text_embedding',
    'legal_issues_vector',
    'key_metrics'  // 🆕 新增
],
```

**文件**: `services/casePrecedentAnalysis/case/caseDataFetcher.js`

**修改位置**: Line 17-29

```javascript
_source: [
    'JID', 'JTITLE', 'court', 'verdict_type',
    'summary_ai', 'main_reasons_ai',
    'legal_issues', 'citations',
    'position_based_analysis',
    'plaintiff_combined_vector',
    'defendant_combined_vector',
    'replicable_strategies_vector',
    'main_reasons_ai_vector',
    'text_embedding',
    'legal_issues_vector',
    'key_metrics'  // 🆕 新增
],
```

#### **Step 2: 創建金額分析服務**

**新文件**: `services/amountAnalysisService.js`

```javascript
// services/amountAnalysisService.js

/**
 * 金額分析服務
 * 分析民事案件中的請求金額與獲准金額關係
 */

import { extractAmountData, calculateStatistics } from './utils/amountUtils.js';
import { generateAmountInsights } from './ai/amountInsightsGenerator.js';

export async function analyzeAmountData(casePrecedentData, position) {
    // 1. 從案件列表中提取金額數據
    const amounts = extractAmountData(casePrecedentData.cases);
    
    // 2. 計算統計數據
    const statistics = calculateStatistics(amounts);
    
    // 3. 識別異常值
    const outliers = identifyOutliers(amounts, statistics);
    
    // 4. 選擇代表性案例
    const representativeCases = selectRepresentativeCases(amounts, statistics);
    
    // 5. 使用 AI 生成洞察
    const insights = await generateAmountInsights(statistics, amounts, position);
    
    return {
        statistics,
        amounts,
        outliers,
        representativeCases,
        insights
    };
}
```

---

## 📝 五、前端節點實作

### **5.1 節點內容結構（不使用 Tab）**

```
┌─────────────────────────────────────────┐
│ 💰 金額分析摘要                          │
├─────────────────────────────────────────┤
│ 📊 基於 152 件相同案由判決               │
│                                         │
│ 請求金額中位數：120 萬元                 │
│ 獲准金額中位數：80 萬元                  │
│ 平均獲准率：67%                          │
│                                         │
│ 💡 多數案件獲准金額落在 50萬～150萬 之間  │
│    (佔總案件的 68%)                      │
├─────────────────────────────────────────┤
│ 📈 金額分布圖                            │
│ [箱形圖 Boxplot]                         │
├─────────────────────────────────────────┤
│ 📚 代表性判決案例                         │
│ [高/中/低 獲准率案例]                     │
└─────────────────────────────────────────┘
```

### **5.2 數據接收邏輯**

```javascript
// AmountAnalysisNodeV2.js

const {
    isLoading = false,
    progress = 0,
    progressMessage = '',
    error = null,
    amountData = null,  // 🔧 從後端接收的金額分析數據
    timestamp = Date.now(),
    selectedPosition = 'plaintiff'
} = data;

// 解析金額數據
const statistics = amountData?.statistics || null;
const amounts = amountData?.amounts || [];
const insights = amountData?.insights || [];
const representativeCases = amountData?.representativeCases || [];
```

---

## ⚠️ 六、重要注意事項

### **6.1 時間相關功能**

❌ **不實作時間趨勢分析**
- 原因：資料庫只有三個月的判決書
- 時間趨勢分析需要至少 2-3 年的數據才有意義

### **6.2 數據量限制**

✅ **使用現有的判決列表**
- 不需要額外的 ES 查詢
- 直接從 `casePrecedentData.cases` 中提取金額數據
- 案件數量通常在 10-50 件之間

### **6.3 異常值處理**

✅ **透明化處理**
- 明確告知律師哪些案例被排除
- 提供查看異常案例的選項
- 說明排除原因（如：金額過高/過低）

---

## 🎯 七、開發優先級

### **Phase 1: MVP（最小可行產品）**
1. ✅ 修改 ES 查詢，包含 `key_metrics`
2. ✅ 創建金額提取和統計計算邏輯
3. ✅ 前端顯示核心摘要（中位數、獲准率、IQR）
4. ✅ 簡單的文字說明（AI 生成）

### **Phase 2: 增強功能**
5. ✅ 代表性案例展示（高/中/低）
6. ✅ 異常值說明
7. ✅ 可點擊案例開啟判決全文

### **Phase 3: 進階功能**
8. ✅ 箱形圖或散點圖視覺化
9. ✅ 分層分析（如：有書面契約 vs 口頭協議）
10. ✅ 互動式圖表（Hover 顯示詳細數據）

---

## 📊 八、預期數據結構

### **8.1 後端返回格式**

```javascript
{
    "amountAnalysis": {
        "statistics": {
            "totalCases": 152,
            "claimAmount": {
                "median": 1200000,
                "mean": 1500000,
                "q1": 500000,
                "q3": 1500000,
                "min": 50000,
                "max": 5000000
            },
            "grantedAmount": {
                "median": 800000,
                "mean": 950000,
                "q1": 300000,
                "q3": 1200000,
                "min": 20000,
                "max": 3000000
            },
            "approvalRate": {
                "median": 0.67,
                "mean": 0.63,
                "q1": 0.40,
                "q3": 0.85
            }
        },
        "amounts": [
            {
                "caseId": "NHEV,114,湖小,471,20250619,1",
                "caseTitle": "侵權行為損害賠償（交通）",
                "claimAmount": 37585,
                "grantedAmount": 14503,
                "approvalRate": 0.386,
                "court": "臺灣士林地方法院",
                "year": "114"
            }
            // ... more cases
        ],
        "representativeCases": {
            "high": { /* 高獲准率案例 */ },
            "medium": { /* 中位數案例 */ },
            "low": { /* 低獲准率案例 */ }
        },
        "outliers": {
            "high": [ /* 超高金額案例 */ ],
            "low": [ /* 超低金額案例 */ ]
        },
        "insights": [
            "多數案件獲准金額落在 50萬～150萬 之間，佔總案件的 68%",
            "平均獲准率為 67%，表示法院通常會准許約三分之二的請求金額"
        ]
    }
}
```

---

## 🔧 九、技術實作細節

### **9.1 金額格式化**

```javascript
// 格式化金額顯示
function formatAmount(amount) {
    if (amount >= 10000) {
        return `${(amount / 10000).toFixed(1)} 萬元`;
    }
    return `${amount.toLocaleString()} 元`;
}

// 範例：
formatAmount(1200000)  // "120.0 萬元"
formatAmount(37585)    // "37,585 元"
```

### **9.2 獲准率格式化**

```javascript
// 格式化獲准率顯示
function formatApprovalRate(rate) {
    return `${(rate * 100).toFixed(0)}%`;
}

// 範例：
formatApprovalRate(0.67)   // "67%"
formatApprovalRate(0.386)  // "39%"
```

---

## ✅ 十、總結

### **核心發現**：
1. ✅ 金額數據已經結構化存儲在 `key_metrics.civil_metrics`
2. ❌ 現有 ES 查詢沒有包含 `key_metrics`，需要修改
3. ✅ 可以直接從現有的判決列表中提取金額數據，不需要額外查詢
4. ❌ 不實作時間趨勢分析（資料庫只有三個月數據）

### **實作重點**：
1. **後端**：修改 ES 查詢 → 創建金額分析服務 → 計算統計數據
2. **前端**：垂直佈局（不用 Tab）→ 核心摘要 → 代表性案例 → 異常值說明
3. **數據流**：使用現有的 `casePrecedentData` → 提取金額 → 計算統計 → 生成洞察

### **下一步**：
1. 修改 `casePrecedentAnalysisService.js` 和 `caseDataFetcher.js`
2. 創建 `amountAnalysisService.js`
3. 實作前端金額分析節點內容展示

---

**文檔版本**: v1.0  
**作者**: Augment Agent  
**最後更新**: 2025-10-24

