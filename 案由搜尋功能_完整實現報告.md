# 案由搜尋功能 - 完整實現報告

## 📋 功能概述

案由搜尋是一個基於 AI 的智能判決書檢索系統，允許使用者輸入案件事實描述（20-500字），系統會透過四層檢索管線找出最相關的判決書，並根據使用者選擇的立場（原告/被告）進行排序。

### 核心特色

✅ **四層檢索管線** - 從關鍵字大抓到 GPT 型態檢查，層層過濾確保結果品質  
✅ **立場導向排序** - 根據原告或被告立場，優先推薦有利的判決  
✅ **智能快取機制** - Firebase 快取候選池，避免重複計算  
✅ **積分控制** - 5 積分/次，支援恢復模式防止重複扣除  
✅ **MVP 限制** - 目前僅支援民事案件，刑事/行政即將推出  

---

## 🏗️ 系統架構

### 前端架構（已完成）

**核心組件**：
- `SearchContext.js` - 狀態管理，支援三種搜索模式
- `SearchJudgement.js` - UI 組件，包含案由搜尋界面
- `semantic-search.css` - 樣式定義

**API 端點**：
```
POST /api/case-description-search
```

**請求格式**：
```json
{
  "description": "使用者輸入的案情（20-500字）",
  "caseType": "民事",
  "perspective": "plaintiff" | "defendant",
  "page": 1,
  "pageSize": 10
}
```

**Headers**：
```
Authorization: Bearer {idToken}
X-Restore-Mode: true (恢復模式時)
```

---

### 後端架構（本次實現）

#### 1️⃣ **服務層** - `caseDescriptionSearchService.js`

**主要函數**：
```javascript
performCaseDescriptionSearch(
  userCaseDescription,  // 案情描述
  lawDomain,            // 案件類型
  partySide,            // 立場
  page,                 // 頁碼
  pageSize              // 每頁數量
)
```

**四層檢索管線**：

##### **Layer 0: Query 正規化 + 關鍵詞群生成**
- 使用 GPT-4o-mini 將使用者描述改寫成法院判決書風格
- 提取四組關鍵詞：
  - `parties_terms` - 當事人關係用語
  - `technical_terms` - 技術/事實用語
  - `legal_action_terms` - 請求/義務用語
  - `statute_terms` - 相關法條

**輸出範例**：
```json
{
  "normalized_summary": "本件為租賃契約糾紛...",
  "parties_terms": ["承租人", "出租人"],
  "technical_terms": ["漏水", "押金"],
  "legal_action_terms": ["返還押金", "修繕義務"],
  "statute_terms": ["民法第767條"]
}
```

##### **Layer 1: 關鍵字大抓（ES bool query）**
- 使用 Elasticsearch `multi_match` 查詢
- 搜索欄位：`summary_ai_full`, `JFULL`, `JTITLE`, `legal_claim_basis`, `main_reasons_ai`
- 過濾條件：
  - `case_type` = 案件類型
  - `is_procedural` = false（排除程序性判決）
- 輸出：約 200 筆候選

##### **Layer 2: 語義過濾（summary_ai_vector）**
- 計算查詢向量與 `summary_ai_vector` 的 cosine similarity
- 門檻：0.70
- 輸出：約 60 筆候選

##### **Layer 3: 法條一致性過濾**
- 從 Top 10 統計核心法條（出現次數 >= 3）
- 計算每筆候選的 `law_alignment_score`：
  - 0 分：無匹配法條（移除）
  - 1 分：匹配 1 條核心法條
  - 2 分：匹配 2 條以上核心法條
- 綜合排序：`semantic_score * 0.7 + law_alignment_score * 0.3`
- 輸出：約 20-30 筆候選

##### **Layer 4: GPT Sanity Check**
- 使用 GPT-4o-mini 逐筆檢查是否為「同一類型爭議」
- Checklist 判斷：
  - 是否為相同類型的法律關係？
  - 是否包含相似的請求或主張？
  - 是否不是完全不同領域？
- 輸出：約 10-20 筆有效候選

##### **最後一步：立場排序**
- 根據 `partySide` 選擇向量欄位：
  - `plaintiff` → `plaintiff_combined_vector`
  - `defendant` → `defendant_combined_vector`
- 計算立場向量相似度
- 綜合評分：
  ```
  final_score = semantic_score * 0.4 
              + law_alignment_score * 0.3 
              + perspective_similarity * 0.3
  ```
- 輸出：Top 10 結果

---

#### 2️⃣ **快取機制** - Firebase Firestore

**快取策略**：
- **快取 Key**：`{lawDomain}_{vectorHash}`
  - `vectorHash` = 查詢向量前 10 個維度的簡化 hash
- **快取內容**：
  ```json
  {
    "relevantCases": [...],  // Layer 4 的候選池（20-30筆）
    "normalizedSummary": "...",
    "termGroups": {...},
    "createdAt": "...",
    "hitCount": 0,
    "lastAccessedAt": "..."
  }
  ```
- **快取位置**：Firestore collection `caseDescriptionSearchCache`
- **快取優勢**：
  - 避免重複執行 Layer 1-4（最耗時的部分）
  - 立場排序仍會動態計算（因為立場可能不同）

**快取命中流程**：
```
1. 生成 cacheKey
2. 查詢 Firestore
3. 如果命中 → 直接使用候選池 → 立場排序 → 返回結果
4. 如果未命中 → 執行完整管線 → 存入快取 → 返回結果
```

---

#### 3️⃣ **控制器層** - `case-description-search-controller.js`

**職責**：
- 驗證請求參數（字數、案件類型、立場）
- 調用服務層執行搜尋
- 附加積分扣除資訊
- 錯誤處理

**驗證規則**：
- 案情描述：20-500 字
- 案件類型：民事/刑事/行政
- 立場：plaintiff/defendant

---

#### 4️⃣ **路由層** - `case-description-search.js`

**路由定義**：
```javascript
POST /api/case-description-search
  ├─ verifyToken (身份驗證)
  ├─ checkAndDeductCredits(5, 'CASE_DESCRIPTION_SEARCH') (積分扣除)
  └─ performCaseDescriptionSearchController (執行搜尋)
```

**積分配置**：
- 消耗：5 積分/次
- 支援恢復模式（`X-Restore-Mode: true`）

---

## 📊 回應格式

```json
{
  "success": true,
  "results": [
    {
      "id": "TPHV,111,上,397,20250730,1",
      "title": "租賃契約糾紛",
      "court": "臺灣高等法院",
      "date": "2025-07-30",
      "caseType": "民事",
      "verdict": "原告部分勝訴",
      "summary": "本件原告主張...",
      "keyStatutes": ["民法第767條", "民法第184條"],
      "whyRelevant": "案情相似，涉及租賃契約押金返還爭議",
      "scores": {
        "semantic_score": "0.82",
        "law_alignment_score": 2,
        "final_score": "0.78"
      }
    }
  ],
  "total": 25,
  "totalPages": 3,
  "currentPage": 1,
  "enhancedQuery": "本件為租賃契約糾紛...",
  "cached": false,
  "processingTime": 3245,
  "creditsDeducted": 5,
  "userCreditsRemaining": 295
}
```

---

## 🔧 技術細節

### Elasticsearch 欄位對照

| PRD 欄位名稱 | 實際欄位名稱 | 用途 |
|------------|------------|------|
| summary_ai | summary_ai_full | 完整摘要（文字） |
| summary_ai_vector | summary_ai_vector | 摘要向量（1536維） |
| legal_basis | legal_basis | 法律依據（keyword array） |
| case_type | case_type | 案件類型 |
| is_procedural | is_procedural | 是否為程序性判決 |
| plaintiff_combined_vector | plaintiff_combined_vector | 原告綜合向量 |
| defendant_combined_vector | defendant_combined_vector | 被告綜合向量 |

### OpenAI 模型使用

| 用途 | 模型 | 溫度 | Token 限制 |
|-----|------|------|-----------|
| Layer 0 正規化 | gpt-4o-mini | 0.1 | 500 |
| Layer 4 檢查 | gpt-4o-mini | 0.1 | 100 |
| Embedding | text-embedding-3-large | - | 1536 dims |

---

## 📁 檔案清單

### 新增檔案

1. **`services/caseDescriptionSearchService.js`** (567 行)
   - 四層檢索管線實現
   - 快取機制
   - 立場排序

2. **`controllers/case-description-search-controller.js`** (65 行)
   - 請求驗證
   - 服務調用
   - 錯誤處理

3. **`routes/case-description-search.js`** (27 行)
   - 路由定義
   - 中間件配置

4. **`案由搜尋功能_完整實現報告.md`** (本文件)
   - 完整技術文檔

### 修改檔案

1. **`config/creditCosts.js`**
   - 新增 `CASE_DESCRIPTION_SEARCH: 5`
   - 新增 `CREDIT_PURPOSES.CASE_DESCRIPTION_SEARCH`

2. **`routes/index.js`**
   - 引入 `caseDescriptionSearchRoutes`
   - 掛載路由：`/api/case-description-search`

---

## ✅ 實現檢查清單

- [x] Layer 0: GPT 正規化 + 關鍵詞提取
- [x] Layer 1: Elasticsearch 關鍵字大抓
- [x] Layer 2: 語義向量過濾
- [x] Layer 3: 法條一致性過濾
- [x] Layer 4: GPT sanity check
- [x] 立場導向排序
- [x] Firebase 快取機制
- [x] 積分扣除整合
- [x] 恢復模式支援
- [x] 請求參數驗證
- [x] 錯誤處理
- [x] 路由註冊

---

## 🚀 部署步驟

### 1. 確認環境變數

確保 `.env` 包含：
```env
OPENAI_API_KEY=sk-...
OPENAI_MODEL_NAME_EMBEDDING=text-embedding-3-large
```

### 2. 重啟後端服務

```bash
cd d:\court_data\courtDataAPI
npm install  # 確保依賴完整
node index.js
```

### 3. 測試 API

```bash
curl -X POST http://localhost:3001/api/case-description-search \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ID_TOKEN" \
  -d '{
    "description": "我與房東簽訂租賃契約，約定租期兩年，但房東在租期未滿時要求我搬離，並拒絕退還押金。我認為房東違約，請求返還押金並賠償損失。",
    "caseType": "民事",
    "perspective": "plaintiff",
    "page": 1,
    "pageSize": 10
  }'
```

### 4. 前端測試

1. 切換到「案由」搜尋模式
2. 輸入案情描述（20-500字）
3. 選擇案件類型（民事）
4. 選擇立場（原告/被告）
5. 點擊「搜尋」按鈕
6. 檢查結果是否正確顯示

---

## 🎯 MVP 限制與未來擴展

### 目前限制

- ✅ 僅支援民事案件
- ✅ 刑事和行政案件標示為「即將推出」
- ✅ 字數限制：20-500字

### 未來擴展方向

1. **支援刑事案件**
   - 調整 Layer 0 prompt 適應刑事案件特性
   - 更新法條統計邏輯

2. **支援行政案件**
   - 調整 Layer 0 prompt 適應行政訴訟特性
   - 更新法條統計邏輯

3. **優化快取策略**
   - 增加 TTL 機制
   - 定期清理低命中率快取

4. **性能優化**
   - Layer 4 批次處理改為並行處理
   - 引入 Redis 加速快取查詢

5. **結果解釋**
   - 提供更詳細的「為何相關」說明
   - 視覺化法條匹配度

---

## 📝 注意事項

### 開發者須知

1. **欄位名稱**：務必使用 `mapping.txt` 中的實際欄位名稱，不要使用 PRD 中可能有誤的名稱
2. **快取設計**：快取的是候選池（20-30筆），而非最終排序結果，因為立場可能變動
3. **法條過濾**：`law_domain` 必須在 Layer 1 當成 filter，避免跨領域污染
4. **GPT 檢查**：Layer 4 使用 checklist 判斷，避免主觀語氣
5. **積分安全**：務必支援恢復模式，防止重複扣除

### 測試建議

1. **正常流程測試**：輸入有效案情，檢查結果品質
2. **快取測試**：相同查詢第二次應該更快
3. **立場測試**：切換立場，結果排序應該改變
4. **邊界測試**：19字（應拒絕）、501字（應拒絕）
5. **錯誤測試**：無效案件類型、無效立場

---

## 🎉 總結

案由搜尋功能已完整實現，包含：

✅ **完整的四層檢索管線** - 從關鍵字到 GPT 檢查  
✅ **智能快取機制** - Firebase 快取候選池  
✅ **立場導向排序** - 根據原告/被告立場優化結果  
✅ **積分控制** - 5 積分/次，支援恢復模式  
✅ **完整的錯誤處理** - 參數驗證、異常捕獲  
✅ **清晰的代碼結構** - 分層架構，易於維護  

前端已完成，後端已完成，積分配置已完成，路由已註冊。

**下一步**：部署測試 → 收集反饋 → 迭代優化 🚀

